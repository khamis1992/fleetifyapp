name: Migration-safety-agent

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  migration-safety:
    name: ðŸ”’ Migration Safety Check
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Check migration files
        run: |
          echo "## ðŸ”’ Migration Safety Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "supabase/migrations" ]; then
            MIGRATION_COUNT=$(find supabase/migrations -name "*.sql" | wc -l)
            echo "Found $MIGRATION_COUNT migration files" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Check for dangerous operations
            echo "### Dangerous Operations Check" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            DROP_COUNT=$(grep -r "DROP TABLE" supabase/migrations --include="*.sql" | wc -l)
            echo "- DROP TABLE: $DROP_COUNT occurrences" >> $GITHUB_STEP_SUMMARY

            DELETE_COUNT=$(grep -r "DELETE FROM" supabase/migrations --include="*.sql" | wc -l)
            echo "- DELETE FROM: $DELETE_COUNT occurrences" >> $GITHUB_STEP_SUMMARY

            TRUNCATE_COUNT=$(grep -r "TRUNCATE" supabase/migrations --include="*.sql" | wc -l)
            echo "- TRUNCATE: $TRUNCATE_COUNT occurrences" >> $GITHUB_STEP_SUMMARY

            # Check for safety measures
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Safety Measures Check" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            IF_EXISTS_COUNT=$(grep -r "IF EXISTS" supabase/migrations --include="*.sql" | wc -l)
            echo "- IF EXISTS guards: $IF_EXISTS_COUNT" >> $GITHUB_STEP_SUMMARY

            IF_NOT_EXISTS_COUNT=$(grep -r "IF NOT EXISTS" supabase/migrations --include="*.sql" | wc -l)
            echo "- IF NOT EXISTS guards: $IF_NOT_EXISTS_COUNT" >> $GITHUB_STEP_SUMMARY

            # Check for RLS policies
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### RLS Policy Check" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            RLS_COUNT=$(grep -r "CREATE POLICY\|ALTER TABLE.*ENABLE ROW LEVEL SECURITY" supabase/migrations --include="*.sql" | wc -l)
            echo "- RLS policies: $RLS_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No migrations directory found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“Š Summary
        run: |
          echo "## âœ… Migration Safety Check Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Migration Files | âœ… Checked |" >> $GITHUB_STEP_SUMMARY
          echo "| Safety Patterns | âœ… Verified |" >> $GITHUB_STEP_SUMMARY
