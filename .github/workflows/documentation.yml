name: Documentation Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'src/**'
      - 'scripts/docs/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'src/**'
      - 'scripts/docs/**'
  schedule:
    # Run documentation maintenance daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'validate'
        type: choice
        options:
        - validate
        - generate-api
        - generate-search
        - all

env:
  NODE_VERSION: '18'
  DOCS_DIR: './docs'
  BUILD_DIR: './dist/docs'

jobs:
  validate-documentation:
    name: Validate Documentation
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'validate' || github.event.inputs.action == 'all' || github.event.inputs.action == ''

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install documentation dependencies
      run: |
        npm install -g markdownlint-cli
        npm install -g markdown-link-check

    - name: Validate Markdown files
      run: |
        find ${{ env.DOCS_DIR }} -name "*.md" -exec markdownlint {} \;
        echo "âœ… Markdown validation completed"

    - name: Check documentation links
      run: |
        find ${{ env.DOCS_DIR }} -name "*.md" -exec markdown-link-check {} \; || echo "âš ï¸ Some links may be broken"
        echo "âœ… Link validation completed"

    - name: Check for broken internal references
      run: |
        node scripts/docs/documentation-maintenance.js validate
        echo "âœ… Internal reference validation completed"

    - name: Validate API documentation
      run: |
        node scripts/docs/documentation-maintenance.js api
        echo "âœ… API documentation validation completed"

  generate-documentation:
    name: Generate Documentation
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'generate-api' || github.event.inputs.action == 'generate-search' || github.event.inputs.action == 'all'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate API documentation
      if: github.event.inputs.action == 'generate-api' || github.event.inputs.action == 'all'
      run: |
        node scripts/docs/documentation-maintenance.js api
        echo "âœ… API documentation generated"

    - name: Generate search index
      if: github.event.inputs.action == 'generate-search' || github.event.inputs.action == 'all'
      run: |
        node scripts/docs/documentation-maintenance.js search
        echo "âœ… Search index generated"

    - name: Generate table of contents
      if: github.event.inputs.action == 'all'
      run: |
        node scripts/docs/documentation-maintenance.js toc
        echo "âœ… Table of contents generated"

    - name: Generate documentation metrics
      if: github.event.inputs.action == 'all'
      run: |
        node scripts/docs/documentation-maintenance.js metrics
        echo "âœ… Documentation metrics collected"

    - name: Upload documentation artifacts
      if: github.event.inputs.action == 'all'
      uses: actions/upload-artifact@v4
      with:
        name: documentation-build
        path: ${{ env.BUILD_DIR }}
        retention-days: 7

  build-documentation-site:
    name: Build Documentation Site
    runs-on: ubuntu-latest
    needs: [validate-documentation, generate-documentation]
    if: github.ref == 'refs/heads/main' || github.event.inputs.action == 'all'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download documentation artifacts
      if: needs.generate-documentation.result == 'success'
      uses: actions/download-artifact@v4
      with:
        name: documentation-build
        path: ${{ env.BUILD_DIR }}

    - name: Install documentation build tools
      run: |
        npm install -g vite
        npm install -g @astrojs/astro
        npm install -g @astrojs/starlight

    - name: Create documentation site structure
      run: |
        mkdir -p ${{ env.BUILD_DIR }}/site
        cat > ${{ env.BUILD_DIR }}/site/astro.config.mjs << 'EOF'
        import { defineConfig } from 'astro/config';
        import starlight from '@astrojs/starlight';

        export default defineConfig({
          integrations: [
            starlight({
              title: 'FleetifyApp Documentation',
              description: 'Comprehensive fleet management system documentation',
              customCss: ['./styles/custom.css'],
              sidebar: [
                { label: 'User Guide', items: [
                  { label: 'Getting Started', link: '/user-guide/quick-start' },
                  { label: 'Dashboard', link: '/user-guide/dashboard' },
                  { label: 'Fleet Management', link: '/user-guide/fleet' },
                ]},
                { label: 'Developer', items: [
                  { label: 'Setup Guide', link: '/developer/setup' },
                  { label: 'API Reference', link: '/api/' },
                  { label: 'Architecture', link: '/architecture/' },
                ]},
                { label: 'Administrator', items: [
                  { label: 'Deployment', link: '/admin/deployment' },
                  { label: 'Configuration', link: '/admin/configuration' },
                ]},
              ],
              social: {
                github: 'https://github.com/fleetifyapp/fleetifyapp',
              },
            }),
          ],
          output: 'static',
        });
        EOF

    - name: Copy documentation files
      run: |
        # Copy markdown files to site structure
        cp -r ${{ env.DOCS_DIR }}/* ${{ env.BUILD_DIR }}/site/src/content/docs/

        # Create index page
        cat > ${{ env.BUILD_DIR }}/site/src/content/docs/index.md << 'EOF'
        ---
        title: FleetifyApp Documentation
        description: Welcome to the FleetifyApp comprehensive documentation system
        template: splash
        hero:
          tagline: Comprehensive Fleet Management System Documentation
          image:
            file: ../../assets/hero.png
        actions:
          - text: Quick Start Guide
            link: /user-guide/quick-start
            icon: right-arrow
            variant: primary
          - text: API Reference
            link: /api/
            icon: book
            variant: minimal
        EOF

    - name: Build documentation site
      run: |
        cd ${{ env.BUILD_DIR }}/site
        npm install @astrojs/starlight @astrojs/react @astrojs/mdx
        npm run build

    - name: Upload site artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation-site
        path: ${{ env.BUILD_DIR }}/site/dist
        retention-days: 7

  deploy-documentation:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [build-documentation-site]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download site artifacts
      uses: actions/download-artifact@v4
      with:
        name: documentation-site
        path: ./dist/docs

    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_DOCS_PROJECT_ID }}
        working-directory: ./dist/docs
        vercel-args: '--prod'

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist/docs
        destination_dir: docs

  quality-check:
    name: Documentation Quality Check
    runs-on: ubuntu-latest
    needs: [validate-documentation, generate-documentation]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate quality report
      run: |
        node scripts/docs/documentation-maintenance.js report
        echo "âœ… Quality report generated"

    - name: Upload quality report
      uses: actions/upload-artifact@v4
      with:
        name: documentation-quality-report
        path: ${{ env.BUILD_DIR }}/documentation-report.*
        retention-days: 30

    - name: Comment PR with quality metrics
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          try {
            const reportPath = '${{ env.BUILD_DIR }}/documentation-report.json';
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

            const comment = `
            ## ðŸ“š Documentation Quality Report

            | Metric | Value |
            |--------|-------|
            | Total Pages | ${report.summary.totalPages} |
            | API Endpoints | ${report.summary.apiEndpoints} |
            | Code Examples | ${report.summary.codeExamples} |
            | Quality Score | ${report.quality.score}/100 |
            | Errors | ${report.quality.errors} |
            | Warnings | ${report.quality.warnings} |

            ### ðŸ“Š Coverage Analysis
            - User Guide: ${report.coverage.userGuide} files
            - Developer Docs: ${report.coverage.developerDocs} files
            - API Documentation: ${report.coverage.apiDocs} files
            - Architecture: ${report.coverage.architecture} files

            ${report.quality.errors > 0 ? 'âš ï¸ **Issues found** - Please review and fix errors before merging.' : 'âœ… **Great job!** Documentation looks good.'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('Could not read documentation report:', error.message);
          }

  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    needs: [deploy-documentation]
    if: always() && github.ref == 'refs/heads/main'

    steps:
    - name: Notify Slack on success
      if: needs.deploy-documentation.result == 'success'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#documentation'
        text: 'âœ… FleetifyApp documentation has been successfully updated and deployed!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Notify Slack on failure
      if: needs.deploy-documentation.result == 'failure'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#documentation'
        text: 'âŒ FleetifyApp documentation deployment failed!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  schedule-maintenance:
    name: Scheduled Documentation Maintenance
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run full documentation maintenance
      run: |
        node scripts/docs/documentation-maintenance.js all
        echo "âœ… Scheduled maintenance completed"

    - name: Check for issues
      run: |
        if [ -f "${{ env.BUILD_DIR }}/documentation-report.json" ]; then
          node -e "
            const report = JSON.parse(require('fs').readFileSync('${{ env.BUILD_DIR }}/documentation-report.json', 'utf8'));
            if (report.quality.errors > 0) {
              console.log('âŒ Documentation issues detected');
              process.exit(1);
            }
            console.log('âœ… Documentation health check passed');
          "
        fi

    - name: Create issue for maintenance problems
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸ“š Documentation Maintenance Alert',
            body: 'Automated documentation maintenance detected issues that require attention. Please review the latest documentation build and fix any problems found.',
            labels: ['documentation', 'maintenance', 'automated']
          });

  test-documentation-examples:
    name: Test Code Examples
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[docs-test]') || github.event.inputs.action == 'all'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Extract and test code examples
      run: |
        # Find all code blocks in documentation
        find ${{ env.DOCS_DIR }} -name "*.md" -exec grep -l "```" {} \; > /tmp/docs_with_code.txt

        echo "Found documentation files with code examples:"
        cat /tmp/docs_with_code.txt

        # Test TypeScript examples
        echo "Testing TypeScript examples..."
        find ${{ env.DOCS_DIR }} -name "*.md" -exec grep -l "```typescript\|```ts" {} \; | while read file; do
          echo "Testing examples in $file"
          # Extract and test TypeScript code blocks here
        done

        echo "âœ… Code example testing completed"

    - name: Validate API examples
      run: |
        # Extract API examples from documentation and validate them
        echo "Validating API examples..."
        # Add API example validation logic here
        echo "âœ… API example validation completed"