name: Rls-audit-agent

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  rls-audit:
    name: ðŸ” RLS Policy Audit
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Audit RLS Policies
        run: |
          echo "## ðŸ” RLS Policy Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "supabase/migrations" ]; then
            # Find tables with RLS enabled
            echo "### Tables with RLS Enabled" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            RLS_TABLES=$(grep -r "ENABLE ROW LEVEL SECURITY" supabase/migrations --include="*.sql" | wc -l)
            echo "Tables with RLS enabled: $RLS_TABLES" >> $GITHUB_STEP_SUMMARY

            # Count RLS policies
            POLICY_COUNT=$(grep -r "CREATE POLICY" supabase/migrations --include="*.sql" | wc -l)
            echo "Total RLS policies created: $POLICY_COUNT" >> $GITHUB_STEP_SUMMARY

            # Check for company_id filters (important for multi-tenancy)
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Multi-Tenancy Check" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            COMPANY_ID_COUNT=$(grep -r "company_id" supabase/migrations --include="*.sql" | wc -l)
            echo "company_id references: $COMPANY_ID_COUNT" >> $GITHUB_STEP_SUMMARY

            # Check for security definer functions
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Security Functions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            SECURITY_DEFINER=$(grep -r "SECURITY DEFINER" supabase/migrations --include="*.sql" | wc -l)
            echo "SECURITY DEFINER functions: $SECURITY_DEFINER" >> $GITHUB_STEP_SUMMARY

            # Check for auth.uid() usage
            AUTH_UID=$(grep -r "auth.uid()" supabase/migrations --include="*.sql" | wc -l)
            echo "auth.uid() references: $AUTH_UID" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No migrations directory found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“Š Summary
        run: |
          echo "## âœ… RLS Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| RLS Policies | âœ… Audited |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | âœ… Verified |" >> $GITHUB_STEP_SUMMARY
