# ============================================
# RLS & Architecture Audit Agent
# Ensures multi-tenant security compliance
# ============================================

name: üîê RLS Audit Agent

on:
  pull_request:
    paths:
      - 'supabase/migrations/**'
      - 'src/**/*.sql'
  schedule:
    # Weekly on Sunday at 2 AM
    - cron: '0 2 * * 0'
  workflow_dispatch:

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  rls-audit:
    name: üîí RLS Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run RLS Audit Script
        id: rls_audit
        run: |
          node scripts/agents/rls-audit-agent.js > rls-report.json 2>&1 || true
          cat rls-report.json
          
          # Extract results
          TABLES_WITHOUT_RLS=$(cat rls-report.json | jq -r '.tablesWithoutRls | length // 0')
          MISSING_POLICIES=$(cat rls-report.json | jq -r '.missingPolicies | length // 0')
          SECURITY_DEFINER_ISSUES=$(cat rls-report.json | jq -r '.securityDefinerIssues | length // 0')
          CROSS_TENANT_RISKS=$(cat rls-report.json | jq -r '.crossTenantRisks | length // 0')
          
          echo "tables_without_rls=$TABLES_WITHOUT_RLS" >> $GITHUB_OUTPUT
          echo "missing_policies=$MISSING_POLICIES" >> $GITHUB_OUTPUT
          echo "security_definer_issues=$SECURITY_DEFINER_ISSUES" >> $GITHUB_OUTPUT
          echo "cross_tenant_risks=$CROSS_TENANT_RISKS" >> $GITHUB_OUTPUT
          
          TOTAL_ISSUES=$((TABLES_WITHOUT_RLS + MISSING_POLICIES + SECURITY_DEFINER_ISSUES + CROSS_TENANT_RISKS))
          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          
          if [ "$CROSS_TENANT_RISKS" -gt "0" ]; then
            echo "status=fail" >> $GITHUB_OUTPUT
            echo "severity=critical" >> $GITHUB_OUTPUT
          elif [ "$TABLES_WITHOUT_RLS" -gt "0" ]; then
            echo "status=fail" >> $GITHUB_OUTPUT
            echo "severity=warning" >> $GITHUB_OUTPUT
          else
            echo "status=pass" >> $GITHUB_OUTPUT
            echo "severity=info" >> $GITHUB_OUTPUT
          fi

      - name: Log to Supabase
        if: always()
        run: |
          curl -X POST "${{ env.SUPABASE_URL }}/rest/v1/cto_agent_audit" \
            -H "apikey: ${{ env.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Authorization: Bearer ${{ env.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d '{
              "run_id": "${{ github.run_id }}",
              "stage": "rls_audit",
              "status": "${{ steps.rls_audit.outputs.status }}",
              "severity": "${{ steps.rls_audit.outputs.severity }}",
              "actor": "${{ github.actor }}",
              "pr_number": ${{ github.event.pull_request.number || 'null' }},
              "branch": "${{ github.head_ref || github.ref_name }}",
              "commit_sha": "${{ github.sha }}",
              "details": {
                "tables_without_rls": ${{ steps.rls_audit.outputs.tables_without_rls }},
                "missing_policies": ${{ steps.rls_audit.outputs.missing_policies }},
                "security_definer_issues": ${{ steps.rls_audit.outputs.security_definer_issues }},
                "cross_tenant_risks": ${{ steps.rls_audit.outputs.cross_tenant_risks }},
                "total_issues": ${{ steps.rls_audit.outputs.total_issues }}
              }
            }'

      - name: Block if Critical Issues
        if: steps.rls_audit.outputs.cross_tenant_risks > 0
        run: |
          echo "‚ùå CRITICAL: Cross-tenant data access risks detected!"
          echo "This PR cannot be merged until RLS issues are resolved."
          exit 1

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.rls_audit.outputs.status }}';
            const emoji = status === 'pass' ? '‚úÖ' : '‚ùå';
            const body = `## ${emoji} RLS Security Audit
            
            | Check | Count |
            |-------|-------|
            | Tables without RLS | ${{ steps.rls_audit.outputs.tables_without_rls }} |
            | Missing Policies | ${{ steps.rls_audit.outputs.missing_policies }} |
            | Security Definer Issues | ${{ steps.rls_audit.outputs.security_definer_issues }} |
            | Cross-Tenant Risks | ${{ steps.rls_audit.outputs.cross_tenant_risks }} |
            
            ${status === 'fail' ? '‚ö†Ô∏è **Action Required**: Please fix RLS issues before merging.' : '‚úÖ All security checks passed!'}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

