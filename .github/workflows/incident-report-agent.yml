# ============================================
# Weekly Incident Report Agent
# Aggregates logs and creates incident reports
# ============================================

name: ðŸ“Š Weekly Incident Report

on:
  schedule:
    # Every Monday at 8 AM
    - cron: '0 8 * * 1'
  workflow_dispatch:

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  generate-report:
    name: ðŸ“‹ Generate Weekly Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fetch Supabase Audit Data
        id: supabase_data
        run: |
          # Get last 7 days of audit data
          START_DATE=$(date -d "7 days ago" +%Y-%m-%dT00:00:00Z)
          
          # Fetch audit logs
          AUDIT_DATA=$(curl -s "${SUPABASE_URL}/rest/v1/cto_agent_audit?created_at=gte.${START_DATE}&order=created_at.desc" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}")
          
          # Calculate metrics
          TOTAL_RUNS=$(echo "$AUDIT_DATA" | jq 'length // 0')
          PASSED=$(echo "$AUDIT_DATA" | jq '[.[] | select(.status == "pass")] | length // 0')
          FAILED=$(echo "$AUDIT_DATA" | jq '[.[] | select(.status == "fail")] | length // 0')
          CRITICAL=$(echo "$AUDIT_DATA" | jq '[.[] | select(.severity == "critical")] | length // 0')
          
          # Get stage breakdown
          LINT_PASS=$(echo "$AUDIT_DATA" | jq '[.[] | select(.stage == "lint" and .status == "pass")] | length // 0')
          TEST_PASS=$(echo "$AUDIT_DATA" | jq '[.[] | select(.stage == "tests" and .status == "pass")] | length // 0')
          SECURITY_ISSUES=$(echo "$AUDIT_DATA" | jq '[.[] | select(.stage == "security_scan" and .status == "fail")] | length // 0')
          
          echo "total_runs=$TOTAL_RUNS" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "lint_pass=$LINT_PASS" >> $GITHUB_OUTPUT
          echo "test_pass=$TEST_PASS" >> $GITHUB_OUTPUT
          echo "security_issues=$SECURITY_ISSUES" >> $GITHUB_OUTPUT
          
          # Calculate pass rate
          if [ "$TOTAL_RUNS" -gt "0" ]; then
            PASS_RATE=$((PASSED * 100 / TOTAL_RUNS))
          else
            PASS_RATE=0
          fi
          echo "pass_rate=$PASS_RATE" >> $GITHUB_OUTPUT

      - name: Get Vercel Deployment Data
        id: vercel_data
        run: |
          # This would fetch from Vercel API if configured
          # For now, count deployments from git tags/commits
          WEEK_AGO=$(date -d "7 days ago" +%s)
          
          DEPLOY_COUNT=$(git log --since="7 days ago" --oneline | wc -l)
          
          echo "deploy_count=$DEPLOY_COUNT" >> $GITHUB_OUTPUT

      - name: Get GitHub PR Data
        id: github_data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get PR stats for the week
          WEEK_AGO=$(date -d "7 days ago" +%Y-%m-%dT00:00:00Z)
          
          # Count merged PRs
          MERGED_PRS=$(gh pr list --state merged --base main --json mergedAt --jq "[.[] | select(.mergedAt >= \"$WEEK_AGO\")] | length")
          
          # Count open PRs
          OPEN_PRS=$(gh pr list --state open --json number --jq 'length')
          
          echo "merged_prs=${MERGED_PRS:-0}" >> $GITHUB_OUTPUT
          echo "open_prs=${OPEN_PRS:-0}" >> $GITHUB_OUTPUT

      - name: Generate Report
        id: report
        run: |
          WEEK_START=$(date -d "7 days ago" +%Y-%m-%d)
          WEEK_END=$(date +%Y-%m-%d)
          REPORT_FILE="reports/week-${WEEK_END}.md"
          
          mkdir -p reports
          
          cat > "$REPORT_FILE" << EOF
          # ðŸ“Š Weekly Quality Report
          
          **Period:** ${WEEK_START} to ${WEEK_END}
          
          ---
          
          ## ðŸŽ¯ Executive Summary
          
          | Metric | Value |
          |--------|-------|
          | Total CI Runs | ${{ steps.supabase_data.outputs.total_runs }} |
          | Pass Rate | ${{ steps.supabase_data.outputs.pass_rate }}% |
          | Critical Issues | ${{ steps.supabase_data.outputs.critical }} |
          | Deployments | ${{ steps.vercel_data.outputs.deploy_count }} |
          | PRs Merged | ${{ steps.github_data.outputs.merged_prs }} |
          
          ---
          
          ## âœ… Quality Gates
          
          | Gate | Passed | Failed |
          |------|--------|--------|
          | Lint | ${{ steps.supabase_data.outputs.lint_pass }} | - |
          | Tests | ${{ steps.supabase_data.outputs.test_pass }} | - |
          | Security | - | ${{ steps.supabase_data.outputs.security_issues }} |
          
          ---
          
          ## ðŸ“ˆ Trends
          
          ### Pass Rate Over Time
          
          \`\`\`
          This Week: ${{ steps.supabase_data.outputs.pass_rate }}%
          \`\`\`
          
          ---
          
          ## ðŸš¨ Incidents
          
          ${[ "${{ steps.supabase_data.outputs.critical }}" -gt "0" ] && echo "âš ï¸ **${{ steps.supabase_data.outputs.critical }} critical issues** were detected this week." || echo "âœ… No critical incidents this week."}
          
          ---
          
          ## ðŸ“ Recommendations
          
          EOF
          
          # Add recommendations based on metrics
          if [ "${{ steps.supabase_data.outputs.pass_rate }}" -lt "80" ]; then
            echo "- ðŸ”´ **Pass rate is below 80%** - Review failing tests and fix blockers" >> "$REPORT_FILE"
          fi
          
          if [ "${{ steps.supabase_data.outputs.security_issues }}" -gt "0" ]; then
            echo "- ðŸ”´ **Security issues detected** - Run \`npm audit fix\` and review vulnerabilities" >> "$REPORT_FILE"
          fi
          
          if [ "${{ steps.github_data.outputs.open_prs }}" -gt "10" ]; then
            echo "- ðŸŸ¡ **High number of open PRs** (${{ steps.github_data.outputs.open_prs }}) - Consider reviewing and merging" >> "$REPORT_FILE"
          fi
          
          echo "" >> "$REPORT_FILE"
          echo "---" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "_Generated by CTO Agent on $(date +%Y-%m-%d)_" >> "$REPORT_FILE"
          
          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT

      - name: Commit Report
        run: |
          git config --local user.email "cto-agent@fleetify.app"
          git config --local user.name "CTO Agent"
          
          git add reports/
          
          if git diff --staged --quiet; then
            echo "No report changes to commit"
          else
            git commit -m "docs: add weekly incident report $(date +%Y-%m-%d)"
            git push
          fi

      - name: Log to Supabase
        run: |
          curl -X POST "${{ env.SUPABASE_URL }}/rest/v1/cto_agent_audit" \
            -H "apikey: ${{ env.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Authorization: Bearer ${{ env.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d '{
              "run_id": "${{ github.run_id }}",
              "stage": "weekly_report",
              "status": "pass",
              "severity": "info",
              "actor": "system",
              "branch": "main",
              "commit_sha": "${{ github.sha }}",
              "details": {
                "report_file": "${{ steps.report.outputs.report_file }}",
                "total_runs": ${{ steps.supabase_data.outputs.total_runs }},
                "pass_rate": ${{ steps.supabase_data.outputs.pass_rate }},
                "critical_issues": ${{ steps.supabase_data.outputs.critical }},
                "merged_prs": ${{ steps.github_data.outputs.merged_prs }}
              }
            }'

      - name: Create GitHub Issue for Critical Issues
        if: steps.supabase_data.outputs.critical > 0
        uses: actions/github-script@v7
        with:
          script: |
            const critical = '${{ steps.supabase_data.outputs.critical }}';
            const reportFile = '${{ steps.report.outputs.report_file }}';
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Weekly Report: ${critical} Critical Issues Detected`,
              body: `## Weekly Quality Report Alert\n\n**${critical} critical issues** were detected this week.\n\nPlease review the full report: [${reportFile}](/${reportFile})\n\n### Action Required\n- [ ] Review critical issues\n- [ ] Create fix PRs\n- [ ] Update affected documentation`,
              labels: ['critical', 'quality', 'automated']
            });

