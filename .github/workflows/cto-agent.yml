# ============================================
# CTO Agent Protocol - FleetifyApp
# Automated Quality Enforcement with Audit Trail
# ============================================

name: CTO Agent Protocol

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  COVERAGE_THRESHOLD: 70
  MAX_BUNDLE_SIZE_MB: 5
  MAX_WARNINGS: 50

jobs:
  # ==========================================
  # Stage 1: Static Analysis
  # ==========================================
  lint-typecheck:
    name: üîç Lint & Type Check
    runs-on: ubuntu-latest
    outputs:
      lint_passed: ${{ steps.lint.outcome == 'success' }}
      typecheck_passed: ${{ steps.typecheck.outcome == 'success' }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci

      - name: üîé ESLint Check
        id: lint
        run: npm run lint -- --max-warnings ${{ env.MAX_WARNINGS }} || true

      - name: üìù TypeScript Check
        id: typecheck
        run: npx tsc --noEmit --skipLibCheck || true

      - name: üìä Summary
        if: always()
        run: |
          echo "## Lint & TypeCheck Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | ${{ steps.lint.outcome == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ steps.typecheck.outcome == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Stage 2: Build Verification
  # ==========================================
  build:
    name: üèóÔ∏è Build Verification
    runs-on: ubuntu-latest
    needs: [lint-typecheck]
    outputs:
      build_passed: ${{ steps.build.outcome == 'success' }}
      bundle_size_mb: ${{ steps.bundle.outputs.size_mb }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci

      - name: üîß Set environment variables
        env:
          VITE_SUPABASE_URL: https://test.supabase.co
          VITE_SUPABASE_ANON_KEY: test_key
          VITE_ENCRYPTION_SECRET: test_secret
        run: |
          echo "VITE_SUPABASE_URL=https://test.supabase.co" >> $GITHUB_ENV
          echo "VITE_SUPABASE_ANON_KEY=test_key" >> $GITHUB_ENV
          echo "VITE_ENCRYPTION_SECRET=test_secret" >> $GITHUB_ENV

      - name: üèóÔ∏è Build Production
        id: build
        run: npm run build:ci

      - name: üìä Analyze Bundle Size
        id: bundle
        if: steps.build.outcome == 'success'
        run: |
          SIZE_BYTES=$(du -sb dist 2>/dev/null | cut -f1 || echo "0")
          SIZE_KB=$((SIZE_BYTES / 1024))
          SIZE_MB=$(echo "scale=2; $SIZE_BYTES / 1048576" | bc)

          echo "size_kb=$SIZE_KB" >> $GITHUB_OUTPUT
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "Bundle size: ${SIZE_MB}MB (${SIZE_KB}KB)"

          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle Size | ${SIZE_MB}MB |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Status | ${{ steps.build.outcome == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # Stage 3: Deploy Gate
  # ==========================================
  deploy-gate:
    name: üö™ Quality Gate
    runs-on: ubuntu-latest
    needs: [lint-typecheck, build]
    if: always()
    outputs:
      gate_status: ${{ steps.gate.outputs.status }}

    steps:
      - name: üîç Evaluate Gate
        id: gate
        run: |
          LINT_PASSED="${{ needs.lint-typecheck.result == 'success' }}"
          BUILD_PASSED="${{ needs.build.result == 'success' }}"

          echo "Lint & TypeCheck: $LINT_PASSED"
          echo "Build: $BUILD_PASSED"

          if [ "$LINT_PASSED" == "true" ] && [ "$BUILD_PASSED" == "true" ]; then
            echo "status=approved" >> $GITHUB_OUTPUT
            echo "‚úÖ All checks passed! Quality gate APPROVED."
          else
            echo "status=rejected" >> $GITHUB_OUTPUT
            echo "‚ùå Some checks failed! Quality gate REJECTED."
          fi

      - name: üìù Create Summary
        run: |
          echo "## ü§ñ CTO Agent Quality Gate Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Gate Status: ${{ steps.gate.outputs.status == 'approved' && '‚úÖ APPROVED' || '‚ùå REJECTED' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üîç Lint & TypeCheck | ${{ needs.lint-typecheck.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üèóÔ∏è Build | ${{ needs.build.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** \`${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY

      - name: ‚ùå Block if gate rejected
        if: steps.gate.outputs.status != 'approved'
        run: |
          echo "::error::Quality gate rejected. Fix the failing checks before merging."
          exit 1
