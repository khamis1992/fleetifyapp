# ============================================
# CTO Agent Protocol - FleetifyApp
# Automated Quality Enforcement with Audit Trail
# ============================================

name: CTO Agent Protocol

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  COVERAGE_THRESHOLD: 70
  MAX_BUNDLE_SIZE_MB: 2
  MAX_WARNINGS: 10

jobs:
  # ==========================================
  # Stage 1: Static Analysis
  # ==========================================
  lint-typecheck:
    name: üîç Lint & Type Check
    runs-on: ubuntu-latest
    outputs:
      lint_passed: ${{ steps.lint.outcome == 'success' }}
      typecheck_passed: ${{ steps.typecheck.outcome == 'success' }}
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci

      - name: üîé ESLint Check
        id: lint
        run: npm run lint -- --max-warnings ${{ env.MAX_WARNINGS }}
        continue-on-error: true

      - name: üìù TypeScript Check
        id: typecheck
        run: npx tsc --noEmit --skipLibCheck
        continue-on-error: true

      - name: üìä Log to Supabase
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          LINT_STATUS="${{ steps.lint.outcome == 'success' && 'pass' || 'fail' }}"
          TYPECHECK_STATUS="${{ steps.typecheck.outcome == 'success' && 'pass' || 'fail' }}"
          OVERALL_STATUS="pass"
          if [ "$LINT_STATUS" == "fail" ] || [ "$TYPECHECK_STATUS" == "fail" ]; then
            OVERALL_STATUS="fail"
          fi
          
          curl -X POST "$SUPABASE_URL/rest/v1/cto_agent_audit" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{
              \"repo\": \"${{ github.repository }}\",
              \"run_id\": \"${{ github.run_id }}\",
              \"pr_number\": ${{ github.event.pull_request.number || 'null' }},
              \"branch\": \"${{ github.head_ref || github.ref_name }}\",
              \"commit_sha\": \"${{ github.sha }}\",
              \"actor\": \"${{ github.actor }}\",
              \"stage\": \"static_analysis\",
              \"status\": \"$OVERALL_STATUS\",
              \"severity\": \"${{ steps.lint.outcome == 'failure' && 'critical' || 'info' }}\",
              \"details\": {
                \"lint_passed\": ${{ steps.lint.outcome == 'success' }},
                \"typecheck_passed\": ${{ steps.typecheck.outcome == 'success' }},
                \"max_warnings\": ${{ env.MAX_WARNINGS }}
              }
            }"

      - name: ‚ùå Fail if checks failed
        if: steps.lint.outcome == 'failure' || steps.typecheck.outcome == 'failure'
        run: |
          echo "::error::Static analysis failed!"
          echo "Lint: ${{ steps.lint.outcome }}"
          echo "TypeCheck: ${{ steps.typecheck.outcome }}"
          exit 1

  # ==========================================
  # Stage 2: Tests & Coverage
  # ==========================================
  tests:
    name: üß™ Tests & Coverage
    runs-on: ubuntu-latest
    needs: [lint-typecheck]
    outputs:
      tests_passed: ${{ steps.test.outcome == 'success' }}
      coverage_passed: ${{ steps.coverage-check.outcome == 'success' }}
      coverage_percent: ${{ steps.coverage.outputs.percent }}
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci

      - name: üß™ Run Tests
        id: test
        run: npm test -- --coverage --watchAll=false --passWithNoTests
        continue-on-error: true

      - name: üìä Extract Coverage
        id: coverage
        if: steps.test.outcome == 'success'
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(node -e "console.log(require('./coverage/coverage-summary.json').total.lines.pct)")
            echo "percent=$COVERAGE" >> $GITHUB_OUTPUT
            echo "Coverage: $COVERAGE%"
          else
            echo "percent=0" >> $GITHUB_OUTPUT
            echo "No coverage file found"
          fi

      - name: ‚úÖ Check Coverage Threshold
        id: coverage-check
        if: steps.test.outcome == 'success'
        run: |
          COVERAGE="${{ steps.coverage.outputs.percent }}"
          THRESHOLD=${{ env.COVERAGE_THRESHOLD }}
          
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::warning::Coverage $COVERAGE% is below threshold $THRESHOLD%"
            exit 1
          fi
          echo "Coverage $COVERAGE% meets threshold $THRESHOLD%"
        continue-on-error: true

      - name: üìä Log to Supabase
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          TEST_STATUS="${{ steps.test.outcome == 'success' && 'pass' || 'fail' }}"
          COVERAGE_STATUS="${{ steps.coverage-check.outcome == 'success' && 'pass' || 'fail' }}"
          OVERALL_STATUS="pass"
          if [ "$TEST_STATUS" == "fail" ]; then
            OVERALL_STATUS="fail"
          fi
          
          curl -X POST "$SUPABASE_URL/rest/v1/cto_agent_audit" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{
              \"repo\": \"${{ github.repository }}\",
              \"run_id\": \"${{ github.run_id }}\",
              \"pr_number\": ${{ github.event.pull_request.number || 'null' }},
              \"branch\": \"${{ github.head_ref || github.ref_name }}\",
              \"commit_sha\": \"${{ github.sha }}\",
              \"actor\": \"${{ github.actor }}\",
              \"stage\": \"tests\",
              \"status\": \"$OVERALL_STATUS\",
              \"severity\": \"${{ steps.test.outcome == 'failure' && 'critical' || 'info' }}\",
              \"details\": {
                \"tests_passed\": ${{ steps.test.outcome == 'success' }},
                \"coverage_passed\": ${{ steps.coverage-check.outcome == 'success' }},
                \"coverage_percent\": ${{ steps.coverage.outputs.percent || 0 }},
                \"threshold\": ${{ env.COVERAGE_THRESHOLD }}
              }
            }"

      - name: üì§ Upload Coverage Report
        if: steps.test.outcome == 'success'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          fail_ci_if_error: false

      - name: ‚ùå Fail if tests failed
        if: steps.test.outcome == 'failure'
        run: |
          echo "::error::Tests failed!"
          exit 1

  # ==========================================
  # Stage 3: Security Audit
  # ==========================================
  security:
    name: üîí Security Audit
    runs-on: ubuntu-latest
    needs: [lint-typecheck]
    outputs:
      security_passed: ${{ steps.audit.outcome == 'success' && steps.secrets.outcome == 'success' }}
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci

      - name: üîç NPM Audit
        id: audit
        run: npm audit --audit-level=high || true
        continue-on-error: true

      - name: üïµÔ∏è Secret Scan
        id: secrets
        run: |
          # Check for potential secrets in code
          PATTERNS=(
            "sk-[a-zA-Z0-9]{32,}"
            "ghp_[a-zA-Z0-9]{36}"
            "api[_-]?key.*=.*['\"][^'\"]{20,}['\"]"
          )
          
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rE "$pattern" src/ --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v "*.test." | grep -v "__mocks__"; then
              echo "::warning::Potential secret found matching pattern: $pattern"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo "::error::Potential secrets detected in source code!"
            exit 1
          fi
          echo "No secrets detected"
        continue-on-error: true

      - name: üìä Log to Supabase
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          AUDIT_STATUS="${{ steps.audit.outcome == 'success' && 'pass' || 'fail' }}"
          SECRETS_STATUS="${{ steps.secrets.outcome == 'success' && 'pass' || 'fail' }}"
          OVERALL_STATUS="pass"
          if [ "$AUDIT_STATUS" == "fail" ] || [ "$SECRETS_STATUS" == "fail" ]; then
            OVERALL_STATUS="fail"
          fi
          
          curl -X POST "$SUPABASE_URL/rest/v1/cto_agent_audit" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{
              \"repo\": \"${{ github.repository }}\",
              \"run_id\": \"${{ github.run_id }}\",
              \"pr_number\": ${{ github.event.pull_request.number || 'null' }},
              \"branch\": \"${{ github.head_ref || github.ref_name }}\",
              \"commit_sha\": \"${{ github.sha }}\",
              \"actor\": \"${{ github.actor }}\",
              \"stage\": \"security\",
              \"status\": \"$OVERALL_STATUS\",
              \"severity\": \"${{ steps.secrets.outcome == 'failure' && 'critical' || 'warning' }}\",
              \"details\": {
                \"npm_audit_passed\": ${{ steps.audit.outcome == 'success' }},
                \"secret_scan_passed\": ${{ steps.secrets.outcome == 'success' }}
              }
            }"

  # ==========================================
  # Stage 4: Build & Bundle Analysis
  # ==========================================
  build:
    name: üèóÔ∏è Build & Bundle
    runs-on: ubuntu-latest
    needs: [tests, security]
    outputs:
      build_passed: ${{ steps.build.outcome == 'success' }}
      bundle_size_kb: ${{ steps.bundle.outputs.size_kb }}
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci

      - name: üèóÔ∏è Build Production
        id: build
        run: npm run build:ci
        continue-on-error: true

      - name: üìä Analyze Bundle Size
        id: bundle
        if: steps.build.outcome == 'success'
        run: |
          SIZE_BYTES=$(du -sb dist 2>/dev/null | cut -f1 || echo "0")
          SIZE_KB=$((SIZE_BYTES / 1024))
          SIZE_MB=$(echo "scale=2; $SIZE_BYTES / 1048576" | bc)
          
          echo "size_kb=$SIZE_KB" >> $GITHUB_OUTPUT
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "Bundle size: ${SIZE_MB}MB (${SIZE_KB}KB)"
          
          MAX_SIZE_BYTES=$(echo "${{ env.MAX_BUNDLE_SIZE_MB }} * 1048576" | bc)
          if [ "$SIZE_BYTES" -gt "$MAX_SIZE_BYTES" ]; then
            echo "::warning::Bundle size ${SIZE_MB}MB exceeds limit ${{ env.MAX_BUNDLE_SIZE_MB }}MB"
          fi

      - name: üìä Log to Supabase
        if: always()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          BUILD_STATUS="${{ steps.build.outcome == 'success' && 'pass' || 'fail' }}"
          
          curl -X POST "$SUPABASE_URL/rest/v1/cto_agent_audit" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{
              \"repo\": \"${{ github.repository }}\",
              \"run_id\": \"${{ github.run_id }}\",
              \"pr_number\": ${{ github.event.pull_request.number || 'null' }},
              \"branch\": \"${{ github.head_ref || github.ref_name }}\",
              \"commit_sha\": \"${{ github.sha }}\",
              \"actor\": \"${{ github.actor }}\",
              \"stage\": \"build\",
              \"status\": \"$BUILD_STATUS\",
              \"severity\": \"${{ steps.build.outcome == 'failure' && 'critical' || 'info' }}\",
              \"metrics\": {
                \"bundle_size_kb\": ${{ steps.bundle.outputs.size_kb || 0 }},
                \"max_bundle_size_mb\": ${{ env.MAX_BUNDLE_SIZE_MB }}
              }
            }"

      - name: ‚ùå Fail if build failed
        if: steps.build.outcome == 'failure'
        run: |
          echo "::error::Build failed!"
          exit 1

  # ==========================================
  # Stage 5: Deploy Gate
  # ==========================================
  deploy-gate:
    name: üö™ Deploy Gate
    runs-on: ubuntu-latest
    needs: [lint-typecheck, tests, security, build]
    if: always()
    outputs:
      gate_status: ${{ steps.gate.outputs.status }}
    
    steps:
      - name: üîç Evaluate Gate
        id: gate
        run: |
          LINT_PASSED="${{ needs.lint-typecheck.result == 'success' }}"
          TESTS_PASSED="${{ needs.tests.result == 'success' }}"
          SECURITY_PASSED="${{ needs.security.result == 'success' }}"
          BUILD_PASSED="${{ needs.build.result == 'success' }}"
          
          echo "Lint & TypeCheck: $LINT_PASSED"
          echo "Tests: $TESTS_PASSED"
          echo "Security: $SECURITY_PASSED"
          echo "Build: $BUILD_PASSED"
          
          if [ "$LINT_PASSED" == "true" ] && [ "$TESTS_PASSED" == "true" ] && [ "$SECURITY_PASSED" == "true" ] && [ "$BUILD_PASSED" == "true" ]; then
            echo "status=approved" >> $GITHUB_OUTPUT
            echo "‚úÖ All checks passed! Deploy gate APPROVED."
          else
            echo "status=rejected" >> $GITHUB_OUTPUT
            echo "‚ùå Some checks failed! Deploy gate REJECTED."
          fi

      - name: üìä Log Deploy Gate to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Log deploy gate decision
          curl -X POST "$SUPABASE_URL/rest/v1/cto_agent_audit" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{
              \"repo\": \"${{ github.repository }}\",
              \"run_id\": \"${{ github.run_id }}\",
              \"pr_number\": ${{ github.event.pull_request.number || 'null' }},
              \"branch\": \"${{ github.head_ref || github.ref_name }}\",
              \"commit_sha\": \"${{ github.sha }}\",
              \"actor\": \"${{ github.actor }}\",
              \"stage\": \"deploy_gate\",
              \"status\": \"${{ steps.gate.outputs.status == 'approved' && 'pass' || 'fail' }}\",
              \"severity\": \"${{ steps.gate.outputs.status == 'approved' && 'info' || 'critical' }}\",
              \"details\": {
                \"gate_status\": \"${{ steps.gate.outputs.status }}\",
                \"lint_passed\": ${{ needs.lint-typecheck.result == 'success' }},
                \"tests_passed\": ${{ needs.tests.result == 'success' }},
                \"security_passed\": ${{ needs.security.result == 'success' }},
                \"build_passed\": ${{ needs.build.result == 'success' }}
              }
            }"
          
          # Log to deploy_gates table
          curl -X POST "$SUPABASE_URL/rest/v1/cto_deploy_gates" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{
              \"run_id\": \"${{ github.run_id }}\",
              \"environment\": \"${{ github.ref_name == 'main' && 'production' || 'staging' }}\",
              \"gate_status\": \"${{ steps.gate.outputs.status }}\",
              \"lint_passed\": ${{ needs.lint-typecheck.result == 'success' }},
              \"typecheck_passed\": ${{ needs.lint-typecheck.result == 'success' }},
              \"tests_passed\": ${{ needs.tests.result == 'success' }},
              \"coverage_passed\": ${{ needs.tests.result == 'success' }},
              \"security_passed\": ${{ needs.security.result == 'success' }},
              \"build_passed\": ${{ needs.build.result == 'success' }},
              \"triggered_by\": \"${{ github.actor }}\"
            }"

      - name: üìù Create Summary
        run: |
          echo "## ü§ñ CTO Agent Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Gate Status: ${{ steps.gate.outputs.status == 'approved' && '‚úÖ APPROVED' || '‚ùå REJECTED' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üîç Lint & TypeCheck | ${{ needs.lint-typecheck.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üß™ Tests | ${{ needs.tests.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üîí Security | ${{ needs.security.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üèóÔ∏è Build | ${{ needs.build.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** \`${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä [View Audit Log in Supabase](#)" >> $GITHUB_STEP_SUMMARY

      - name: ‚ùå Block if gate rejected
        if: steps.gate.outputs.status != 'approved'
        run: |
          echo "::error::Deploy gate rejected. Fix the failing checks before deploying."
          exit 1

  # ==========================================
  # Stage 6: Deploy (only on main & approved)
  # ==========================================
  deploy:
    name: üöÄ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [deploy-gate]
    if: |
      needs.deploy-gate.outputs.gate_status == 'approved' && 
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîç Verify Audit Log Exists
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Verify there's a passing deploy gate record for this run
          RESPONSE=$(curl -s "$SUPABASE_URL/rest/v1/cto_deploy_gates?run_id=eq.${{ github.run_id }}&gate_status=eq.approved" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY")
          
          if [ "$RESPONSE" == "[]" ]; then
            echo "::error::No approved deploy gate found in audit log. Blocking deploy."
            exit 1
          fi
          
          echo "‚úÖ Verified: Approved deploy gate exists in audit log"

      - name: üöÄ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

      - name: üìä Log Deployment to Supabase
        if: success()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Update deploy gate with deployment timestamp
          curl -X PATCH "$SUPABASE_URL/rest/v1/cto_deploy_gates?run_id=eq.${{ github.run_id }}" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{\"deployed_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}"
          
          # Log deployment event
          curl -X POST "$SUPABASE_URL/rest/v1/cto_agent_audit" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{
              \"repo\": \"${{ github.repository }}\",
              \"run_id\": \"${{ github.run_id }}\",
              \"branch\": \"main\",
              \"commit_sha\": \"${{ github.sha }}\",
              \"actor\": \"${{ github.actor }}\",
              \"stage\": \"deploy\",
              \"status\": \"pass\",
              \"severity\": \"info\",
              \"details\": {
                \"environment\": \"production\",
                \"deployed_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }
            }"

