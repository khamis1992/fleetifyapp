# ุฏููู ุฅุตูุงุญ ูุธุงู ุชูุจููุงุช WhatsApp
## ุชุงุฑูุฎ: 05 ูุจุฑุงูุฑ 2025

---

## ๐ด ุงููุดุงูู ุงูููุชุดูุฉ

### ุงููุดููุฉ 1: ุฅุฑุณุงู ุฑุณุงุฆู ูุชุนุฏุฏุฉ ูููุณ ุงูุนููู
**ุงููุตู**: ุฅุฐุง ูุงู ููุนููู 5 ููุงุชูุฑ ุบูุฑ ูุฏููุนุฉุ ูุชููู 5 ุฑุณุงุฆู ูููุตูุฉ (ูุงุญุฏุฉ ููู ูุงุชูุฑุฉ)

**ุงูุณุจุจ**: ุงููุธุงู ุงูุญุงูู ููุดุฆ `reminder_schedule` ูููุตู ููู ูุงุชูุฑุฉ

**ุงูุชุฃุซูุฑ**: 
- ุฅุฒุนุงุฌ ุงูุนููุงุก ุจุฑุณุงุฆู ูุชูุฑุฑุฉ
- ุงุณุชููุงู ุบูุฑ ุถุฑูุฑู ูู API Ultramsg
- ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุฆุฉ

### ุงููุดููุฉ 2: ุฌููุน ุงูุฑุณุงุฆู ุชุฐูุจ ูููุณ ุงูุฑูู (66707063)
**ุงููุตู**: ุฌููุน ุงูุฑุณุงุฆู ุชูุฑุณู ุฅูู ููุณ ุฑูู ุงููุงุชู ุจุฏูุงู ูู ุฃุฑูุงู ุงูุนููุงุก ุงููุนููุฉ

**ุงูุณุจุจ**: 
- ุฃุฎุทุงุก ูู ุฅุฏุฎุงู ุงูุจูุงูุงุช
- ุงุญุชูุงููุฉ ูุฌูุฏ ุฑูู ุงูุชุฑุงุถู ุชู ูุณุฎู ูุฌููุน ุงูุนููุงุก

**ุงูุชุฃุซูุฑ**:
- ุนุฏู ูุตูู ุงูุฑุณุงุฆู ููุนููุงุก ุงูุตุญูุญูู
- ุฅุฒุนุงุฌ ูุงูู ุงูุฑูู 66707063
- ูุดู ูุงูู ูู ูุธุงู ุงูุชูุจููุงุช

---

## โ ุงูุญููู ุงููุทุจูุฉ

### ุงูุญู 1: ูุธุงู ุชุฌููุน ุงูุฑุณุงุฆู (Message Grouping)

#### ุงูููุฑุฉ
ุจุฏูุงู ูู ุฅุฑุณุงู ุฑุณุงูุฉ ูููุตูุฉ ููู ูุงุชูุฑุฉุ ูุฑุณู ุฑุณุงูุฉ ูุงุญุฏุฉ ูุฌููุนุฉ ุชุญุชูู ุนูู ูู ููุงุชูุฑ ุงูุนููู.

#### ูุซุงู ุนูู ุงูุฑุณุงูุฉ ุงููุฌูุนุฉ
```
ูุฑุญุจุงู ุฃุญูุฏ ูุญูุฏ ๐

ุชุฐููุฑ ูุฏู: ูุฏูู 3 ููุงุชูุฑ ุณุชุณุชุญู ุฎูุงู 3 ุฃูุงู:

  โข ูุงุชูุฑุฉ INV-2025-001: 500 ุฏ.ู - ุงุณุชุญูุงู: 2025-02-08
  โข ูุงุชูุฑุฉ INV-2025-045: 750 ุฏ.ู - ุงุณุชุญูุงู: 2025-02-10
  โข ูุงุชูุฑุฉ INV-2025-089: 250 ุฏ.ู - ุงุณุชุญูุงู: 2025-02-12

๐ฐ ุฅุฌูุงูู ุงููุจูุบ ุงููุณุชุญู: 1500 ุฏ.ู

ุดูุฑุงู ูุชุนุงูููู ๐
```

#### ุงููุธุงุฆู ุงูุฌุฏูุฏุฉ

##### 1. `get_grouped_reminders_for_today()`
- **ุงูุบุฑุถ**: ุฌูุจ ุงูุชุฐููุฑุงุช ูุฌูุนุฉ ุญุณุจ ุงูุนููู ุจุฏูุงู ูู ูุงุชูุฑุฉ ูุงุชูุฑุฉ
- **ุงููุฎุฑุฌุงุช**: 
  - `customer_id`: ูุนุฑู ุงูุนููู
  - `phone_number`: ุฑูู ูุงุชู ุงูุนููู
  - `invoices_data`: JSONB ูุญุชูู ุนูู ูู ููุงุชูุฑ ุงูุนููู
  - `total_amount`: ุงููุจูุบ ุงูุฅุฌูุงูู ููู ุงูููุงุชูุฑ
  - `invoice_count`: ุนุฏุฏ ุงูููุงุชูุฑ

##### 2. `generate_grouped_reminder_message()`
- **ุงูุบุฑุถ**: ุชูููุฏ ุฑุณุงูุฉ ูุงุญุฏุฉ ูุฌูุนุฉ ุชุญุชูู ุนูู ูู ุงูููุงุชูุฑ
- **ุงูููุฒุงุช**:
  - ุชูุณูู ุชููุงุฆู ุญุณุจ ููุน ุงูุชุฐููุฑ (pre_due, due_date, overdue, escalation)
  - ูุงุฆูุฉ ููุณูุฉ ุจูู ุงูููุงุชูุฑ
  - ุฅุฌูุงูู ุงููุจูุบ
  - ุฑุณุงูุฉ ููุงุณุจุฉ ุญุณุจ ุงูุญุงูุฉ

##### 3. `queue_daily_reminders()`
- **ุงูุชุญุณููุงุช**:
  - ุฅูุบุงุก ุงูุชุฐููุฑุงุช ุงูููุฑุฑุฉ ุชููุงุฆูุงู
  - ุงูุงุญุชูุงุธ ุจุชุฐููุฑ ูุงุญุฏ ููุท ููู ุนููู/ููุน/ููู
  - ุชุญุฏูุซ ุงูุชุฐููุฑุงุช ุงูููุบุงุฉ ูุน ุณุจุจ ุงูุฅูุบุงุก

##### 4. `validate_customer_phone_numbers()`
- **ุงูุบุฑุถ**: ูุญุต ูุงูุชุญูู ูู ุตุญุฉ ุฃุฑูุงู ููุงุชู ุงูุนููุงุก
- **ุงููุญูุตุงุช**:
  - ุฃุฑูุงู ูุงุฑุบุฉ
  - ุฃุฑูุงู ููุฑุฑุฉ (ููุณ ุงูุฑูู ูุนุฏุฉ ุนููุงุก)
  - ุฃุฑูุงู ูุตูุฑุฉ ุฌุฏุงู (< 8 ุฃุฑูุงู)
  - ุฃุฑูุงู ุชุญุชูู ุนูู ุฃุญุฑู ุบูุฑ ุตุงูุญุฉ
  - ูุดู ุงูุฑูู ุงูุฅุดูุงูู 66707063

### ุงูุญู 2: ุชุญุฏูุซ Edge Function

#### ุงูุชุบููุฑุงุช ุงูุฑุฆูุณูุฉ
1. **ุงุณุชุฎุฏุงู ุงูุชุฌููุน**: ุงุณุชุฏุนุงุก `get_grouped_reminders_for_today()` ุจุฏูุงู ูู ุฌูุจ ูู reminder ูููุตู
2. **ุฑุณุงุฆู ูุฌูุนุฉ**: ุชูููุฏ ุฑุณุงูุฉ ูุงุญุฏุฉ ููู ุนููู ุชุญุชูู ุนูู ูู ููุงุชูุฑู
3. **ุชุญุฏูุซ ุฌูุงุนู**: ุชุญุฏูุซ ุญุงูุฉ ุฌููุน reminders ูู ุงููุฌููุนุฉ ุฏูุนุฉ ูุงุญุฏุฉ
4. **ุณุฌู ุชุงุฑูุฎู**: ุญูุธ ููุณ ุงูุฑุณุงูุฉ ุงููุฌูุนุฉ ููู reminder ูู ุงููุฌููุนุฉ

#### ูุซุงู ุนูู Log ุงูุฌุฏูุฏ
```
๐ค Processing 5 grouped reminders...

๐จ Processing group for ุฃุญูุฏ ูุญูุฏ (3 invoices)
๐ Generated message (245 chars)
โ Sent grouped message to ุฃุญูุฏ ูุญูุฏ (+97412345678)
   ๐ Covered 3 invoices, total: 1500

๐จ Processing group for ูุงุทูุฉ ุนูู (2 invoices)
๐ Generated message (198 chars)
โ Sent grouped message to ูุงุทูุฉ ุนูู (+97498765432)
   ๐ Covered 2 invoices, total: 850
```

---

## ๐ ุฎุทูุงุช ุงูุชุทุจูู

### ุงูุฎุทูุฉ 1: ูุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุงูุชุดุฎูุต)

```sql
-- ุชุดุบูู ุงูุณูุฑูุจุช ุงูุชุดุฎูุตู
\i fix_whatsapp_issues.sql
```

ูุฐุง ุณูุธูุฑ ูู:
1. ุนุฏุฏ ุงูุนููุงุก ุงูุฐูู ูุดุชุฑููู ูู ููุณ ุฑูู ุงููุงุชู
2. ูู ุนููู ูุฏูู ุงูุฑูู ุงูุฅุดูุงูู 66707063
3. ุนุฏุฏ ุงูุชุฐููุฑุงุช ุงูููุชุธุฑุฉ ููู ุนููู
4. ุงูุนููุงุก ุงูุฐูู ูุฏููู ููุงุชูุฑ ูุชุนุฏุฏุฉ

### ุงูุฎุทูุฉ 2: ุชุทุจูู Migration ุงูุฌุฏูุฏ

```bash
# ุชุทุจูู ุงูู Migration
npx supabase db push

# ุฃู ูุฏููุงู
psql -h your-host -U postgres -d your-database -f supabase/migrations/20250205_fix_whatsapp_reminders_grouping.sql
```

### ุงูุฎุทูุฉ 3: ุงูุชุญูู ูู ุงููุธุงุฆู ุงูุฌุฏูุฏุฉ

```sql
-- ุงุฎุชุจุงุฑ ุฏุงูุฉ ุงูุชุญูู ูู ุฃุฑูุงู ุงูููุงุชู
SELECT * FROM validate_customer_phone_numbers()
ORDER BY 
  CASE issue
    WHEN 'ุฑูู ุงููุงุชู ููุฑุฑ ุนูู ุฌููุน ุงูุนููุงุก' THEN 1
    WHEN 'ุฑูู ููุฑุฑ ูู' THEN 2
    ELSE 3
  END
LIMIT 50;

-- ุงุฎุชุจุงุฑ ุงูุชุฌููุน
SELECT 
  customer_name,
  phone_number,
  invoice_count,
  total_amount,
  reminder_type
FROM get_grouped_reminders_for_today();
```

### ุงูุฎุทูุฉ 4: ุฅุนุงุฏุฉ ูุดุฑ Edge Function

```bash
# ุฅุนุงุฏุฉ ูุดุฑ Edge Function ุงููุญุฏุซุฉ
npx supabase functions deploy send-whatsapp-reminders
```

### ุงูุฎุทูุฉ 5: ุงุฎุชุจุงุฑ ุงูุฅุฑุณุงู

#### ุงุฎุชุจุงุฑ 1: ุฑุณุงูุฉ ุชุฌุฑูุจูุฉ
ูู ูุงุฌูุฉ WhatsApp Reminders ูู ุงูุชุทุจูู:
1. ุงุฐูุจ ุฅูู `/legal/whatsapp-reminders`
2. ูู ูุณู "ุฅุฑุณุงู ุฑุณุงูุฉ ุชุฌุฑูุจูุฉ"
3. ุฃุฏุฎู ุฑูู ูุงุชูู (ุจุตูุบุฉ: 97412345678)
4. ุงูุชุจ ุฑุณุงูุฉ ุชุฌุฑูุจูุฉ
5. ุงุถุบุท "ุฅุฑุณุงู"

#### ุงุฎุชุจุงุฑ 2: ูุนุงูุฌุฉ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ
```sql
-- ุชุญุฏูุซ reminder ููุงุฎุชุจุงุฑ (ุงุฌุนูู queued)
UPDATE reminder_schedules
SET status = 'queued',
    scheduled_date = CURRENT_DATE,
    updated_at = NOW()
WHERE customer_id = 'YOUR_TEST_CUSTOMER_ID'
  AND status = 'pending'
LIMIT 3; -- ุงุฎุชุจุฑ ูุน 3 ููุงุชูุฑ

-- ุงุณุชุฏุนุงุก Edge Function
-- ูู ูุงุฌูุฉ ุงูุชุทุจูู: ุงุถุบุท "ูุนุงูุฌุฉ ุงูุชูุจููุงุช ุงูุขู"
```

### ุงูุฎุทูุฉ 6: ุฅุตูุงุญ ุฃุฑูุงู ุงูููุงุชู ุงูููุฑุฑุฉ

**โ๏ธ ูุงู ุฌุฏุงู**: ูุฐู ุงูุฎุทูุฉ ูุฌุจ ุฃู ุชุชู ูุฏููุงู ูุฃููุง ูุง ูุนุฑู ุงูุฃุฑูุงู ุงูุตุญูุญุฉ

```sql
-- 1. ุงุณุชุฎุฑุงุฌ ูุงุฆูุฉ ุจุงูุนููุงุก ุงูุฐูู ูุฏููู ุฑูู ููุฑุฑ
SELECT 
    id,
    first_name_ar,
    last_name_ar,
    phone,
    email
FROM customers
WHERE phone = '66707063'
  OR phone IN (
    SELECT phone 
    FROM customers 
    WHERE phone IS NOT NULL
    GROUP BY phone 
    HAVING COUNT(*) > 1
  )
ORDER BY first_name_ar;

-- 2. ุชุญุฏูุซ ุงูุฃุฑูุงู ุงูุตุญูุญุฉ (ูุซุงู)
-- ุงุณุชุจุฏู ุงูุจูุงูุงุช ุจุงูุฃุฑูุงู ุงูุตุญูุญุฉ
UPDATE customers
SET phone = '+97412345678',  -- ุฑูู ุงูุนููู ุงูุตุญูุญ
    updated_at = NOW()
WHERE id = 'CUSTOMER_UUID_HERE';

-- ูุฑุฑ ุงูุนูููุฉ ููู ุนููู
```

### ุงูุฎุทูุฉ 7: ุชุญุฏูุซ Reminders ุงูุญุงููุฉ

ุจุนุฏ ุชุตุญูุญ ุฃุฑูุงู ุงูููุงุชูุ ุญุฏูุซ ุงูุชุฐููุฑุงุช:

```sql
-- ุชุญุฏูุซ ุฃุฑูุงู ุงูููุงุชู ูู reminder_schedules
UPDATE reminder_schedules rs
SET phone_number = c.phone,
    updated_at = NOW()
FROM customers c
WHERE rs.customer_id = c.id
  AND rs.phone_number != c.phone
  AND c.phone IS NOT NULL
  AND rs.status IN ('pending', 'queued');
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ ุงูุดุงูู

### ุณููุงุฑูู 1: ุนููู ูุงุญุฏ ูุน ุนุฏุฉ ููุงุชูุฑ

```sql
-- ุฅูุดุงุก 3 ููุงุชูุฑ ูููุณ ุงูุนููู
-- ุชุฃูุฏ ูู ุฃู ูุฏููู due_date ูุฎุชููุฉ
INSERT INTO invoices (...)
-- ูุฑุฑ 3 ูุฑุงุช

-- ุฅูุดุงุก ุชุฐููุฑุงุช
SELECT generate_reminder_schedule_for_invoice(invoice_id)
FROM invoices 
WHERE customer_id = 'TEST_CUSTOMER_ID'
  AND payment_status = 'unpaid';

-- Queue ุงูุชุฐููุฑุงุช
SELECT queue_daily_reminders();

-- ุชุญูู ูู ุงูุชุฌููุน
SELECT * FROM get_grouped_reminders_for_today()
WHERE customer_id = 'TEST_CUSTOMER_ID';

-- ุชูููุฏ ุงูุฑุณุงูุฉ
SELECT generate_grouped_reminder_message(
  customer_name,
  invoices_data,
  total_amount,
  invoice_count,
  reminder_type,
  company_id
) FROM get_grouped_reminders_for_today()
WHERE customer_id = 'TEST_CUSTOMER_ID';
```

### ุณููุงุฑูู 2: ุนุฏุฉ ุนููุงุก ูู ูููู ูุน ููุงุชูุฑ ูุชุนุฏุฏุฉ

```sql
-- ุงุณุชุฏุนุงุก Edge Function ูุฏููุงู
-- ูู ูุงุฌูุฉ ุงูุชุทุจูู ุฃู:
curl -X POST \
  'YOUR_SUPABASE_URL/functions/v1/send-whatsapp-reminders' \
  -H 'Authorization: Bearer YOUR_ANON_KEY' \
  -H 'Content-Type: application/json'
```

---

## ๐ ููุงููุณ ุงููุฌุงุญ

### ูุจู ุงูุชุญุฏูุซ
- โ 50 ุชุฐููุฑ โ 50 ุฑุณุงูุฉ (10 ุนููุงุก ร 5 ููุงุชูุฑ ููู ุนููู)
- โ ุฌููุน ุงูุฑุณุงุฆู ุชุฐูุจ ูุฑูู ูุงุญุฏ
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุฆุฉ

### ุจุนุฏ ุงูุชุญุฏูุซ
- โ 50 ุชุฐููุฑ โ 10 ุฑุณุงุฆู (ุฑุณุงูุฉ ูุงุญุฏุฉ ูุฌูุนุฉ ููู ุนููู)
- โ ูู ุฑุณุงูุฉ ุชุฐูุจ ููุนููู ุงูุตุญูุญ
- โ ุฑุณุงุฆู ููุธูุฉ ููุงุถุญุฉ
- โ ุชูููุฑ 80% ูู ุงุณุชููุงู API
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ูุง ุชุธูุฑ ุชุฐููุฑุงุช ูุฌูุนุฉ

**ุงูุญู**:
```sql
-- ุชุญูู ูู ุญุงูุฉ ุงูุชุฐููุฑุงุช
SELECT status, COUNT(*)
FROM reminder_schedules
GROUP BY status;

-- queue ุงูุชุฐููุฑุงุช ูุฏููุงู
SELECT queue_daily_reminders();
```

### ุงููุดููุฉ: ุงูุฑุณุงุฆู ูุง ุชูุฑุณู

**ุงูุญู**:
```sql
-- ุชุญูู ูู ุฃุฎุทุงุก ุงูุฅุฑุณุงู
SELECT 
    customer_name,
    phone_number,
    last_error,
    retry_count
FROM reminder_schedules
WHERE status = 'failed'
ORDER BY updated_at DESC
LIMIT 10;

-- ุชุญูู ูู ุตุญุฉ ุฑูู ุงููุงุชู
SELECT * FROM validate_customer_phone_numbers()
WHERE issue != 'ูุง ุชูุฌุฏ ูุดุงูู';
```

### ุงููุดููุฉ: ุฑุณุงุฆู ููุฑุฑุฉ ูุงุฒุงูุช ุชูุฑุณู

**ุงูุญู**:
```sql
-- ุชุญูู ูู ุงูุชุฐููุฑุงุช ุงูููุฑุฑุฉ
SELECT 
    customer_id,
    reminder_type,
    scheduled_date,
    COUNT(*) as duplicate_count
FROM reminder_schedules
WHERE status IN ('pending', 'queued')
GROUP BY customer_id, reminder_type, scheduled_date
HAVING COUNT(*) > 1;

-- ุฅูุบุงุก ุงูููุฑุฑุงุช ูุฏููุงู
WITH duplicates AS (
    SELECT id,
           ROW_NUMBER() OVER (
               PARTITION BY customer_id, reminder_type, scheduled_date
               ORDER BY created_at ASC
           ) as rn
    FROM reminder_schedules
    WHERE status IN ('pending', 'queued')
)
UPDATE reminder_schedules
SET status = 'cancelled',
    last_error = 'Duplicate - cancelled manually',
    updated_at = NOW()
WHERE id IN (
    SELECT id FROM duplicates WHERE rn > 1
);
```

---

## ๐ ุงูุฏุนู ูุงููุณุงุนุฏุฉ

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:
1. ุฑุงุฌุน ุงูู logs ูู Supabase Edge Functions
2. ุชุญูู ูู ุฌุฏูู `reminder_history` ููุณุฌู ุงูุชูุตููู
3. ุงุณุชุฎุฏู ุฏุงูุฉ `validate_customer_phone_numbers()` ููุญุต ุงูุจูุงูุงุช
4. ุชุญูู ูู ุฅุนุฏุงุฏุงุช Ultramsg (Instance ID ู Token)

---

## โ ูุงุฆูุฉ ุงูุชุญูู ุงูููุงุฆูุฉ

- [ ] ุชุทุจูู Migration ุงูุฌุฏูุฏ
- [ ] ุฅุนุงุฏุฉ ูุดุฑ Edge Function
- [ ] ูุญุต ุฃุฑูุงู ุงูููุงุชู ุจุงุณุชุฎุฏุงู `validate_customer_phone_numbers()`
- [ ] ุฅุตูุงุญ ุงูุฃุฑูุงู ุงูููุฑุฑุฉ/ุงูุฎุงุทุฆุฉ
- [ ] ุชุญุฏูุซ reminders ุงูุญุงููุฉ
- [ ] ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุฑุณุงูุฉ ุชุฌุฑูุจูุฉ
- [ ] ุงุฎุชุจุงุฑ ุงูุชุฌููุน ูุน ุนููู ูู ููุงุชูุฑ ูุชุนุฏุฏุฉ
- [ ] ูุฑุงูุจุฉ ุงูุฅุฑุณุงู ููุฏุฉ 24 ุณุงุนุฉ
- [ ] ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุดูุงูู ูู ุงูุนููุงุก

---

**ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ**: 05 ูุจุฑุงูุฑ 2025  
**ุงูุญุงูุฉ**: ุฌุงูุฒ ููุชุทุจูู โ

