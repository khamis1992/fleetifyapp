# 📊 مخطط تدفق الربط التلقائي - دليل بصري

**للمحاسبين والمديرين الماليين**

---

## 🔄 المخطط الرئيسي

```
┌────────────────────────────────────────────────────────────────┐
│              🏢 نظام FleetifyApp المالي المتكامل              │
│                   الربط التلقائي الذكي                        │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────┴─────────────────────┐
        │                                           │
        ▼                                           ▼
┌──────────────────┐                       ┌──────────────────┐
│   📄 إنشاء        │                       │   💰 استلام       │
│     فاتورة       │                       │     دفعة         │
│   (Invoice)      │                       │   (Payment)      │
└────────┬─────────┘                       └────────┬─────────┘
         │                                           │
         │ Trigger                                   │ Trigger
         │ تلقائي                                    │ تلقائي
         ▼                                           ▼
┌──────────────────┐                       ┌──────────────────┐
│  🔧 Function:    │                       │  🔧 Function:    │
│  create_invoice  │                       │  create_payment  │
│  _journal_entry()│                       │  _journal_entry()│
└────────┬─────────┘                       └────────┬─────────┘
         │                                           │
         │                                           │
         ▼                                           ▼
┌──────────────────┐                       ┌──────────────────┐
│  ✅ قيد محاسبي   │                       │  ✅ قيد محاسبي   │
│  مدين: المدينون  │                       │  مدين: النقدية   │
│  دائن: الإيرادات │                       │  دائن: المدينون  │
│  دائن: الضرائب   │                       │      أو          │
│                  │                       │  دائن: الإيرادات │
└────────┬─────────┘                       └────────┬─────────┘
         │                                           │
         └─────────────────┬─────────────────────────┘
                           ▼
                ┌──────────────────────┐
                │   📊 دفتر الأستاذ     │
                │  محدّث تلقائياً      │
                │  متوازن دائماً       │
                └──────────────────────┘
```

---

## 📄 تدفق الفاتورة (Invoice Flow)

```
الخطوة 1: المستخدم ينشئ فاتورة
┌──────────────────────────────────────────┐
│  المستخدم                                 │
│  ├─ يدخل بيانات العميل                   │
│  ├─ يدخل بيانات الخدمة                   │
│  ├─ يدخل المبلغ والضريبة                │
│  └─ ينقر "حفظ"                          │
└──────────────────────────────────────────┘
              │
              ▼
الخطوة 2: النظام يحفظ الفاتورة
┌──────────────────────────────────────────┐
│  قاعدة البيانات (invoices)               │
│  ├─ invoice_number: INV-2025-001         │
│  ├─ total_amount: 1,050 ريال             │
│  ├─ subtotal: 1,000 ريال                 │
│  └─ tax_amount: 50 ريال                  │
└──────────────────────────────────────────┘
              │
              ▼ Trigger تلقائي
الخطوة 3: إنشاء القيد المحاسبي
┌──────────────────────────────────────────┐
│  create_invoice_journal_entry()          │
│  ┌────────────────────────────────────┐  │
│  │ 1. الحصول على الحسابات المطلوبة:  │  │
│  │    - 1201 (المدينون)              │  │
│  │    - 4101 (الإيرادات)             │  │
│  │    - 2201 (الضرائب)               │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │ 2. إنشاء رقم القيد:               │  │
│  │    INV-20251106-abc12345           │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │ 3. إنشاء رأس القيد:               │  │
│  │    - entry_number                  │  │
│  │    - entry_date                    │  │
│  │    - total_debit: 1,050            │  │
│  │    - total_credit: 1,050           │  │
│  │    - status: posted                │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │ 4. إنشاء سطور القيد:              │  │
│  │    السطر 1: مدين المدينون 1,050   │  │
│  │    السطر 2: دائن الإيرادات 1,000  │  │
│  │    السطر 3: دائن الضرائب 50       │  │
│  └────────────────────────────────────┘  │
└──────────────────────────────────────────┘
              │
              ▼
الخطوة 4: القيد محفوظ ومرحّل
┌──────────────────────────────────────────┐
│  📊 دفتر الأستاذ                         │
│  ┌────────────────────────────────────┐  │
│  │ حـ/ المدينون (1201)                │  │
│  │ ├─ مدين: +1,050 ريال               │  │
│  │ └─ الرصيد زاد بـ 1,050             │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │ حـ/ الإيرادات (4101)               │  │
│  │ ├─ دائن: +1,000 ريال               │  │
│  │ └─ الرصيد زاد بـ 1,000             │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │ حـ/ الضرائب (2201)                 │  │
│  │ ├─ دائن: +50 ريال                  │  │
│  │ └─ الرصيد زاد بـ 50                │  │
│  └────────────────────────────────────┘  │
└──────────────────────────────────────────┘
```

---

## 💰 تدفق الدفعة (Payment Flow)

```
السيناريو أ: دفعة مرتبطة بفاتورة
═════════════════════════════════════════

الخطوة 1: العميل يدفع
┌──────────────────────────────────────────┐
│  العميل: أحمد محمد                       │
│  ├─ المبلغ: 1,050 ريال نقداً            │
│  ├─ الفاتورة: INV-2025-001              │
│  └─ الطريقة: نقد                        │
└──────────────────────────────────────────┘
              │
              ▼
الخطوة 2: المستخدم يسجل الدفعة
┌──────────────────────────────────────────┐
│  قاعدة البيانات (payments)              │
│  ├─ payment_number: PAY-2025-0123        │
│  ├─ amount: 1,050 ريال                   │
│  ├─ invoice_id: [موجود]                 │
│  └─ payment_status: completed            │
└──────────────────────────────────────────┘
              │
              ▼ Trigger تلقائي
الخطوة 3: إنشاء القيد المحاسبي
┌──────────────────────────────────────────┐
│  create_payment_journal_entry()          │
│  ┌────────────────────────────────────┐  │
│  │ 1. فحص الحالة: completed ✓        │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │ 2. الحصول على الحسابات:          │  │
│  │    - 1101 (النقدية)               │  │
│  │    - 1201 (المدينون)              │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │ 3. فحص الفاتورة: موجودة ✓         │  │
│  │    => استخدم حساب المدينون         │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │ 4. إنشاء القيد:                   │  │
│  │    السطر 1: مدين النقدية 1,050    │  │
│  │    السطر 2: دائن المدينون 1,050   │  │
│  └────────────────────────────────────┘  │
└──────────────────────────────────────────┘
              │
              ▼
الخطوة 4: القيد محفوظ ومرحّل
┌──────────────────────────────────────────┐
│  📊 دفتر الأستاذ                         │
│  ┌────────────────────────────────────┐  │
│  │ حـ/ النقدية (1101)                 │  │
│  │ ├─ مدين: +1,050 ريال               │  │
│  │ └─ الرصيد زاد بـ 1,050             │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │ حـ/ المدينون (1201)                │  │
│  │ ├─ دائن: +1,050 ريال               │  │
│  │ └─ الرصيد انخفض بـ 1,050           │  │
│  │ └─ (تم التحصيل) ✓                 │  │
│  └────────────────────────────────────┘  │
└──────────────────────────────────────────┘

══════════════════════════════════════════
السيناريو ب: دفعة بدون فاتورة (إيراد مباشر)
══════════════════════════════════════════

الخطوة 1: استلام دفعة مباشرة
┌──────────────────────────────────────────┐
│  العميل يدفع مباشرة                      │
│  ├─ المبلغ: 500 ريال                    │
│  ├─ الفاتورة: [لا يوجد]                 │
│  └─ السبب: خدمة سريعة                   │
└──────────────────────────────────────────┘
              │
              ▼
الخطوة 2: تسجيل الدفعة
┌──────────────────────────────────────────┐
│  قاعدة البيانات (payments)              │
│  ├─ payment_number: PAY-2025-0124        │
│  ├─ amount: 500 ريال                     │
│  ├─ invoice_id: NULL                     │
│  └─ payment_status: completed            │
└──────────────────────────────────────────┘
              │
              ▼ Trigger تلقائي
الخطوة 3: إنشاء القيد
┌──────────────────────────────────────────┐
│  create_payment_journal_entry()          │
│  ┌────────────────────────────────────┐  │
│  │ 1. فحص الفاتورة: غير موجودة      │  │
│  │    => استخدم حساب الإيرادات        │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │ 2. إنشاء القيد:                   │  │
│  │    السطر 1: مدين النقدية 500      │  │
│  │    السطر 2: دائن الإيرادات 500    │  │
│  └────────────────────────────────────┘  │
└──────────────────────────────────────────┘
              │
              ▼
الخطوة 4: القيد محفوظ
┌──────────────────────────────────────────┐
│  📊 دفتر الأستاذ                         │
│  ┌────────────────────────────────────┐  │
│  │ حـ/ النقدية (1101)                 │  │
│  │ ├─ مدين: +500 ريال                 │  │
│  │ └─ الرصيد زاد بـ 500               │  │
│  └────────────────────────────────────┘  │
│  ┌────────────────────────────────────┐  │
│  │ حـ/ الإيرادات (4101)               │  │
│  │ ├─ دائن: +500 ريال                 │  │
│  │ └─ الرصيد زاد بـ 500               │  │
│  └────────────────────────────────────┘  │
└──────────────────────────────────────────┘
```

---

## 🔄 الدورة المحاسبية الكاملة

```
┌─────────────────────────────────────────────────────────────┐
│                    الدورة المحاسبية الكاملة                 │
│                      (مثال عملي متكامل)                      │
└─────────────────────────────────────────────────────────────┘

يوم 1: إنشاء الفاتورة
──────────────────────
  [الفاتورة: INV-001]
  المبلغ: 10,000 ريال
           │
           ▼ قيد تلقائي
  ┌─────────────────┐
  │ من حـ/ المدينون │ 10,000
  │ إلى حـ/ الإيرادات │ 10,000
  └─────────────────┘
           │
           ▼
  الأرصدة الآن:
  • المدينون: 10,000 (مدين)
  • الإيرادات: 10,000 (دائن)
  • النقدية: 0

يوم 3: استلام دفعة جزئية (50%)
──────────────────────────────────
  [الدفعة: PAY-001]
  المبلغ: 5,000 ريال
           │
           ▼ قيد تلقائي
  ┌─────────────────┐
  │ من حـ/ النقدية  │ 5,000
  │ إلى حـ/ المدينون │ 5,000
  └─────────────────┘
           │
           ▼
  الأرصدة الآن:
  • المدينون: 5,000 (مدين)
  • الإيرادات: 10,000 (دائن)
  • النقدية: 5,000 (مدين)

يوم 7: استلام الدفعة المتبقية (50%)
───────────────────────────────────────
  [الدفعة: PAY-002]
  المبلغ: 5,000 ريال
           │
           ▼ قيد تلقائي
  ┌─────────────────┐
  │ من حـ/ النقدية  │ 5,000
  │ إلى حـ/ المدينون │ 5,000
  └─────────────────┘
           │
           ▼
  الأرصدة النهائية:
  • المدينون: 0 (متوازن) ✓
  • الإيرادات: 10,000 (دائن) ✓
  • النقدية: 10,000 (مدين) ✓

═══════════════════════════════════════════
✅ المعادلة المحاسبية متوازنة:
   النقدية (10,000) = الإيرادات (10,000)
═══════════════════════════════════════════
```

---

## 🎯 مخطط القرار: أي حساب يُستخدم؟

```
                    [استلام دفعة]
                          │
                          ▼
              ┌───────────────────────┐
              │ هل الدفعة مرتبطة     │
              │ بفاتورة موجودة؟      │
              └───────────┬───────────┘
                          │
              ┌───────────┴───────────┐
              │                       │
           نعم│                       │ لا
              ▼                       ▼
    ┌──────────────────┐    ┌──────────────────┐
    │  قيد التحصيل     │    │  قيد إيراد       │
    │                  │    │  مباشر           │
    ├──────────────────┤    ├──────────────────┤
    │ مدين: النقدية   │    │ مدين: النقدية   │
    │ دائن: المدينون  │    │ دائن: الإيرادات │
    └──────────────────┘    └──────────────────┘
            │                       │
            │                       │
            └───────────┬───────────┘
                        ▼
              [القيد محفوظ ومرحّل]
```

---

## 📊 جدول مقارنة القيود

| الموقف | الحساب المدين | الحساب الدائن | الحساب الدائن 2 |
|--------|---------------|----------------|-----------------|
| **إنشاء فاتورة** | المدينون (1201) | الإيرادات (4101) | الضرائب (2201) |
| **دفعة بفاتورة** | النقدية (1101) | المدينون (1201) | - |
| **دفعة بدون فاتورة** | النقدية (1101) | الإيرادات (4101) | - |

---

## 🔍 شجرة التتبع والربط

```
                [الفاتورة: INV-2025-001]
                          │
            ┌─────────────┴─────────────┐
            │                           │
            ▼                           ▼
    [القيد: INV-20251106-xxx]   [الدفعة: PAY-2025-0123]
    • source_document_type:         │
      'invoice'                     │
    • source_document_id:           ▼
      invoice.id               [القيد: PAY-20251106-yyy]
                              • source_document_type:
                                'payment'
                              • source_document_id:
                                payment.id

                ══════════════════════════
                    الربط الكامل:
                
                الفاتورة ← القيد الأول
                الدفعة  ← القيد الثاني
                الفاتورة ← الدفعة
                ══════════════════════════
```

---

## 📈 مثال تراكمي على مدى شهر

```
الأسبوع 1: 4 فواتير، 2 دفعات
═══════════════════════════════
فاتورة 1: 5,000 ريال  →  قيد 1 (مدين: مدينون، دائن: إيرادات)
فاتورة 2: 3,000 ريال  →  قيد 2
فاتورة 3: 7,000 ريال  →  قيد 3
فاتورة 4: 2,000 ريال  →  قيد 4
دفعة 1: 5,000 ريال     →  قيد 5 (مدين: نقدية، دائن: مدينون)
دفعة 2: 3,000 ريال     →  قيد 6

الأرصدة نهاية الأسبوع 1:
• المدينون: 9,000 ريال (17,000 - 8,000)
• الإيرادات: 17,000 ريال
• النقدية: 8,000 ريال

الأسبوع 2: 5 فواتير، 6 دفعات
═══════════════════════════════
... المزيد من المعاملات ...

الأسبوع 3: 3 فواتير، 8 دفعات
═══════════════════════════════
... المزيد من المعاملات ...

الأسبوع 4: 6 فواتير، 10 دفعات
═══════════════════════════════
... المزيد من المعاملات ...

الأرصدة نهاية الشهر:
══════════════════════════════════════
• المدينون: 15,000 ريال (ما زال غير محصّل)
• الإيرادات: 250,000 ريال (إجمالي الإيرادات)
• النقدية: 235,000 ريال (ما تم تحصيله)
══════════════════════════════════════

✅ المعادلة:
   النقدية + المدينون = الإيرادات
   235,000 + 15,000 = 250,000 ✓
```

---

## 🎓 نصائح للمحاسب

### ✅ أفضل الممارسات:

1. **مراجعة يومية:**
   ```
   كل يوم → افتح دفتر الأستاذ
           → راجع القيود التلقائية
           → تأكد من توازن الحسابات
   ```

2. **مطابقة أسبوعية:**
   ```
   كل أسبوع → اطبع ميزان المراجعة
              → قارن مع سجلات البنك
              → تحقق من المدينون
   ```

3. **إغلاق شهري:**
   ```
   نهاية الشهر → اطبع جميع التقارير
                → مراجعة الإيرادات
                → إعداد القوائم المالية
   ```

### ⚠️ تجنب:

❌ تعديل القيود التلقائية يدوياً  
❌ حذف القيود المرتبطة بمستندات  
❌ تغيير أرقام الحسابات الأساسية  

### ✅ بدلاً من ذلك:

✅ إذا وجدت خطأ → عدّل الفاتورة/الدفعة الأصلية  
✅ إذا احتجت إلغاء → استخدم قيد عكسي  
✅ إذا احتجت تصحيح → أنشئ قيد تسوية  

---

**تم إعداده بواسطة:** فريق FleetifyApp  
**للاستفسارات:** support@fleetifyapp.com  
**آخر تحديث:** 6 نوفمبر 2025

