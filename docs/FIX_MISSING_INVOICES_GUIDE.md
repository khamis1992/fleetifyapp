# โ ุฅุตูุงุญ ุงูููุงุชูุฑ ุงูููููุฏุฉ ุจุนุฏ ุชุนุฏูู ุจูุงูุงุช ุงูุนููุฏ

## ๐ ุงูุชุงุฑูุฎ
2 ููููุจุฑ 2025

## ๐ ุงููุดููุฉ

ุจุนุฏ ุชุนุฏูู ุจูุงูุงุช ุงูุนููุฏ (ูุซู `start_date`, `monthly_rent`, `end_date`)ุ ุฃุตุจุญุช ุจุนุถ ุงูุนููุฏ ุงููุดุทุฉ ุจุฏูู ููุงุชูุฑ. ูุฐุง ูุญุฏุซ ูุฃู:
- ุงูููุงุชูุฑ ูุงูุช ุชู ุฅูุดุงุคูุง ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงููุฏููุฉ
- ุจุนุฏ ุงูุชุนุฏููุ ูู ูุชู ุฅุนุงุฏุฉ ุฅูุดุงุก ุงูููุงุชูุฑ ุงูููููุฏุฉ
- ุงููุธุงู ูุง ูุชุญูู ุชููุงุฆูุงู ูู ุงูููุงุชูุฑ ุงูููููุฏุฉ ุจุนุฏ ุงูุชุนุฏููุงุช

## โ ุงูุญู

ุชู ุฅูุดุงุก ูุธุงู ูุชูุงูู ูุฅุตูุงุญ ุงูููุงุชูุฑ ุงูููููุฏุฉ:

### 1. Database Functions (SQL)
### 2. React Component ูููุงุฌูุฉ
### 3. Integration ูู ุตูุญุฉ ุงูููุงุชูุฑ

## ๐ ุงููููุงุช ุงููุถุงูุฉ/ุงููุญุฏุซุฉ

### 1. Migration File (ุฌุฏูุฏ)
**ุงูููู:** `supabase/migrations/20251102000001_fix_missing_invoices_after_contract_updates.sql`

**ุงููุญุชูู:**
- โ `fix_missing_invoices_for_contracts()` - Function ูุฅุตูุงุญ ุงูููุงุชูุฑ ุงูููููุฏุฉ
- โ `check_missing_invoices_report()` - Function ูุชูุฑูุฑ ุงูููุงุชูุฑ ุงูููููุฏุฉ
- โ ูุนุงูุฌุฉ ุฐููุฉ ููุนููุฏ ุงููุญุฏุซุฉ
- โ ุงุณุชุฎุฏุงู ุจูุงูุงุช ุงูุนููุฏ ุงูุญุงููุฉ (`monthly_rent`, `monthly_amount`)

### 2. React Component (ุฌุฏูุฏ)
**ุงูููู:** `src/components/finance/FixMissingInvoices.tsx`

**ุงููููุฒุงุช:**
- โ ูุงุฌูุฉ ุณููุฉ ุงูุงุณุชุฎุฏุงู
- โ ูุญุต ุงูููุงุชูุฑ ุงูููููุฏุฉ
- โ ุฅุตูุงุญ ุชููุงุฆู
- โ ุชูุงุฑูุฑ ููุตูุฉ
- โ ุฌุฏุงูู ูุนุฑุถ ุงููุชุงุฆุฌ

### 3. Invoices Page Update (ูุญุฏุซ)
**ุงูููู:** `src/pages/finance/Invoices.tsx`

**ุงูุชุบููุฑุงุช:**
- โ Tab ุฌุฏูุฏ "ุฅุตูุงุญ ุงูููููุฏ"
- โ Integration ูุน ุงููููู ุงูุฌุฏูุฏ
- โ Lazy loading ููุฃุฏุงุก

## ๐ฏ ููู ูุนูู ุงููุธุงู

### ุงููุธููุฉ 1: `check_missing_invoices_report()`

**ุงูุบุฑุถ:** ูุญุต ุงูููุงุชูุฑ ุงูููููุฏุฉ ุฏูู ุฅูุดุงุก

**ุงููุนุงููุงุช:**
- `p_company_id` (UUID, optional): ูุนุฑู ุงูุดุฑูุฉ
- `p_contract_id` (UUID, optional): ูุนุฑู ุงูุนูุฏ ุงููุญุฏุฏ

**ุงููููุฉ ุงูููุฑุฌุนุฉ:**
```typescript
{
  contract_id: UUID,
  contract_number: string,
  customer_name: string,
  contract_start_date: DATE,
  contract_end_date: DATE | null,
  monthly_amount: NUMERIC,
  expected_invoices: INTEGER,      // ุนุฏุฏ ุงูููุงุชูุฑ ุงููุชููุนุฉ
  existing_invoices: INTEGER,      // ุนุฏุฏ ุงูููุงุชูุฑ ุงูููุฌูุฏุฉ
  missing_invoices: INTEGER,       // ุนุฏุฏ ุงูููุงุชูุฑ ุงูููููุฏุฉ
  missing_months: TEXT[]           // ูุงุฆูุฉ ุงูุฃุดูุฑ ุงูููููุฏุฉ
}
```

**ุงูุฎูุงุฑุฒููุฉ:**
1. ุฌูุจ ุฌููุน ุงูุนููุฏ ุงููุดุทุฉ
2. ุญุณุงุจ ุงููุชุฑุฉ ูู ุชุงุฑูุฎ ุงูุจุฏุก ุญุชู ุงูููู
3. ุญุณุงุจ ุนุฏุฏ ุงูููุงุชูุฑ ุงููุชููุนุฉ
4. ุญุณุงุจ ุนุฏุฏ ุงูููุงุชูุฑ ุงูููุฌูุฏุฉ
5. ุชุญุฏูุฏ ุงูููุงุชูุฑ ุงูููููุฏุฉ ูุงูุฃุดูุฑ

### ุงููุธููุฉ 2: `fix_missing_invoices_for_contracts()`

**ุงูุบุฑุถ:** ุฅูุดุงุก ุงูููุงุชูุฑ ุงูููููุฏุฉ

**ุงููุนุงููุงุช:**
- `p_company_id` (UUID, optional): ูุนุฑู ุงูุดุฑูุฉ
- `p_contract_id` (UUID, optional): ูุนุฑู ุงูุนูุฏ ุงููุญุฏุฏ
- `p_from_date` (DATE, optional): ุชุงุฑูุฎ ุงูุจุฏุงูุฉ (ุงูุชุฑุงุถู: 12 ุดูุฑ ูุถุช)
- `p_to_date` (DATE, optional): ุชุงุฑูุฎ ุงูููุงูุฉ (ุงูุชุฑุงุถู: ุงูุดูุฑ ุงููุงุฏู)

**ุงููููุฉ ุงูููุฑุฌุนุฉ:**
```typescript
{
  contract_id: UUID,
  contract_number: string,
  customer_name: string,
  invoices_created: INTEGER,       // ุนุฏุฏ ุงูููุงุชูุฑ ุงูููุดุฃุฉ
  invoices_skipped: INTEGER,       // ุนุฏุฏ ุงูููุงุชูุฑ ุงููุชุฎุทุงุฉ (ููุฌูุฏุฉ)
  total_amount: NUMERIC,           // ุฅุฌูุงูู ุงููุจูุบ
  months_covered: TEXT,            // ุงูุฃุดูุฑ ุงููุดูููุฉ
  status: TEXT,                    // 'success' | 'skipped' | 'error'
  error_message: TEXT | null
}
```

**ุงูุฎูุงุฑุฒููุฉ:**
1. ุชุญุฏูุฏ ูุทุงู ุงูุชุงุฑูุฎ (ูู/ุฅูู)
2. ุฌูุจ ุงูุนููุฏ ุงููุดุทุฉ
3. ููู ุนูุฏ:
   - ุญุณุงุจ ุงููุชุฑุฉ ุงููุนููุฉ (ูู ุชุงุฑูุฎ ุงูุจุฏุก + ุดูุฑ ุฅูู ุงูููู)
   - ููู ุดูุฑ ูู ุงููุชุฑุฉ:
     - ุงูุชุญูู ูู ูุฌูุฏ ูุงุชูุฑุฉ
     - ุฅุฐุง ูู ุชูุฌุฏ โ ุฅูุดุงุก ูุงุชูุฑุฉ ุฌุฏูุฏุฉ
     - ุฅุฐุง ููุฌุฏุช โ ุชุฎุทู
4. ุฅุฑุฌุงุน ุงููุชุงุฆุฌ

## ๐ ูุงุฌูุฉ ุงููุณุชุฎุฏู

### ุงูุชุฎุทูุท:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ ุฅุตูุงุญ ุงูููุงุชูุฑ ุงูููููุฏุฉ                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ  [๐ ูุญุต ุงูููุงุชูุฑ ุงูููููุฏุฉ]  [โ ุฅุตูุงุญ (10)]    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ  ๐ ุชูุฑูุฑ ุงูููุงุชูุฑ ุงูููููุฏุฉ                      โ
โ  โโโโโโโโโโโ  โโโโโโโโโโโ  โโโโโโโโโโโ          โ
โ  โ ๐ฅ 25   โ  โ โ๏ธ 8    โ  โ ๐ 32   โ          โ
โ  โ ุนููุฏ    โ  โ ุชุญุชุงุฌ   โ  โ ููููุฏ  โ          โ
โ  โโโโโโโโโโโ  โโโโโโโโโโโ  โโโโโโโโโโโ          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ  ุฌุฏูู ุงูุนููุฏ ูุน ุงูููุงุชูุฑ ุงูููููุฏุฉ:               โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ #2025-001 โ ุฃุญูุฏ โ 2024-01 โ 500 โ 12โ5โ7โ    โ
โ  โ #2025-002 โ ูุงุทูุฉโ 2024-03 โ 300 โ 10โ10โ0โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ุงูููููุงุช:

1. **Card Header:**
   - ุงูุนููุงู: "ุฅุตูุงุญ ุงูููุงุชูุฑ ุงูููููุฏุฉ"
   - ูุตู: ุดุฑุญ ุงููุดููุฉ ูุงูุญู

2. **ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุก:**
   - ุฒุฑ "ูุญุต ุงูููุงุชูุฑ ุงูููููุฏุฉ" (ุฃุฒุฑู)
   - ุฒุฑ "ุฅุตูุงุญ ุงูููุงุชูุฑ ุงูููููุฏุฉ" (ุฃุฒุฑู - ูุนุทู ุญุชู ุงููุญุต)

3. **Summary Cards:**
   - ุงูุนููุฏ ุงูููุญูุตุฉ
   - ุงูุนููุฏ ุงูุชู ุชุญุชุงุฌ ุฅุตูุงุญ
   - ุฅุฌูุงูู ุงูููุงุชูุฑ ุงูููููุฏุฉ

4. **Table:**
   - ุฑูู ุงูุนูุฏ
   - ุงุณู ุงูุนููู
   - ุชุงุฑูุฎ ุงูุจุฏุก
   - ุงููุจูุบ ุงูุดูุฑู
   - ุงููุชููุน / ุงูููุฌูุฏ / ุงูููููุฏ
   - ุงูุฃุดูุฑ ุงูููููุฏุฉ

5. **Results Table:**
   - ุจุนุฏ ุงูุฅุตูุงุญ
   - ุนุฏุฏ ุงูููุงุชูุฑ ุงูููุดุฃุฉ
   - ุงููุจูุบ ุงูุฅุฌูุงูู
   - ุงูุญุงูุฉ

## ๐ง ุงูุชูุงุตูู ุงููููุฉ

### ุญุณุงุจ ุงููุจูุบ ุงูุดูุฑู:

```sql
COALESCE(
  c.monthly_rent,
  c.monthly_amount,
  c.contract_amount / NULLIF(
    GREATEST(
      1,
      EXTRACT(EPOCH FROM (COALESCE(c.end_date, CURRENT_DATE) - c.start_date)) / (30 * 24 * 60 * 60)
    )::INTEGER,
    0
  ),
  0
) as monthly_amount
```

**ุงูุชุฑุชูุจ:**
1. `monthly_rent` (ุงูุฃููููุฉ)
2. `monthly_amount` (ุงูุซุงูู)
3. `contract_amount / ุนุฏุฏ ุงูุฃุดูุฑ` (ุญุณุงุจ ุชููุงุฆู)
4. `0` (ุงูุชุฑุงุถู)

### ุฅูุดุงุก ุฑูู ุงููุงุชูุฑุฉ:

```sql
'INV-' || TO_CHAR(v_current_month, 'YYYYMM') || '-' || 
LPAD((MAX(...) + 1)::TEXT, 5, '0')
```

**ุงูุตูุบุฉ:** `INV-YYYYMM-#####`
**ูุซุงู:** `INV-202411-00001`

### ุงูุชุญูู ูู ุงูููุงุชูุฑ ุงูููุฌูุฏุฉ:

```sql
SELECT EXISTS (
  SELECT 1 FROM invoices i
  WHERE i.contract_id = v_contract.id
    AND DATE_TRUNC('month', COALESCE(i.due_date, i.invoice_date))::DATE = v_current_month
    AND (i.status IS NULL OR i.status != 'cancelled')
    AND (i.payment_status != 'paid' OR i.payment_status IS NULL)
)
```

**ุงูุดุฑูุท:**
- ููุณ ุงูุนูุฏ
- ููุณ ุงูุดูุฑ (ุจูุงุกู ุนูู due_date ุฃู invoice_date)
- ุบูุฑ ููุบุงุฉ
- ุบูุฑ ูุฏููุนุฉ (ุฃู null)

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### ุงูุฎุทูุฉ 1: ุชูููุฐ Migration

```sql
-- ูู Supabase Dashboard โ SQL Editor
-- ุงูุณุฎ ูุญุชูู ุงูููู:
supabase/migrations/20251102000001_fix_missing_invoices_after_contract_updates.sql
```

### ุงูุฎุทูุฉ 2: ูู ุงููุงุฌูุฉ

1. **ุงูุชุญ ุตูุญุฉ ุงูููุงุชูุฑ:**
   ```
   Dashboard โ ุงููุงููุฉ โ ุงูููุงุชูุฑ
   ```

2. **ุงุฐูุจ ุฅูู ุชุจููุจ "ุฅุตูุงุญ ุงูููููุฏ":**
   - ุงุถุบุท ุนูู Tab ุงูุซุงูุซ "ุฅุตูุงุญ ุงูููููุฏ"

3. **ูุญุต ุงูููุงุชูุฑ ุงูููููุฏุฉ:**
   - ุงุถุบุท "ูุญุต ุงูููุงุชูุฑ ุงูููููุฏุฉ"
   - ุงูุชุธุฑ ุญุชู ููุชูู ุงููุญุต
   - ุณุชุธูุฑ ุงููุชุงุฆุฌ ูู ุงูุฌุฏูู

4. **ุฅุตูุงุญ ุงูููุงุชูุฑ ุงูููููุฏุฉ:**
   - ุจุนุฏ ุงููุญุตุ ุงุถุบุท "ุฅุตูุงุญ ุงูููุงุชูุฑ ุงูููููุฏุฉ"
   - ุณูุชู ุฅูุดุงุก ุงูููุงุชูุฑ ุงูููููุฏุฉ ุชููุงุฆูุงู
   - ุณุชุธูุฑ ุฑุณุงูุฉ ูุฌุงุญ ูุน ุงูุฅุญุตุงุฆูุงุช

### ุงูุฎุทูุฉ 3: ูู SQL ูุจุงุดุฑุฉ

```sql
-- ูุญุต ุงูููุงุชูุฑ ุงูููููุฏุฉ
SELECT * FROM check_missing_invoices_report('your-company-id');

-- ุฅุตูุงุญ ุงูููุงุชูุฑ ุงูููููุฏุฉ
SELECT * FROM fix_missing_invoices_for_contracts('your-company-id');

-- ูุนูุฏ ูุญุฏุฏ
SELECT * FROM fix_missing_invoices_for_contracts('company-id', 'contract-id');

-- ููุทุงู ุชุงุฑูุฎ ูุญุฏุฏ
SELECT * FROM fix_missing_invoices_for_contracts(
  'company-id', 
  NULL, 
  '2024-01-01',  -- from_date
  '2024-12-31'   -- to_date
);
```

## ๐ ุฃูุซูุฉ ุนูู ุงููุชุงุฆุฌ

### ุชูุฑูุฑ ุงููุญุต:

```
contract_number | customer_name | expected | existing | missing | missing_months
----------------|---------------|----------|----------|---------|---------------
#2025-001       | ุฃุญูุฏ ูุญูุฏ     | 12       | 5        | 7       | 2024-05,2024-06,...
#2025-002       | ูุงุทูุฉ ุนูู     | 10       | 10       | 0       | []
#2025-003       | ุฎุงูุฏ ุณุนูุฏ     | 8        | 3        | 5       | 2024-07,2024-08,...
```

### ูุชุงุฆุฌ ุงูุฅุตูุงุญ:

```
contract_number | customer_name | created | skipped | total_amount | status
----------------|---------------|---------|---------|--------------|--------
#2025-001       | ุฃุญูุฏ ูุญูุฏ     | 7       | 5       | 3,500.00     | success
#2025-002       | ูุงุทูุฉ ุนูู     | 0       | 10      | 0.00         | skipped
#2025-003       | ุฎุงูุฏ ุณุนูุฏ     | 5       | 3       | 2,500.00     | success
```

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ุชุนุฏูู ุงูุจูุงูุงุช:**
   - ุชุฃูุฏ ูู ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููุฏ ูุจู ุงูุฅุตูุงุญ
   - ุงููุธุงู ูุณุชุฎุฏู ุงูุจูุงูุงุช ุงูุญุงููุฉ ููุท

2. **ุงูุฃุฏุงุก:**
   - ูุฏ ูุณุชุบุฑู ุจุนุถ ุงูููุช ููุนููุฏ ุงููุซูุฑุฉ
   - ูุชู ุชุนุทูู triggers ูุคูุชุงู ูุชุณุฑูุน ุงูุนูููุฉ

3. **ุงูููุงุชูุฑ ุงูููุฌูุฏุฉ:**
   - ูู ูุชู ุฅุนุงุฏุฉ ุฅูุดุงุก ุงูููุงุชูุฑ ุงูููุฌูุฏุฉ
   - ูู ูุชู ุชุนุฏูู ุงูููุงุชูุฑ ุงูููุฌูุฏุฉ

4. **ุงูููุงุชูุฑ ุงููุฏููุนุฉ:**
   - ูุชู ุชุฎุทู ุงูููุงุชูุฑ ุงููุฏููุนุฉ
   - ูุชู ุฅูุดุงุก ููุท ุงูููุงุชูุฑ ุงูููููุฏุฉ

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: "ูุง ุชูุฌุฏ ููุงุชูุฑ ููููุฏุฉ"
**ุงูุญู:** 
- ุชุฃูุฏ ูู ุฃู ุจูุงูุงุช ุงูุนููุฏ ูุญุฏุซุฉ
- ุชุญูู ูู ูุทุงู ุงูุชุงุฑูุฎ

### ุงููุดููุฉ: "ุฎุทุฃ ูู ุญุณุงุจ ุงููุจูุบ"
**ุงูุญู:**
- ุชุฃูุฏ ูู ูุฌูุฏ `monthly_rent` ุฃู `monthly_amount`
- ุชุญูู ูู ุตุญุฉ `start_date` ู `end_date`

### ุงููุดููุฉ: "ูุดู ุฅูุดุงุก ุงููุงุชูุฑุฉ"
**ุงูุญู:**
- ุชุญูู ูู ูุฌูุฏ `customer_id` ุตุญูุญ
- ุชุฃูุฏ ูู ูุฌูุฏ `company_id` ุตุญูุญ
- ุฑุงุฌุน logs ููุฃุฎุทุงุก ุงูุชูุตูููุฉ

## ๐ ุงูุชุญุณููุงุช

### ูุจู:
- โ ูุง ููุฌุฏ ุทุฑููุฉ ููุชุญูู ูู ุงูููุงุชูุฑ ุงูููููุฏุฉ
- โ ูุง ููุฌุฏ ุทุฑููุฉ ูุฅุตูุงุญ ุงูููุงุชูุฑ ุงูููููุฏุฉ
- โ ุจุนุฏ ุชุนุฏูู ุงูุนููุฏุ ูุฌุจ ุฅูุดุงุก ุงูููุงุชูุฑ ูุฏููุงู

### ุจุนุฏ:
- โ ูุญุต ุชููุงุฆู ููููุงุชูุฑ ุงูููููุฏุฉ
- โ ุฅุตูุงุญ ุชููุงุฆู ุจุถุบุทุฉ ูุงุญุฏุฉ
- โ ุชูุงุฑูุฑ ููุตูุฉ
- โ ุงุณุชุฎุฏุงู ุจูุงูุงุช ุงูุนููุฏ ุงููุญุฏุซุฉ
- โ ูุนุงูุฌุฉ ุฐููุฉ ููุญุงูุงุช ุงููุฎุชููุฉ
- โ ูุงุฌูุฉ ุณููุฉ ุงูุงุณุชุฎุฏุงู

## โ ุงูุฎูุงุตุฉ

ุชู ุจูุฌุงุญ:
1. โ ุฅูุดุงุก `fix_missing_invoices_for_contracts()` function
2. โ ุฅูุดุงุก `check_missing_invoices_report()` function
3. โ ุฅูุดุงุก `FixMissingInvoices` component
4. โ ุฅุถุงูุฉ Tab ุฌุฏูุฏ ูู ุตูุญุฉ ุงูููุงุชูุฑ
5. โ ูุนุงูุฌุฉ ุฐููุฉ ูุจูุงูุงุช ุงูุนููุฏ
6. โ ุชูุงุฑูุฑ ููุตูุฉ
7. โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก linter

---

**ุชู ุงูุชูููุฐ ุจูุงุณุทุฉ:** AI Assistant  
**ุงูุชุงุฑูุฎ:** 2 ููููุจุฑ 2025  
**ุงูุญุงูุฉ:** โ ููุชูู ูููุฎุชุจุฑ

