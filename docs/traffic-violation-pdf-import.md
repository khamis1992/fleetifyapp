# نظام استيراد المخالفات المرورية من PDF

## 📋 نظرة عامة

نظام شامل لاستيراد ومعالجة ملفات PDF للمخالفات المرورية، مع استخراج البيانات تلقائياً وربطها بالمركبات المسجلة في النظام.

## 🎯 الميزات الرئيسية

### 1. رفع الملفات
- **السحب والإفلات:** واجهة سهلة لرفع ملفات PDF
- **دعم متعدد الملفات:** إمكانية رفع عدة ملفات في نفس الوقت
- **التحقق من النوع:** قبول ملفات PDF فقط
- **معاينة الملفات:** عرض تفاصيل الملفات المرفوعة

### 2. معالجة البيانات
- **استخراج تلقائي:** استخراج البيانات من PDF باستخدام تقنيات متقدمة
- **ربط ذكي:** ربط المخالفات بالمركبات تلقائياً
- **كشف الأخطاء:** تحديد المخالفات غير المطابقة
- **معالجة مجمعة:** معالجة عدة ملفات في عملية واحدة

### 3. مراجعة وحفظ
- **جدول تفاعلي:** عرض جميع المخالفات المستخرجة
- **تحديد انتقائي:** اختيار المخالفات المراد حفظها
- **حفظ آمن:** حفظ البيانات في قاعدة البيانات مع التحقق

### 4. إحصائيات وتقارير
- **إحصائيات شاملة:** تحليل مفصل للبيانات المستوردة
- **تقارير متقدمة:** تصدير التقارير بصيغ مختلفة
- **رسوم بيانية:** عرض بصري للإحصائيات

## 🏗️ بنية النظام

### المكونات الرئيسية

#### 1. `TrafficViolationPDFImport.tsx`
**الوظيفة:** المكون الرئيسي لاستيراد PDF

**الميزات:**
- واجهة تابات متعددة المراحل
- رفع وإدارة الملفات
- معالجة البيانات
- مراجعة النتائج

```typescript
interface ExtractedViolation {
  id: string;
  violationNumber: string;    // رقم المخالفة
  date: string;              // تاريخ المخالفة
  time?: string;             // وقت المخالفة
  plateNumber: string;       // رقم اللوحة
  location: string;          // موقع المخالفة
  authority: string;         // الجهة المصدرة
  fineAmount: number;        // مبلغ الغرامة
  points: number;            // النقاط
  violationType: string;     // نوع المخالفة
  status: 'extracted' | 'matched' | 'error';
  vehicleId?: string;        // معرف المركبة المربوطة
  errors: string[];          // قائمة الأخطاء
}
```

#### 2. `PDFViewer.tsx`
**الوظيفة:** معاينة ملفات PDF

**الميزات:**
- عرض محتوى PDF
- أدوات التحكم (تكبير، تصغير، دوران)
- تحميل الملف
- عرض معلومات الملف

#### 3. `TrafficViolationStats.tsx`
**الوظيفة:** عرض الإحصائيات المتقدمة

**الميزات:**
- إحصائيات أساسية (العدد، النجاح، الفشل)
- أكثر أنواع المخالفات تكراراً
- أكثر المواقع للمخالفات
- توزيع الغرامات حسب الفئات

#### 4. `ViolationImportReport.tsx`
**الوظيفة:** إنشاء وتصدير التقارير

**الميزات:**
- ملخص نتائج الاستيراد
- تصدير بصيغ متعددة (TXT, CSV, Excel, PDF)
- معدل نجاح الاستيراد
- ملاحظات وتوصيات

## 📊 البيانات المستخرجة

### من الصورة المرسلة:
```json
{
  "violations": [
    {
      "violationNumber": "3301762892",
      "date": "2025-08-07",
      "time": "18:06", 
      "plateNumber": "008/يونيو/058",
      "location": "منطقة 91 الشارع 490",
      "authority": "تجاوز الحد الأقصى للسرعة (المادة 53)",
      "fineAmount": 500.0,
      "points": 0,
      "violationType": "تجاوز السرعة"
    }
  ]
}
```

## 🔧 التكامل مع النظام

### إضافة إلى صفحة المخالفات
```typescript
// في src/pages/fleet/TrafficViolations.tsx
import { TrafficViolationPDFImport } from '@/components/fleet/TrafficViolationPDFImport';

<Tabs defaultValue="list">
  <TabsList>
    <TabsTrigger value="list">قائمة المخالفات</TabsTrigger>
    <TabsTrigger value="import">استيراد PDF</TabsTrigger>
  </TabsList>
  
  <TabsContent value="import">
    <TrafficViolationPDFImport />
  </TabsContent>
</Tabs>
```

### ربط بقاعدة البيانات
```typescript
// حفظ المخالفة في قاعدة البيانات
const { error } = await supabase
  .from('traffic_violations')
  .insert({
    company_id: companyId,
    vehicle_id: violation.vehicleId,
    violation_number: violation.violationNumber,
    violation_date: violation.date,
    violation_time: violation.time,
    violation_type: violation.violationType,
    violation_description: violation.authority,
    location: violation.location,
    fine_amount: violation.fineAmount,
    total_amount: violation.fineAmount,
    issuing_authority: violation.authority,
    status: 'pending'
  });
```

## 🚀 خطوات الاستخدام

### 1. الوصول إلى النظام
1. انتقل إلى **الأسطول** > **المخالفات المرورية**
2. اختر تاب **"استيراد PDF"**

### 2. رفع الملفات
1. اسحب ملفات PDF إلى منطقة الرفع أو اضغط للاختيار
2. تأكد من رفع الملفات الصحيحة
3. استخدم زر المعاينة لفحص محتوى الملفات

### 3. معالجة البيانات
1. اضغط **"بدء المعالجة"**
2. انتظر حتى اكتمال استخراج البيانات
3. راجع النتائج والإحصائيات

### 4. مراجعة وحفظ
1. راجع المخالفات المستخرجة في الجدول
2. حدد المخالفات المراد حفظها
3. اضغط **"حفظ المخالفات المحددة"**

### 5. عرض الإحصائيات والتقارير
1. انتقل إلى تاب **"الإحصائيات"**
2. راجع التحليلات المفصلة
3. صدّر التقارير بالصيغة المطلوبة

## 📈 الإحصائيات المتاحة

### الإحصائيات الأساسية
- إجمالي المخالفات المستخرجة
- عدد المخالفات المطابقة للمركبات
- عدد الأخطاء والمخالفات غير المطابقة
- إجمالي مبلغ الغرامات

### التحليلات المتقدمة
- أكثر أنواع المخالفات تكراراً
- أكثر المواقع للمخالفات
- توزيع الغرامات حسب الفئات
- معدل نجاح الاستيراد

### التقارير
- تقرير نصي مفصل (.txt)
- ملف بيانات منظم (.csv)
- جدول بيانات Excel (.xlsx)
- تقرير PDF منسق (.pdf)

## 🔍 معالجة الأخطاء

### أنواع الأخطاء الشائعة
1. **عدم مطابقة رقم اللوحة:** لم يتم العثور على مركبة مطابقة
2. **بيانات ناقصة:** نقص في البيانات المستخرجة
3. **تنسيق خاطئ:** تنسيق غير متوقع في PDF
4. **ملف تالف:** ملف PDF غير قابل للقراءة

### الحلول المقترحة
- **مراجعة أرقام اللوحات:** تأكد من تسجيل المركبات بأرقام اللوحات الصحيحة
- **تحديث البيانات:** تحديث بيانات المركبات في النظام
- **فحص الملفات:** التأكد من سلامة ملفات PDF
- **الإدخال اليدوي:** إدخال المخالفات غير المطابقة يدوياً

## 🛠️ التطوير المستقبلي

### الميزات المخططة
1. **دعم OCR متقدم:** استخراج أفضل للنصوص من PDF
2. **ذكاء اصطناعي:** تحسين دقة استخراج البيانات
3. **دعم صيغ أخرى:** دعم ملفات Word وExcel
4. **ربط تلقائي محسن:** خوارزميات أذكى لربط المركبات
5. **إشعارات فورية:** تنبيهات عند اكتمال المعالجة

### التحسينات التقنية
- تحسين أداء معالجة الملفات الكبيرة
- دعم المعالجة المتوازية
- تحسين واجهة المستخدم
- إضافة المزيد من خيارات التصدير

## 📞 الدعم والمساعدة

### استكشاف الأخطاء
1. **فشل في رفع الملف:** تأكد من أن الملف بصيغة PDF وحجمه مناسب
2. **عدم استخراج البيانات:** تحقق من تنسيق PDF ووضوح النص
3. **عدم مطابقة المركبات:** راجع أرقام اللوحات في النظام
4. **فشل في الحفظ:** تحقق من الاتصال بقاعدة البيانات

### نصائح للاستخدام الأمثل
- استخدم ملفات PDF عالية الجودة
- تأكد من تحديث بيانات المركبات
- راجع النتائج قبل الحفظ النهائي
- احتفظ بنسخ احتياطية من الملفات الأصلية

---

**تم تطوير هذا النظام لتسهيل إدارة المخالفات المرورية وتوفير الوقت والجهد في إدخال البيانات يدوياً.**
