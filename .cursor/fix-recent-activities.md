# ุฅุตูุงุญ ูุดููุฉ ุนุฏู ุธููุฑ ุงููุดุงุทุงุช ุงูุฃุฎูุฑุฉ

## ๐ ุงููุดููุฉ

ูุณู "ุงููุดุงุทุงุช ุงูุฃุฎูุฑุฉ" ูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ูุง ูุนุฑุถ ุฃู ุจูุงูุงุช.

## ๐ ุงูุชุดุฎูุต

ุชู ุชุญุฏูุฏ ุงูุฃุณุจุงุจ ุงูุชุงููุฉ:

1. **ุฌุฏูู `system_logs` ููุฌูุฏ ููู ุจุฏูู ุณูุงุณุงุช RLS** - ููุง ูููุน ุงููุณุชุฎุฏููู ูู ูุฑุงุกุฉ ุงูุจูุงูุงุช
2. **ุงูุฌุฏูู ูุงุฑุบ** - ูุง ุชูุฌุฏ ุจูุงูุงุช ูุนุฑุถูุง
3. **ุนุฏู ูุฌูุฏ ุขููุฉ ูุชุณุฌูู ุงููุดุงุทุงุช** ุชููุงุฆูุงู ูู ุงููุธุงู

## โ ุงูุญู ุงููุทุจู

### 1. ุฅูุดุงุก Migration ููุฌุฏูู ูุงูุณูุงุณุงุช

ุชู ุฅูุดุงุก ููููู migration:

#### `20250110235900_create_system_logs_table.sql`
- ุฅูุดุงุก ุฌุฏูู `system_logs` ุฅุฐุง ูู ููู ููุฌูุฏุงู
- ุฅุถุงูุฉ ุฌููุน ุงูุญููู ุงููุทููุจุฉ (company_id, user_id, level, category, action, message, etc.)
- ุฅูุดุงุก ุงูููุงุฑุณ ูุชุญุณูู ุงูุฃุฏุงุก

#### `20250111000000_fix_system_logs_rls_policies.sql`
- ุชูุนูู RLS ุนูู ุงูุฌุฏูู
- ุฅุถุงูุฉ ุณูุงุณุฉ ูููุฑุงุกุฉ: ุงูุณูุงุญ ูููุณุชุฎุฏููู ุจุฑุคูุฉ ุณุฌูุงุช ุดุฑูุชูู ููุท
- ุฅุถุงูุฉ ุณูุงุณุฉ ููุฅุฏุฑุงุฌ: ุงูุณูุงุญ ูููุธุงู ุจุฅุฏุฑุงุฌ ุงูุณุฌูุงุช
- ููุน ุงูุชุญุฏูุซ ูุงูุญุฐู ููุญูุงุธ ุนูู ุณูุงูุฉ ุงูุณุฌูุงุช
- ุฏุงูุฉ ูุณุงุนุฏุฉ `create_sample_system_logs()` ูุฅูุดุงุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ

### 2. ุณูุฑูุจุช ูููุก ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ

**ููู:** `src/scripts/populateSystemLogs.ts`

ูููุฑ ุซูุงุซ ุฏูุงู ุฑุฆูุณูุฉ:
- `populateSystemLogs(companyId)` - ููุก ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ
- `clearSystemLogs(companyId)` - ุญุฐู ุฌููุน ุงูุจูุงูุงุช
- `checkSystemLogsCount(companyId)` - ุงูุชุญูู ูู ุนุฏุฏ ุงูุณุฌูุงุช

ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ุชุดูู:
- ๐ ูุดุงุทุงุช ุงูุนููุฏ (ุฅูุดุงุกุ ุชุญุฏูุซุ ุชูุจููุงุช ุงูุชูุงุก)
- ๐ฅ ูุดุงุทุงุช ุงูุนููุงุก (ุชุณุฌููุ ุชุญุฏูุซ)
- ๐ ูุดุงุทุงุช ุงููุฑูุจุงุช (ุฅุถุงูุฉุ ุชุญุฏูุซุ ุชูุจููุงุช ุตูุงูุฉ)
- ๐ฐ ูุดุงุทุงุช ูุงููุฉ (ุฏูุนุงุชุ ุชุญุฐูุฑุงุช ุชุฃุฎูุฑ)
- ๐ ูุดุงุทุงุช ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ (ุฅุถุงูุฉ ููุธููู)
- โ๏ธ ูุดุงุทุงุช ุงููุธุงู (ุชุณุฌูู ุฏุฎููุ ุชุตุฏูุฑุ ูุณุฎ ุงุญุชูุงุทู)

### 3. ูููู ุงููุตุญุญ ูููุทูุฑูู

**ููู:** `src/components/dashboard/SystemLogsDebugger.tsx`

ูููู ุชูุงุนูู ูุธูุฑ ูู ุงูุฒุงููุฉ ุงูุณูููุฉ ุงููุณุฑู (ูู ุจูุฆุฉ ุงูุชุทููุฑ ููุท) ูููุฑ:

**ุงูููุฒุงุช:**
- โ ูุญุต ุนุฏุฏ ุงููุดุงุทุงุช ุงูููุฌูุฏุฉ
- โ ููุก ุจูุงูุงุช ุชุฌุฑูุจูุฉ ุจุถุบุทุฉ ุฒุฑ
- โ ุญุฐู ุฌููุน ุงููุดุงุทุงุช
- โ ุนุฑุถ ูุนูููุงุช ุงูุญุงูุฉ (company_id, ุนุฏุฏ ุงูุณุฌูุงุช)
- โ ุฅุนุงุฏุฉ ุชุญููู ุชููุงุฆูุฉ ุจุนุฏ ููุก ุงูุจูุงูุงุช

**ููููุฉ ุงูุงุณุชุฎุฏุงู:**
1. ุงูุชุญ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ูู ุจูุฆุฉ ุงูุชุทููุฑ
2. ุณุชุฌุฏ ููุทุฉ ุตุบูุฑุฉ ูู ุงูุฒุงููุฉ ุงูุณูููุฉ ุงููุณุฑู
3. ุงุถุบุท ุนูููุง ููุชุญ ุงููุตุญุญ
4. ุงุถุบุท "ูุญุต ุงูุนุฏุฏ" ููุชุญูู ูู ุงูุจูุงูุงุช
5. ุงุถุบุท "ููุก ุงูุจูุงูุงุช" ูุฅูุดุงุก ูุดุงุทุงุช ุชุฌุฑูุจูุฉ
6. ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ุชููุงุฆูุงู

### 4. ุชูุงูู ูุน ููุญุงุช ุงูุชุญูู

ุชู ุฅุถุงูุฉ ุงููููู ุฅูู:
- โ `CarRentalDashboard.tsx`
- โ `RealEstateDashboard.tsx`
- โ `RetailDashboard.tsx`

## ๐ ุฎุทูุงุช ุงูุชุทุจูู

### 1. ุชุทุจูู ุงูู Migrations

ูู ุจุชุดุบูู ุงูุฃูุงูุฑ ุงูุชุงููุฉ ูู ูุฌูุฏ ุงููุดุฑูุน:

```bash
# ุฅุฐุง ููุช ุชุณุชุฎุฏู Supabase CLI
supabase db reset

# ุฃู ุชุทุจูู migrations ูุฏููุงู
supabase migration up
```

ุฃู ูู ุฎูุงู Supabase Dashboard:
1. ุงูุชุญ SQL Editor
2. ูุณุฎ ูุญุชูู ุงูููููู ูู ูุฌูุฏ `supabase/migrations/`
3. ูู ุจุชุดุบููููุง ุจุงูุชุฑุชูุจ

### 2. ุชุดุบูู ุงููุดุฑูุน

```bash
npm run dev
# ุฃู
yarn dev
# ุฃู
pnpm dev
```

### 3. ููุก ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ

#### ุงูุทุฑููุฉ ุงูุฃููู: ุงุณุชุฎุฏุงู ุงููุตุญุญ (ุงูุฃุณูู)

1. ุงูุชุญ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
2. ุงุจุญุซ ุนู ุงูููุทุฉ ุงูุตุบูุฑุฉ ูู ุงูุฒุงููุฉ ุงูุณูููุฉ ุงููุณุฑู
3. ุงุถุบุท ุนูููุง ููุชุญ ุงููุตุญุญ
4. ุงุถุบุท "ููุก ุงูุจูุงูุงุช"
5. ุงูุชุธุฑ ุฅุนุงุฏุฉ ุงูุชุญููู ุงูุชููุงุฆู

#### ุงูุทุฑููุฉ ุงูุซุงููุฉ: ุงุณุชุฎุฏุงู Console ุงููุชุตูุญ

ุงูุชุญ Console ุงููุชุตูุญ (F12) ูุงูุชุจ:

```javascript
// ุงุญุตู ุนูู ูุนุฑู ุดุฑูุชู ูู localStorage ุฃู ูู ุงูููุฏ
const companyId = 'your-company-uuid-here';

// ููุก ุงูุจูุงูุงุช
populateSystemLogs(companyId).then(() => {
  console.log('โ ุชู ููุก ุงูุจูุงูุงุช ุจูุฌุงุญ');
  window.location.reload();
});

// ุฃู ุงูุชุญูู ูู ุงูุนุฏุฏ ุฃููุงู
checkSystemLogsCount(companyId);
```

#### ุงูุทุฑููุฉ ุงูุซุงูุซุฉ: ูู SQL Editor ูู Supabase

```sql
-- ุงุณุชุจุฏู 'your-company-uuid' ุจูุนุฑู ุดุฑูุชู ุงููุนูู
SELECT create_sample_system_logs('your-company-uuid');

-- ููุชุญูู ูู ุงูุจูุงูุงุช
SELECT COUNT(*) FROM system_logs WHERE company_id = 'your-company-uuid';

-- ูุนุฑุถ ุงูุจูุงูุงุช
SELECT * FROM system_logs 
WHERE company_id = 'your-company-uuid' 
ORDER BY created_at DESC 
LIMIT 10;
```

## ๐ง ุงูุตูุงูุฉ ุงููุณุชูุจููุฉ

### ุชุณุฌูู ุงููุดุงุทุงุช ุชููุงุฆูุงู

ูุชุณุฌูู ุงููุดุงุทุงุช ุชููุงุฆูุงู ูู ุงููุณุชูุจูุ ุงุณุชุฎุฏู ุงูู hook ุงูููุฌูุฏ:

```typescript
import { useSystemLogger } from '@/hooks/useSystemLogger';

function MyComponent() {
  const { logAction } = useSystemLogger();

  const handleCreateContract = async () => {
    // ... ููุทู ุฅูุดุงุก ุงูุนูุฏ
    
    // ุชุณุฌูู ุงููุดุงุท
    await logAction({
      level: 'info',
      category: 'contracts',
      action: 'create',
      message: 'ุชู ุฅูุดุงุก ุนูุฏ ุฌุฏูุฏ #2025-001',
      resourceType: 'contract',
      resourceId: contractId,
      metadata: { contractNumber: '2025-001' }
    });
  };
}
```

### ุฅูุดุงุก Triggers ูุชุณุฌูู ุชููุงุฆู

ููููู ุฅูุดุงุก Database Triggers ูุชุณุฌูู ุงูุนูููุงุช ุชููุงุฆูุงู:

```sql
-- ูุซุงู: ุชุณุฌูู ุฅูุดุงุก ุนูุฏ ุฌุฏูุฏ ุชููุงุฆูุงู
CREATE OR REPLACE FUNCTION log_contract_creation()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO system_logs (
    company_id,
    user_id,
    level,
    category,
    action,
    resource_type,
    resource_id,
    message
  ) VALUES (
    NEW.company_id,
    auth.uid(),
    'info',
    'contracts',
    'create',
    'contract',
    NEW.id,
    'ุชู ุฅูุดุงุก ุนูุฏ ุฌุฏูุฏ #' || NEW.contract_number
  );
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_contract_created
  AFTER INSERT ON contracts
  FOR EACH ROW
  EXECUTE FUNCTION log_contract_creation();
```

## ๐ ุงูุชุญูู ูู ุงููุฌุงุญ

ุจุนุฏ ุชุทุจูู ุงูุญูุ ูุฌุจ ุฃู ุชุฑู:

1. โ ูุณู "ุงููุดุงุทุงุช ุงูุฃุฎูุฑุฉ" ูุนุฑุถ ุจูุงูุงุช
2. โ ุงููุดุงุทุงุช ูุฑุชุจุฉ ุญุณุจ ุงูููุช (ุงูุฃุญุฏุซ ุฃููุงู)
3. โ ูู ูุดุงุท ูุญุชูู ุนูู:
   - ุฃููููุฉ ููููุฉ ุชูุซู ููุน ุงููุดุงุท
   - ุนููุงู ุงููุดุงุท
   - ูุตู ุชูุตููู
   - ุงูููุช ุงููุณุจู (ููุฐ X ุฏูููุฉ/ุณุงุนุฉ/ููู)
4. โ ุชุตููุฉ ุงููุดุงุทุงุช ุญุณุจ ุงูููุน (ุงูุนููุฏุ ุงูุนููุงุกุ ุงููุฑูุจุงุชุ ุฅูุฎ)
5. โ ุฅููุงููุฉ ุชุญุฏูุซ ุงููุงุฆูุฉ

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ูุง ุชุฒุงู ุงููุดุงุทุงุช ูุง ุชุธูุฑ

**ุงูุญููู:**
1. ุชุญูู ูู ุชุทุจูู ุงูู migrations ุจูุฌุงุญ
2. ุชุญูู ูู ูุฌูุฏ `company_id` ุตุญูุญ
3. ุงูุชุญ Console ุงููุชุตูุญ ูุงุจุญุซ ุนู ุฃุฎุทุงุก
4. ุชุญูู ูู ุณูุงุณุงุช RLS ูู Supabase Dashboard

### ุงููุดููุฉ: ุฎุทุฃ ูู ุงูุฃุฐููุงุช (RLS Policy)

```sql
-- ุชุญูู ูู ุงูุณูุงุณุงุช ุงูููุฌูุฏุฉ
SELECT * FROM pg_policies WHERE tablename = 'system_logs';

-- ุฅุนุงุฏุฉ ุชุทุจูู ุงูุณูุงุณุงุช
DROP POLICY IF EXISTS "Users can view their company system logs" ON system_logs;
-- ... ุซู ุฃุนุฏ ุชุดุบูู migration ุงูุณูุงุณุงุช
```

### ุงููุดููุฉ: ุงูุจูุงูุงุช ูุง ุชุธูุฑ ูููุณุชุฎุฏููู

ุชุญูู ูู:
```sql
-- ูู ุงููุณุชุฎุฏู ูุฏูู company_idุ
SELECT user_id, company_id FROM profiles WHERE user_id = auth.uid();

-- ูู ุชูุฌุฏ ุณุฌูุงุช ููุฐู ุงูุดุฑูุฉุ
SELECT COUNT(*) FROM system_logs WHERE company_id = 'your-company-id';
```

## ๐ ููุงุญุธุงุช ูููุฉ

1. ุงููููู ุงููุตุญุญ (`SystemLogsDebugger`) ูุธูุฑ **ููุท ูู ุจูุฆุฉ ุงูุชุทููุฑ**
2. ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ูููู ุญุฐููุง ูู ุฃู ููุช
3. ูู ุงูุฅูุชุงุฌุ ูุฌุจ ุงูุงุนุชูุงุฏ ุนูู ุชุณุฌูู ุงููุดุงุทุงุช ุงูุญููููุฉ
4. ุงูู migration ุขูู ููููู ุชุดุบููู ุนุฏุฉ ูุฑุงุช (ูุณุชุฎุฏู `IF NOT EXISTS`)

## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. โ **ุชุทุจูู Migrations** - ุฃููููุฉ ุนุงููุฉ
2. โ **ุงุฎุชุจุงุฑ ุงููุตุญุญ** - ุชุฃูุฏ ูู ุนููู
3. ๐ **ุฅุถุงูุฉ ุชุณุฌูู ุชููุงุฆู** - ูู ุฌููุน ุงูุนูููุงุช ุงูุฑุฆูุณูุฉ
4. ๐ **ุฅูุดุงุก Triggers** - ููุนูููุงุช ุงูุดุงุฆุนุฉ
5. ๐ **ุชุญุณูู ุงูุฑุณุงุฆู** - ุฌุนููุง ุฃูุซุฑ ูุถูุญุงู ููููุฏุฉ

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:
1. ุชุญูู ูู Console ุงููุชุตูุญ ููุฃุฎุทุงุก
2. ุงุณุชุฎุฏู ุงููุตุญุญ ููุญุต ุงูุญุงูุฉ
3. ุฑุงุฌุน ูุฐุง ุงูููู ููุญููู

---

**ุชุงุฑูุฎ ุงูุฅูุดุงุก:** 2025-01-11  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุชุทุจูู  
**ุงููุทูุฑ:** Cursor AI Assistant

