# تحليل منطق مطابقة العقود

## المشكلة المكتشفة

عند مراجعة قاعدة البيانات، تبين أن:

### 1. حالات العقود
- **العقود الملغاة (cancelled):** 399 عقد
- **العقود النشطة (active):** 114 عقد
- **العقود المنتهية (expired):** 4 عقود

**المشكلة:** السكريبت يبحث فقط عن العقود بحالة `active`, `rented`, `approved`، مما يعني:
- لن يجد العقود الملغاة (399 عقد)
- لن يجد العقود المنتهية (4 عقود)

### 2. أمثلة من قاعدة البيانات

#### مثال 1: انور محمد ابراهيم
- **في JSON:** المركبة `10172`
- **في قاعدة البيانات:**
  - عقد نشط `CNT-25-0470` مرتبط بمركبة `4016` (مركبة مختلفة!)
  - عقد ملغي `LTO2024125` للعميل `ANWAR MOHAMED` مرتبط بمركبة `10172`

#### مثال 2: مركبة 10172
- **العقود المرتبطة بها:**
  - `CNT-25-0412` (نشط) - للعميل `محمد عوض` (عميل مختلف!)
  - `LTO2024125` (ملغي) - للعميل `ANWAR MOHAMED`

## التحليل

### السبب الحقيقي لعدم المطابقة:

1. **العقود الموجودة قد تكون ملغاة أو منتهية**
   - ملف JSON يحتوي على بيانات العقود الحالية/النشطة
   - قاعدة البيانات تحتوي على عقود قديمة ملغاة

2. **تغيير المركبات**
   - العميل نفسه قد يكون لديه عقود مختلفة لمركبات مختلفة
   - مثال: `انور محمد ابراهيم` لديه عقد مع مركبة `4016` وليس `10172`

3. **العقود قد لا تكون موجودة أصلاً**
   - بعض السجلات في JSON قد تكون جديدة تماماً

## الحلول المقترحة

### الخيار 1: تحديث العقود النشطة فقط (محافظ)
- ابحث عن أي عقد نشط للعميل (بغض النظر عن المركبة)
- حدّث بيانات العقد ليطابق JSON
- **الإيجابيات:** آمن، لا يخلق بيانات جديدة
- **السلبيات:** قد لا يجد بعض العقود

### الخيار 2: إنشاء عقود جديدة للسجلات غير المطابقة
- إذا لم يُعثر على عقد، أنشئ عقد جديد
- **الإيجابيات:** يضمن وجود جميع البيانات
- **السلبيات:** قد ينشئ عقود مكررة

### الخيار 3: البحث الموسع ثم الإنشاء (موصى به)
1. ابحث عن عقد نشط للعميل + المركبة
2. إذا لم تجد، ابحث عن أي عقد نشط للعميل (أي مركبة)
3. إذا لم تجد، ابحث عن أي عقد للعميل (أي حالة)
4. إذا وُجد عقد ملغي/منتهي، لا تحدثه (حفاظاً على السجل التاريخي)
5. إذا لم تجد أي عقد، **أنشئ عقد جديد نشط**

### الخيار 4: تحديث ذكي (الأفضل)
1. ابحث عن عقد نشط للعميل
2. إذا وُجد:
   - حدّث `vehicle_id` و `license_plate` ليطابق JSON
   - حدّث `start_date` و `monthly_amount`
3. إذا لم يُوجد:
   - **أنشئ عقد جديد** بالبيانات من JSON

## التوصية النهائية

**استخدام الخيار 4** مع إضافة:
- ✅ البحث عن أي عقد نشط للعميل (بغض النظر عن المركبة)
- ✅ تحديث بيانات العقد (المركبة، التاريخ، المبلغ)
- ✅ إنشاء عقد جديد إذا لم يُوجد عقد نشط
- ✅ تسجيل تفصيلي للإجراءات المتخذة

## الحقول المطلوبة لإنشاء عقد جديد
- `customer_id` (UUID) ✅
- `vehicle_id` (UUID) ✅
- `company_id` (UUID) ✅
- `contract_number` (نص فريد) - سيتم توليده
- `start_date` (تاريخ) ✅
- `monthly_amount` (رقم) ✅
- `status` (نص) - سيكون 'active'
- `contract_type` - افتراضي 'rental'
- `license_plate` - من JSON ✅

هل تريد تطبيق الخيار 4 (الأفضل)؟

