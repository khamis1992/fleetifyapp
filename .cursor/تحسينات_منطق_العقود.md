# تحسينات منطق مطابقة وإنشاء العقود

## التحسينات المطبقة

### 1. منطق البحث الموسع (4 استراتيجيات)

#### الاستراتيجية 1: مطابقة دقيقة (عميل + مركبة)
- ابحث عن عقد نشط للعميل مع المركبة المحددة
- أعلى أولوية للمطابقة

#### الاستراتيجية 2: مطابقة برقم اللوحة
- ابحث عن عقد نشط للعميل حسب `license_plate`
- مفيد إذا تم تحديث `vehicle_id` سابقاً

#### الاستراتيجية 3: أي عقد نشط للعميل
- ابحث عن **أي عقد نشط** للعميل (بغض النظر عن المركبة)
- سيتم تحديث المركبة لاحقاً

#### الاستراتيجية 4: أي عقد للعميل (أي حالة)
- ابحث عن **أي عقد** للعميل (حتى لو ملغي أو منتهي)
- سيتم **إعادة تفعيله** إلى 'active'

### 2. التحديث الذكي للعقود

عند العثور على عقد:
- ✅ إعادة تفعيل إذا كان ملغياً/منتهياً (`cancelled` → `active`)
- ✅ تحديث المركبة (`vehicle_id`, `license_plate`)
- ✅ تحديث تاريخ البدء (`start_date`)
- ✅ تحديث المبلغ الشهري (`monthly_amount`)

### 3. إنشاء عقود جديدة

إذا لم يُعثر على أي عقد:
- ✅ إنشاء عقد جديد بحالة 'active'
- ✅ توليد رقم عقد فريد (`CNT-2025-XXXX`)
- ✅ ربط العميل + المركبة + الشركة
- ✅ تعيين جميع البيانات من JSON

## مثال عملي

### حالة: انور محمد ابراهيم
**في JSON:**
- المركبة: `10172`
- تاريخ البدء: `15/4/2025`
- المبلغ الشهري: `1500`

**في قاعدة البيانات:**
- عقد نشط موجود مع مركبة `4016`

**ما سيحدث:**
1. ✅ العثور على العقد النشط
2. ✅ تحديث `vehicle_id` من `4016` إلى `10172`
3. ✅ تحديث `license_plate` إلى `10172`
4. ✅ تحديث `start_date` إلى `2025-04-15`
5. ✅ تحديث `monthly_amount` إلى `1500`

### حالة: عميل جديد بدون عقود
**في JSON:**
- عميل جديد
- المركبة: `X`
- تاريخ البدء: `Y`

**ما سيحدث:**
1. ✅ إنشاء العميل
2. ✅ العثور على المركبة
3. ✅ إنشاء عقد جديد بحالة 'active'

## الفوائد

- ✅ **لا توجد عقود مفقودة:** كل سجل في JSON سيكون له عقد
- ✅ **إعادة تفعيل ذكية:** العقود الملغاة سيتم إعادة تفعيلها
- ✅ **تحديث شامل:** جميع بيانات العقود ستطابق JSON
- ✅ **حفظ السجلات:** العقود الموجودة يتم تحديثها (لا يتم حذفها)

## الحالات الخاصة

### تاريخ غير صالح (`-` أو فارغ)
- لن يتم إنشاء عقد
- سيتم تسجيله في `unmatched`

### مبلغ غير صالح (فارغ أو صفر)
- لن يتم إنشاء عقد
- سيتم تسجيله في `unmatched`

### رقم هاتف فارغ (`null`)
- لن يتم إنشاء العميل
- سيتم تسجيله في `unmatched`

