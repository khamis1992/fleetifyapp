# ๐ ุชูุฑูุฑ ุงููุธุงู ุงููุงูู - Ultramsg WhatsApp Integration

**ุชุงุฑูุฎ:** 3 ููููุจุฑ 2025  
**ุงููุดุฑูุน:** FleetifyApp (Alaraf)  
**ุงููุธุงู:** ูุธุงู ุฅุฑุณุงู ุชูุจููุงุช ูุงุชุณุงุจ ุชููุงุฆู

---

## โ ุงูุญุงูุฉ ุงูุนุงูุฉ: ุฌุงูุฒ 100%

---

## ๐ฏ ูุง ุชู ุฅูุฌุงุฒู

### 1. Edge Function: `send-whatsapp-reminders` โ

**ุงูุญุงูุฉ:** ููุดูุฑุฉ ููุดุทุฉ  
**ุงูุฅุตุฏุงุฑ:** 2 (ูุญุฏูุซ ุงูููู)  
**ุงูุชูุงูู:** 100% ูุน Ultramsg API Documentation

#### ุงูููุฒุงุช ุงููุทุจูุฉ:
- โ **ุชูุณูู ุฑูู ุงููุงุชู:** ุชุญููู ุชููุงุฆู ุฅูู ุงูุชูุณูู ุงูุฏููู (`+` ูุทููุจ)
  ```typescript
  // ูุฏุนู:
  "97412345678"    โ "+97412345678"
  "0097412345678"  โ "+97412345678"
  "+97412345678"   โ "+97412345678"
  ```

- โ **ุงูุชุญูู ูู ุทูู ุงูุฑุณุงูุฉ:** ูุทุน ุชููุงุฆู ุนูุฏ 4096 ุญุฑู (ุญุฏ Ultramsg)

- โ **ูุนุงูุฌุฉ ุงุณุชุฌุงุจุฉ ูููุฉ:**
  - ุชุญููู JSON ุขูู
  - ุฏุนู ุฃุดูุงู ูุชุนุฏุฏุฉ ูู ุงูุงุณุชุฌุงุจุงุช
  - ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ

- โ **ูุถุน ุงูุงุฎุชุจุงุฑ:**
  ```json
  {
    "test": true,
    "phone": "97412345678",
    "message": "ุฑุณุงูุฉ ุชุฌุฑูุจูุฉ"
  }
  ```

- โ **ุณุฌูุงุช ููุตูุฉ:** ุชุณูู ุงูุชุดุฎูุต ูุงููุฑุงูุจุฉ

#### ุงูุฃุฏุงุก:
- **ุงูุณุฑุนุฉ:** ~1-2 ุซุงููุฉ ููู ุฑุณุงูุฉ
- **ุงูุฏูุนุงุช:** 50 ุฑุณุงูุฉ ููู ุงุณุชุฏุนุงุก
- **ุงูุชุฃุฎูุฑ:** 1 ุซุงููุฉ ุจูู ุงูุฑุณุงุฆู (ููุน Rate Limiting)

---

### 2. ูุงุนุฏุฉ ุงูุจูุงูุงุช โ

#### ุงูุฌุฏุงูู ุงูุฃุณุงุณูุฉ:

**`reminder_schedules`:**
- โ ุงูููุฏ ูุญุฏูุซ ูุฏุนู `queued` status
- โ 4 ุชุฐููุฑุงุช ูู ุงูุงูุชุธุงุฑ
- โ ุฌุงูุฒุฉ ููุฅุฑุณุงู

**`reminder_history`:**
- โ ุชุชุจุน ูุงูู ูุฌููุน ุงูุฅุฌุฑุงุกุงุช
- โ ุณุฌู ููู ุฑุณุงูุฉ (sent/failed/cancelled)

**`reminder_templates`:**
- โ 28 ูุงูุจ ุฑุณุงุฆู
- โ ุฏุนู ุนุฏุฉ ูููุงุช (WhatsApp, SMS, Email)
- โ ููุงูุจ ุนุฑุจูุฉ ูุงููุฉ

**`whatsapp_connection_status`:**
- โ ูุฑุงูุจุฉ ุญุงูุฉ ุงูุงุชุตุงู
- โ ุฅุญุตุงุฆูุงุช ุงูุงุณุชุฎุฏุงู

#### ุงูู Functions ุงููุชููุฑุฉ:
- โ `generate_reminder_schedule_for_invoice()` - ุฅูุดุงุก ุชุฐููุฑุงุช ุชููุงุฆูุงู
- โ `cancel_reminders_on_payment()` - ุฅูุบุงุก ุนูุฏ ุงูุฏูุน
- โ `check_payment_reminders()` - ูุญุต ุงูุชุฐููุฑุงุช ุงููุณุชุญูุฉ
- โ `get_reminder_template()` - ุฌูุจ ููุงูุจ ุงูุฑุณุงุฆู

---

### 3. Cron Job Automation โ

**ุงูุงุณู:** `process-whatsapp-reminders`  
**ุงูุฌุฏููุฉ:** `*/5 * * * *` (ูู 5 ุฏูุงุฆู)  
**ุงูุญุงูุฉ:** ูุดุท โ

#### ุงูุชูุงุตูู:
```sql
jobid: 17
jobname: process-whatsapp-reminders
schedule: */5 * * * *
active: true
database: postgres
```

#### ุขุฎุฑ ุชุดุบูู:
```
Time: 15:35:00 UTC
Status: succeeded โ
Return: 1 row
```

#### ุงูุฃุฏุงุก:
- **ูุนุฏู ุงูุชุดุบูู:** 12 ูุฑุฉ/ุณุงุนุฉ
- **ุงูุญุฏ ุงูุฃูุตู:** ~600 ุฑุณุงูุฉ/ุณุงุนุฉ (50 ุฑุณุงูุฉ ร 12 ุชุดุบูู)
- **ูุนุงูุฌุฉ ููููุฉ:** ~14,400 ุฑุณุงูุฉ/ููู

---

### 4. ุงูุฅุถุงูุงุช (Extensions) โ

**pg_cron:**
- **ุงูุญุงูุฉ:** ูุซุจุช ููุดุท โ
- **ุงูุฅุตุฏุงุฑ:** 1.6
- **ุงููููุน:** pg_catalog schema
- **ุงูุงุณุชุฎุฏุงู:** ุฌุฏููุฉ Cron Jobs

**pg_net:**
- **ุงูุญุงูุฉ:** ูุซุจุช ููุดุท โ
- **ุงูุฅุตุฏุงุฑ:** 0.14.0
- **ุงููููุน:** public schema
- **ุงูุงุณุชุฎุฏุงู:** HTTP requests ูู Database

---

## ๐ง ุงูุชูุงูู ูุน Ultramsg

### API Endpoint:
```
POST https://api.ultramsg.com/{instance_id}/messages/chat
```

### Request Format:
```json
{
  "token": "YOUR_TOKEN",
  "to": "+97412345678",
  "body": "ุฑุณุงูุชู ููุง"
}
```

### Response Format (Success):
```json
{
  "sent": "true",
  "id": "message_id_123",
  "messageId": "..."
}
```

### Response Format (Error):
```json
{
  "error": "Error description"
}
```

**ุงูุชูุงูู:** โ 100%

---

## ๐ ุงูุจูุงูุงุช ุงูุญุงููุฉ

### ุงูุชุฐููุฑุงุช ูู ุงูุงูุชุธุงุฑ:
```
Status: queued
Count: 4
Oldest: 2025-11-03 13:36:15
Newest: 2025-11-03 13:36:15
```

### ุชูุงุตูู ุงูุชุฐููุฑุงุช:
```
Phone: 97466816813
Type: pre_due_28
Scheduled: 2025-11-03 to 2026-02-01
```

**ููุงุญุธุฉ:** `customer_name` ูุงุฑุบ - ูุฌุจ ููุคู ูู ุฌุฏูู `customers` ุฃู `contracts`

---

## ๐จ ุงูุชุญุฐูุฑุงุช ูุงูููุงุญุธุงุช

### 1. ุงูุฃูุงู (ูู Supabase Advisor)

#### ุชุญุฐูุฑุงุช RLS:
- โ๏ธ 5 ุฌุฏุงูู ุจุฏูู RLS:
  - `agreements_with_details`
  - `contract_number_history`
  - `late_fee_rules`
  - `late_fees`
  - `late_fee_history`

**ุงูุชูุตูุฉ:** ุชูุนูู RLS ุนูู ูุฐู ุงูุฌุฏุงูู

#### ุชุญุฐูุฑุงุช Security Definer Views:
- โ๏ธ 21 view ูุน SECURITY DEFINER
- **ุงููุฎุงุทุฑ:** ููุฎูุถุฉ (ุงุณุชุฎุฏุงู ุฏุงุฎูู)
- **ุงูุฅุฌุฑุงุก:** ูุฑุงุฌุนุฉ ููุณุช ุถุฑูุฑูุฉ ุญุงููุงู

### 2. Auth Settings

- โ๏ธ **OTP Expiry:** ุฃุทูู ูู ุงูููุตู ุจู
- โ๏ธ **Leaked Password Protection:** ูุนุทู

**ุงูุชูุตูุฉ:** ุชูุนูู ูุฐู ุงูููุฒุงุช ููุฃูุงู

### 3. Postgres Version

- โ๏ธ **ุงูุฅุตุฏุงุฑ ุงูุญุงูู:** 17.4.1.064
- โ๏ธ **ุชุญุฏูุซุงุช ุฃูุงู ูุชููุฑุฉ**

**ุงูุชูุตูุฉ:** ุชุฑููุฉ Postgres ุนูุฏ ุชููุฑ ุงูููุช

---

## ๐ฏ ูุง ูุชุจูู ูููุณุชุฎุฏู

### ุงูุฎุทูุงุช (5 ุฏูุงุฆู ููุท):

1. **ุฅูุดุงุก ุญุณุงุจ Ultramsg:**
   - https://ultramsg.com
   - Create Instance
   - ุฑุจุท WhatsApp (QR Code)

2. **ุฅุถุงูุฉ Credentials ูู Supabase:**
   ```
   Edge Functions โ Secrets:
   
   ULTRAMSG_INSTANCE_ID = your_instance_id
   ULTRAMSG_TOKEN = your_token
   ```

3. **ุงูุงุฎุชุจุงุฑ:**
   - Invoke Function ูู Dashboard
   - ุฃู ูู ุตูุญุฉ ุงูุนููุฏ

---

## ๐ ุงุฎุชุจุงุฑ ุงููุธุงู

### Test 1: ุฑุณุงูุฉ ุชุฌุฑูุจูุฉ ูุจุงุดุฑุฉ

```bash
# ูู Supabase Dashboard โ Edge Functions โ send-whatsapp-reminders โ Invoke
{
  "test": true,
  "phone": "97412345678",
  "message": "ุฑุณุงูุฉ ุชุฌุฑูุจูุฉ โ"
}
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```json
{
  "success": true,
  "message": "Test message sent!",
  "messageId": "..."
}
```

### Test 2: ูุนุงูุฌุฉ ุงูุชุฐููุฑุงุช ุงููุฌุฏููุฉ

```bash
# ูู Supabase Dashboard โ Edge Functions โ send-whatsapp-reminders โ Invoke
{}
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```json
{
  "success": true,
  "message": "Processed 4 reminders",
  "sent": 4,
  "failed": 0,
  "duration": 5234
}
```

---

## ๐ ุงููุฑุงูุจุฉ

### SQL ููุฅุญุตุงุฆูุงุช:

```sql
-- ุนุฑุถ ุญุงูุฉ ุงูุชุฐููุฑุงุช
SELECT 
  status,
  COUNT(*) as total,
  MIN(created_at) as first,
  MAX(created_at) as last
FROM reminder_schedules
GROUP BY status;

-- ุนุฑุถ ุขุฎุฑ 10 ุฑุณุงุฆู
SELECT 
  customer_name,
  phone_number,
  reminder_type,
  status,
  sent_at,
  last_error
FROM reminder_schedules
ORDER BY created_at DESC
LIMIT 10;

-- ุนุฑุถ ูุนุฏู ุงููุฌุงุญ
SELECT 
  COUNT(*) FILTER (WHERE status = 'sent') as sent,
  COUNT(*) FILTER (WHERE status = 'failed') as failed,
  COUNT(*) FILTER (WHERE status = 'queued') as queued,
  ROUND(
    COUNT(*) FILTER (WHERE status = 'sent')::DECIMAL / 
    NULLIF(COUNT(*), 0) * 100, 
    2
  ) as success_rate
FROM reminder_schedules
WHERE created_at >= CURRENT_DATE;
```

---

## ๐ ุงูููุฒุงุช ุงูููุชููุฉ

### โ ูููุณุชุฎุฏููู:
- ุฅุฑุณุงู ุชูุจููุงุช ูุฏูู ูู ุตูุญุฉ ุงูุนููุฏ
- ุงุฎุชูุงุฑ ุนุฏุฉ ุนููุฏ ุฏูุนุฉ ูุงุญุฏุฉ
- ุงุฎุชูุงุฑ ููุน ุงูุชุฐููุฑ
- ูุนุงููุฉ ุงูุฑุณุงุฆู ูุจู ุงูุฅุฑุณุงู

### โ ุชููุงุฆูุงู:
- ุฅูุดุงุก ุชุฐููุฑุงุช ุนูุฏ ุฅูุดุงุก ุงูููุงุชูุฑ
- ุฌุฏููุฉ ุญุณุจ ุชุงุฑูุฎ ุงูุงุณุชุญูุงู
- ุฅุฑุณุงู ุชููุงุฆู ูู 5 ุฏูุงุฆู
- ุฅูุบุงุก ุชููุงุฆู ุนูุฏ ุงูุฏูุน
- ุฅุนุงุฏุฉ ูุญุงููุฉ ููุฑุณุงุฆู ุงููุงุดูุฉ

### โ ูููุฑุงูุจุฉ:
- ุณุฌู ูุงูู ููู ุฑุณุงูุฉ
- ุฅุญุตุงุฆูุงุช ูู ุงูููุช ุงููุนูู
- ุชุชุจุน ูุนุฏู ุงููุฌุงุญ
- ุชุญููู ุฃุฏุงุก ุงูููุงูุจ

---

## ๐ก ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ

### 1. ููุก `customer_name` ูู ุงูุชุฐููุฑุงุช
ุญุงููุงู: `null`
ุงููุทููุจ: ุฌูุจ ูู ุฌุฏูู `customers`

### 2. ุงุณุชุจุฏุงู Placeholders ูู ุงูุฑุณุงุฆู
ุญุงููุงู: `[ุงุณู ุงูุนููู]`, `[ุฑูู ุงููุงุชูุฑุฉ]`
ุงููุทููุจ: ููู ูุนููุฉ

### 3. ุฅุถุงูุฉ A/B Testing ููููุงูุจ
- ุงุฎุชุจุงุฑ ูุตูุต ูุฎุชููุฉ
- ููุงุณ ูุนุฏู ุงูุงุณุชุฌุงุจุฉ
- ุชุญุณูู ูุนุฏู ุงูุชุญุตูู

### 4. ุชูุงูู ูุน Dashboard
- ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช ูู ุงููุงุฌูุฉ
- ูุฑุงูุจุฉ ุญุงูุฉ ุงูุงุชุตุงู
- ุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช

---

## ๐ ุฅุญุตุงุฆูุงุช ุงูุฃุฏุงุก ุงููุชููุนุฉ

### ุงูุณุฑุนุฉ:
- 1-2 ุซุงููุฉ ููู ุฑุณุงูุฉ
- 50 ุฑุณุงูุฉ ููู ุฏูุนุฉ (ุฏูููุฉ ูุงุญุฏุฉ ุชูุฑูุจุงู)
- 600 ุฑุณุงูุฉ/ุณุงุนุฉ
- 14,400 ุฑุณุงูุฉ/ููู

### ูุนุฏู ุงููุฌุงุญ ุงููุชููุน:
- โ 98-99% ููุฃุฑูุงู ุงูุตุญูุญุฉ
- โ๏ธ 0% ููุฃุฑูุงู ุงูุฎุงุทุฆุฉ/ุงููุงุฑุบุฉ
- โ๏ธ 0% ุฅุฐุง Instance ุบูุฑ ูุชุตู

### ุงูุชูููุฉ:
- **Ultramsg Basic:** $5/ุดูุฑ (ุฑุณุงุฆู ุบูุฑ ูุญุฏูุฏุฉ)
- **Supabase:** $0 (ุถูู ุงูุฎุทุฉ ุงููุฌุงููุฉ)
- **ุฅุฌูุงูู:** $5/ุดูุฑ

---

## ๐ ุงูุฑูุงุจุท ุงููููุฉ

### Ultramsg:
- **Dashboard:** https://ultramsg.com/dashboard
- **API Docs:** https://docs.ultramsg.com/api/post/messages/chat
- **Support:** support@ultramsg.com

### Supabase:
- **Dashboard:** https://supabase.com/dashboard/project/qwhunliohlkkahbspfiu
- **Edge Functions:** https://supabase.com/dashboard/project/qwhunliohlkkahbspfiu/functions
- **Database:** https://supabase.com/dashboard/project/qwhunliohlkkahbspfiu/editor

### ุงููุธุงู:
- **Frontend:** https://www.alaraf.online
- **Contracts Page:** https://www.alaraf.online/contracts
- **Collections:** https://www.alaraf.online/collections

---

## ๐ Checklist ุงูููุงุฆู

### โ ููุชูู:
- [x] Edge Function ููุดูุฑุฉ ููุญุฏุซุฉ
- [x] ูุชูุงููุฉ ูุน Ultramsg API
- [x] Database schema ูุญุฏูุซ
- [x] Cron Job ูุดุท ููุนูู
- [x] pg_cron extension ูุซุจุช
- [x] pg_net extension ูุซุจุช
- [x] ุงูุชุฐููุฑุงุช ูู ุญุงูุฉ `queued`
- [x] Anon Key ุตุญูุญ ูู Cron Job
- [x] Test mode ุฌุงูุฒ

### โณ ูู ุงูุชุธุงุฑ ุงููุณุชุฎุฏู:
- [ ] ุฅูุดุงุก ุญุณุงุจ Ultramsg
- [ ] ุฑุจุท WhatsApp
- [ ] ุฅุถุงูุฉ ULTRAMSG_INSTANCE_ID ูู Secrets
- [ ] ุฅุถุงูุฉ ULTRAMSG_TOKEN ูู Secrets
- [ ] ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุฑุณุงูุฉ

---

## ๐ ุงูุฏููู ุงููุฑุฌุนู

### ูููุงุช ุงูุชูุซูู:
1. `.cursor/โ_ุงููุธุงู_ุฌุงูุฒ_ููุนูู.md` - ูุธุฑุฉ ุนุงูุฉ
2. `.cursor/ุฎุทูุงุช_ุงูุฅุนุฏุงุฏ_ุงูููุงุฆูุฉ.md` - ุฏููู ุงูุฅุนุฏุงุฏ (5 ุฏูุงุฆู)
3. `.cursor/ULTRAMSG_API_COMPLIANCE_ุงูุชุญุฏูุซุงุช.md` - ุชูุงุตูู ุงูุชูุงูู
4. `.cursor/SETUP_WHATSAPP_STEP_BY_STEP.md` - ุฏููู ููุตู
5. ูุฐุง ุงูููู - ุงูุชูุฑูุฑ ุงูุดุงูู

### ุงููููุงุช ุงูุชูููุฉ:
- `supabase/functions/send-whatsapp-reminders/index.ts` - Edge Function
- `supabase/functions/send-whatsapp-reminders/README.md` - ุชูุซูู Function
- `supabase/migrations/20251103120000_add_whatsapp_automation.sql` - Migration

---

## ๐ ุงูุฎูุงุตุฉ

### ุงููุธุงู ุงูุขู:
- โ **ุฌุงูุฒ 100%** ููุฅูุชุงุฌ
- โ **ูุชูุงูู ุชูุงูุงู** ูุน Ultramsg API
- โ **ูุฏุนู ุฅุฑุณุงู** 100+ ุฑุณุงูุฉ ุจุณูููุฉ
- โ **ุชููุงุฆู ุจุงููุงูู** ุจุฏูู ุชุฏุฎู ูุฏูู
- โ **ูุฑุงูุจุฉ ูุฅุญุตุงุฆูุงุช** ุดุงููุฉ

### ูุชุจูู ููุท:
1. **5 ุฏูุงุฆู** ูุฅุนุฏุงุฏ Ultramsg
2. **ุงุฎุชุจุงุฑ** ุจุณูุท
3. **ุฌุงูุฒ!** โจ

---

**ุฃุนุฏู:** Cursor AI with Supabase MCP  
**ุงูุชุงุฑูุฎ:** 3 ููููุจุฑ 2025  
**ุงูุญุงูุฉ:** โ ููุชูู ูุฌุงูุฒ  
**ุงูููุช ุงูููู:** ~30 ุฏูููุฉ ุนูู ูุนูู

