# 📋 نظام تتبع العملاء المتأخرين - خطة التطوير الشاملة
# Delinquent Customers Pre-Litigation System - Comprehensive Development Plan

---

## 🎯 ملخص تنفيذي | Executive Summary

### الطلب الأصلي
إضافة تبويبة جديدة في قسم متابعة القضايا تعرض:
- ✅ جميع العملاء المتأخرين عن دفع الإيجار (تلقائياً)
- ✅ عدد الأشهر المتأخرة لكل عميل
- ✅ إجمالي الإيجارات المستحقة
- ✅ غرامات التأخير
- ✅ المخالفات المرورية
- ✅ جاهزة للتحويل إلى قضية قانونية

### الحل المطور (المطلوب + إضافات ذكية)
نظام متكامل يتضمن:
1. **المميزات الأساسية المطلوبة** (6 مميزات)
2. **مميزات ذكية إضافية** (9 مميزات متقدمة)
3. **تكامل كامل** مع الأنظمة الموجودة
4. **ذكاء اصطناعي** للتوصيات والإنذارات

---

## 📊 المميزات التفصيلية | Detailed Features

### المميزات الأساسية ✅

| # | الميزة | الوصف | القيمة |
|---|--------|------|--------|
| 1 | **عرض تلقائي** | قائمة بجميع العملاء المتأخرين | توفير الوقت |
| 2 | **عدد الأشهر** | حساب دقيق للأشهر غير المدفوعة | دقة البيانات |
| 3 | **إجمالي الإيجارات** | مجموع المبالغ المستحقة | شفافية مالية |
| 4 | **الغرامات** | حساب غرامات التأخير (0.1% يومياً) | استرداد الحقوق |
| 5 | **المخالفات** | عرض مخالفات العميل غير المدفوعة | رؤية شاملة |
| 6 | **التحويل السريع** | تحويل إلى قضية قانونية بضغطة زر | سرعة الإجراءات |

### المميزات الإضافية المطورة 🚀

| # | الميزة | الوصف | القيمة المضافة |
|---|--------|------|----------------|
| 1 | **نظام تقييم المخاطر** | درجة ذكية (0-100) لكل عميل | أولويات واضحة |
| 2 | **التوصيات الذكية** | النظام يقترح الإجراء المناسب | قرارات سريعة |
| 3 | **لوحة الأثر المالي** | تحليل شامل للمخاطر المالية | فهم استراتيجي |
| 4 | **العمليات الجماعية** | إنشاء قضايا/إنذارات لعدة عملاء | توفير 80% من الوقت |
| 5 | **الإنذارات التلقائية** | توليد إنذارات بالذكاء الاصطناعي | جودة قانونية عالية |
| 6 | **تتبع الجدول الزمني** | سجل كامل لكل الإجراءات | شفافية ومساءلة |
| 7 | **حاسبة الجدوى** | تحليل ROI لرفع القضية | قرارات مبنية على بيانات |
| 8 | **التنبيهات الذكية** | إشعارات عند تجاوز حدود معينة | استباقية |
| 9 | **التقارير المتقدمة** | تصدير Excel/PDF مخصص | مشاركة احترافية |

---

## 🧮 خوارزميات الحساب | Calculation Algorithms

### 1. نظام تقييم المخاطر (0-100)

```javascript
Risk Score = 
  (Days Overdue × 40%) +
  (Amount Overdue × 30%) +
  (Violations × 15%) +
  (Payment History × 10%) +
  (Legal History × 5%)
```

**مثال عملي**:
```
عميل: شركة الخليج
- تأخير 90 يوم → (90/120) × 100 × 0.40 = 30 نقطة
- مديونية 40k من حد 50k → (40k/50k) × 100 × 0.30 = 24 نقطة
- 3 مخالفات → (3/5) × 100 × 0.15 = 9 نقطة
- 4 دفعات فائتة من 10 → (4/10) × 100 × 0.10 = 4 نقطة
- قضية سابقة → 100 × 0.05 = 5 نقطة

النتيجة النهائية: 72 نقطة (خطر عالي 🔴)
```

### 2. حساب غرامات التأخير

```javascript
الغرامة = المبلغ المتأخر × 0.001 × (الأيام - 5)
الحد الأقصى = المبلغ المتأخر × 0.20
```

**مثال**:
```
مبلغ متأخر: 10,000 د.ك
أيام التأخير: 95 يوم
فترة سماح: 5 أيام

الحساب:
10,000 × 0.001 × (95 - 5) = 900 د.ك ✅
الحد الأقصى: 2,000 د.ك
```

### 3. التوصية بالإجراء

| الأيام | المخاطر | الإجراء الموصى |
|--------|---------|----------------|
| > 120 | > 85 | قائمة سوداء + قضية 🔴 |
| > 90 | > 70 | رفع قضية قانونية 🔴 |
| > 60 | > 60 | إنذار رسمي 🟠 |
| > 30 | > 50 | إرسال تنبيه 🟡 |
| < 30 | < 50 | مراقبة 🟢 |

---

## 🎨 تصميم الواجهة | UI Design

### هيكل الصفحة

```
متابعة القضايا القانونية
├── تبويبة 1: قضايا قانونية (موجودة)
└── تبويبة 2: عملاء متأخرين (جديدة) 🆕
    │
    ├── قسم 1: البطاقات الملخصة (4 بطاقات)
    │   ├── إجمالي العملاء المتأخرين
    │   ├── المبالغ المعرضة للخطر
    │   ├── الغرامات المتراكمة
    │   └── عملاء عالي المخاطر
    │
    ├── قسم 2: الفلترة والإجراءات
    │   ├── البحث النصي
    │   ├── فلتر فترة التأخير
    │   ├── فلتر مستوى المخاطر
    │   └── إجراءات سريعة جماعية
    │
    └── قسم 3: جدول العملاء المتأخرين
        └── 13 عمود بيانات شاملة
```

### جدول العملاء (13 عمود)

| العميل | الاتصال | العقد | المركبة | أشهر | إيجارات | غرامات | مخالفات | الإجمالي | أيام | مخاطر | إجراء | أزرار |
|--------|---------|-------|---------|------|---------|---------|---------|---------|------|-------|-------|-------|
| شركة الخليج 🔴 | +965xxx | CT-001 | ABC-123 | **4** | 40,000 | 1,800 | 2,500 | **44,300** | 95 | **72** 🔴 | رفع قضية | 👁️⚖️📧 |

---

## 💻 البنية التقنية | Technical Architecture

### المكونات الجديدة (12 ملف)

```
src/
├── hooks/
│   ├── useDelinquentCustomers.ts      (250 سطر) 🆕
│   ├── useDelinquencyStats.ts         (100 سطر) 🆕
│   ├── useConvertToLegalCase.ts       (150 سطر) 🆕
│   └── useBulkLegalActions.ts         (300 سطر) 🆕
│
├── components/legal/
│   ├── DelinquentCustomersTab.tsx      (400 سطر) 🆕
│   ├── DelinquentSummaryCards.tsx      (150 سطر) 🆕
│   ├── DelinquentCustomersTable.tsx    (350 سطر) 🆕
│   ├── RiskScoreIndicator.tsx          (80 سطر) 🆕
│   ├── RecommendedActionBadge.tsx      (70 سطر) 🆕
│   ├── ConvertToCaseDialog.tsx         (250 سطر) 🆕
│   └── BulkActionsPanel.tsx            (200 سطر) 🆕
│
└── utils/
    └── delinquency-calculations.ts     (150 سطر) 🆕

الإجمالي: ~2,450 سطر من الكود الجديد
```

### مصادر البيانات

```sql
-- الجداول المستخدمة
- contracts          (العقود النشطة)
- payments           (سجل الدفعات)
- customers          (بيانات العملاء)
- traffic_violations (المخالفات المرورية)
- invoices           (الفواتير)
- legal_cases        (القضايا السابقة)
```

---

## 🔄 سير العمل | Workflows

### سيناريو 1: عرض العملاء المتأخرين

```
1. المستخدم يذهب إلى "متابعة القضايا"
2. ينقر على تبويبة "عملاء متأخرين"
3. النظام تلقائياً:
   ✅ يجلب جميع العقود النشطة
   ✅ يطابق مع سجل الدفعات
   ✅ يحدد العملاء المتأخرين
   ✅ يحسب جميع المقاييس
   ✅ يعرض في الجدول
4. المستخدم يرى:
   - 4 بطاقات ملخصة
   - جدول قابل للفلترة
   - مؤشرات المخاطر ملونة
   - توصيات تلقائية
```

### سيناريو 2: التحويل إلى قضية

```
1. المستخدم يختار عميل عالي المخاطر
2. ينقر زر "إنشاء قضية"
3. يفتح حوار مملوء مسبقاً:
   
   ┌────────────────────────────────────────┐
   │ إنشاء قضية قانونية                    │
   ├────────────────────────────────────────┤
   │ العنوان: تحصيل إيجارات من شركة الخليج │
   │ النوع: مدني                            │
   │ الأولوية: عالية (حسب درجة المخاطر)    │
   │ العميل: شركة الخليج                   │
   │ القيمة: 44,300 د.ك                    │
   │                                        │
   │ الوصف التلقائي:                        │
   │ ┌────────────────────────────────────┐ │
   │ │ قضية تحصيل إيجارات متأخرة         │ │
   │ │                                    │ │
   │ │ تفاصيل المديونية:                  │ │
   │ │ • الأشهر المتأخرة: 4 أشهر         │ │
   │ │ • الإيجارات: 40,000 د.ك           │ │
   │ │ • الغرامات: 1,800 د.ك             │ │
   │ │ • المخالفات: 2,500 د.ك (3)        │ │
   │ │ • الإجمالي: 44,300 د.ك            │ │
   │ │                                    │ │
   │ │ أيام التأخير: 95 يوم              │ │
   │ │ درجة المخاطر: 72 (عالي)           │ │
   │ └────────────────────────────────────┘ │
   │                                        │
   │ [إلغاء]              [إنشاء القضية]  │
   └────────────────────────────────────────┘

4. النظام ينشئ القضية تلقائياً
5. يحدث حالة العميل إلى "تحت التقاضي"
```

### سيناريو 3: العمليات الجماعية

```
1. فلترة العملاء عالي المخاطر
2. تحديد 12 عميل
3. نقر "إنشاء قضايا جماعي"
4. تأكيد:
   - عدد القضايا: 12
   - إجمالي المبالغ: 245,600 د.ك
   - متوسط المخاطر: 74
5. النظام ينشئ جميع القضايا
6. عرض تقرير الإنجاز
```

---

## 📝 خطة التنفيذ | Implementation Plan

### المرحلة 1: الأساسيات (6 ساعات)

**المهام**:
- ✅ إنشاء `useDelinquentCustomers` hook
- ✅ إنشاء `useDelinquencyStats` hook
- ✅ تطبيق خوارزميات الحساب
- ✅ إنشاء TypeScript interfaces

**المخرجات**: 3 ملفات (~600 سطر)

### المرحلة 2: الواجهات (8 ساعات)

**المهام**:
- ✅ تعديل `LegalCasesTracking.tsx`
- ✅ إنشاء `DelinquentCustomersTab.tsx`
- ✅ إنشاء بطاقات الملخص
- ✅ إنشاء جدول العملاء
- ✅ إنشاء مؤشرات المخاطر

**المخرجات**: 6 مكونات (~800 سطر)

### المرحلة 3: الميزات المتقدمة (6 ساعات)

**المهام**:
- ✅ حوار التحويل إلى قضية
- ✅ نظام الفلترة
- ✅ تصدير التقارير
- ✅ التكامل مع Legal AI

**المخرجات**: 3 مكونات (~500 سطر)

### المرحلة 4: العمليات الجماعية (5 ساعات)

**المهام**:
- ✅ لوحة العمليات الجماعية
- ✅ Hook للعمليات الجماعية
- ✅ نظام الإشعارات

**المخرجات**: 2 ملفات (~500 سطر)

### المرحلة 5: الاختبار (4 ساعات)

**المهام**:
- ✅ اختبار الحسابات
- ✅ اختبار سير العمل
- ✅ تحسين UI/UX
- ✅ إصلاح الأخطاء

### المرحلة 6: التوثيق (2 ساعة)

**المهام**:
- ✅ دليل المستخدم
- ✅ التوثيق التقني

**إجمالي الوقت المقدر: 3 أيام عمل**

---

## 🎯 الفوائد المتوقعة | Expected Benefits

### فوائد تجارية

| الفائدة | التحسين |
|---------|---------|
| توفير الوقت | **80%** تقليل في وقت تحديد المتأخرين |
| سرعة الإجراءات | من **يومين إلى دقائق** لرفع قضية |
| دقة البيانات | **100%** دقة في الحسابات |
| زيادة التحصيل | **30-40%** تحسن متوقع |
| تقليل المخاطر | تحديد مبكر للمشاكل |

### فوائد تقنية

- ✅ كود نظيف ومنظم
- ✅ قابل للتوسع
- ✅ موثق بالكامل
- ✅ TypeScript آمن
- ✅ تكامل سلس مع الأنظمة الموجودة

---

## ✅ قائمة التحقق | Checklist

### المميزات الأساسية
- [ ] عرض العملاء المتأخرين تلقائياً
- [ ] حساب عدد الأشهر المتأخرة
- [ ] حساب إجمالي الإيجارات المستحقة
- [ ] حساب غرامات التأخير
- [ ] عرض المخالفات المرورية
- [ ] التحويل السريع إلى قضية

### المميزات الإضافية
- [ ] نظام تقييم المخاطر (0-100)
- [ ] التوصيات الذكية
- [ ] لوحة الأثر المالي
- [ ] العمليات الجماعية
- [ ] الإنذارات التلقائية بالـ AI
- [ ] تتبع الجدول الزمني
- [ ] حاسبة الجدوى (ROI)
- [ ] التنبيهات الذكية
- [ ] تصدير Excel/PDF

### التكامل
- [ ] تكامل مع نظام العقود
- [ ] تكامل مع نظام الدفعات
- [ ] تكامل مع نظام المخالفات
- [ ] تكامل مع Legal AI
- [ ] تكامل مع نظام القضايا

---

## 📊 مثال بيانات الجدول | Sample Table Data

```
┌────────────────────────────────────────────────────────────────────────────┐
│ العميل         │ العقد  │ المركبة │ أشهر │ إيجارات │ غرامات │ مخالفات │...│
├────────────────────────────────────────────────────────────────────────────┤
│ شركة الخليج 🔴 │ CT-001 │ ABC-123 │  4   │ 40,000  │ 1,800  │ 2,500   │...│
│ محمد أحمد 🟠   │ CT-002 │ DEF-456 │  2   │ 10,000  │  450   │    0    │...│
│ شركة النور 🟡  │ CT-003 │ GHI-789 │  1   │  5,000  │  100   │  500    │...│
│ سالم خالد 🟢   │ CT-004 │ JKL-012 │  1   │  3,000  │   60   │    0    │...│
└────────────────────────────────────────────────────────────────────────────┘

│... الإجمالي │ أيام │ مخاطر │ الإجراء الموصى │ أزرار      │
├──────────────────────────────────────────────────────────────┤
│   44,300    │  95  │ 72 🔴  │ رفع قضية       │ 👁️ ⚖️ 📧   │
│   10,450    │  65  │ 58 🟠  │ إنذار رسمي     │ 👁️ ⚠️ 📧   │
│    5,600    │  35  │ 42 🟡  │ إرسال تنبيه    │ 👁️ 📧      │
│    3,060    │  32  │ 28 🟢  │ مراقبة         │ 👁️         │
└──────────────────────────────────────────────────────────────┘
```

---

## 🚀 الخطوات التالية | Next Steps

### للموافقة والبدء:
1. ✅ مراجعة هذه الخطة
2. ✅ الموافقة على المميزات
3. ✅ الموافقة على التصميم
4. ✅ البدء في التنفيذ

### بعد الموافقة سأقوم بـ:
1. إنشاء جميع الملفات المطلوبة
2. تطبيق جميع الخوارزميات
3. بناء الواجهات الكاملة
4. الاختبار الشامل
5. التوثيق الكامل

---

## 💡 ملاحظات إضافية

### نقاط قوة الخطة:
- ✅ تلبي جميع المتطلبات الأساسية
- ✅ تضيف قيمة كبيرة بمميزات ذكية
- ✅ تصميم احترافي وسهل الاستخدام
- ✅ قابلة للتوسع مستقبلاً
- ✅ تكامل سلس مع الأنظمة الموجودة

### التقنيات المستخدمة:
- React + TypeScript
- React Query للبيانات
- Tailwind CSS للتصميم
- Supabase للقاعدة
- shadcn/ui للمكونات

---

**هل توافق على هذه الخطة للبدء في التنفيذ؟** ✅

_آخر تحديث: 2025-10-25_