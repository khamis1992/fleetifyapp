// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';
import { getSupabaseConfig, debugLog, securityLog } from '@/lib/env';
import { createCapacitorStorageAdapter } from '@/lib/capacitorStorage';

// Get Supabase configuration securely
let supabaseConfig: ReturnType<typeof getSupabaseConfig>;

try {
  supabaseConfig = getSupabaseConfig();
  debugLog('Supabase config loaded successfully', {
    hasUrl: !!supabaseConfig.url,
    hasKey: !!supabaseConfig.anonKey
  });
} catch (error) {
  console.error('‚ùå [SUPABASE] Failed to load Supabase configuration:', error);
  throw error;
}

// Validate configuration
if (!supabaseConfig.url || !supabaseConfig.anonKey) {
  const error = 'Missing required Supabase configuration';
  securityLog(error, {
    hasUrl: !!supabaseConfig.url,
    hasKey: !!supabaseConfig.anonKey
  });
  throw new Error(error);
}

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(supabaseConfig.url, supabaseConfig.anonKey, {
  auth: {
    storage: createCapacitorStorageAdapter(),
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
    flowType: 'pkce',
    // Enable cross-tab sync via BroadcastChannel API
    // By not specifying storageKey, Supabase will handle multi-tab sync automatically
  },
  // Add retry logic for better reliability
  global: {
    headers: { 'x-client-info': 'fleetify-web' },
    fetch: (url, options) => {
      // Add timeout to prevent hanging requests
      // Log requests that take too long
      const timeoutMs = 15000; // Increased to 15s to be safe
      return Promise.race([
        fetch(url, options),
        new Promise((_, reject) =>
          setTimeout(() => {
            console.warn(`[SUPABASE] Request timed out after ${timeoutMs}ms:`, url);
            reject(new Error('Request timeout'));
          }, timeoutMs)
        )
      ]);
    },
  },
  // Realtime configuration for better performance
  realtime: {
    params: {
      eventsPerSecond: 10,
    },
  },
});

// Export configuration for secure access if needed
export { supabaseConfig };