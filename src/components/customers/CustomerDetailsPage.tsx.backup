/**
 * Customer Details Profile Page - Professional SaaS Redesign
 * Modern Stripe/Linear/Vercel inspired design with refined animations
 *
 * @component CustomerDetailsPage
 */

import { useState, useMemo, useCallback, useEffect, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { supabase } from '@/integrations/supabase/client';
import { useUnifiedCompanyAccess } from '@/hooks/useUnifiedCompanyAccess';
import { PageSkeletonFallback } from '@/components/common/LazyPageWrapper';
import {
  useCustomerDocuments,
  useUploadCustomerDocument,
  useDeleteCustomerDocument,
  useDownloadCustomerDocument
} from '@/hooks/useCustomerDocuments';
import { useCustomerCRMActivity, CustomerActivity, AddActivityInput } from '@/hooks/useCustomerCRMActivity';
import { format, differenceInDays } from 'date-fns';
import { ar } from 'date-fns/locale';
import { motion, AnimatePresence } from 'framer-motion';
import {
  ArrowRight,
  Bell,
  Settings,
  Edit3,
  FileText,
  Archive,
  Trash2,
  CheckCircle,
  Hash,
  Calendar,
  Clock,
  Mail,
  Phone,
  MapPin,
  Cake,
  CreditCard,
  Briefcase,
  User,
  Wallet,
  TrendingUp,
  Car,
  Plus,
  Eye,
  RefreshCw,
  Star,
  Landmark,
  Banknote,
  Smartphone,
  ChevronRight,
  ChevronLeft,
  Download,
  Upload,
  Folder,
  Activity,
  AlertTriangle,
  FileX,
  Sparkles,
  Shield,
  MessageSquare,
  PhoneCall,
  Globe,
  Building2,
  IdCard,
  FileImage,
  MoreVertical,
  Printer,
  Share2,
  Send,
  PhoneOff,
  PhoneIncoming,
  Loader2,
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Progress } from '@/components/ui/progress';
import { Textarea } from '@/components/ui/textarea';
import { useToast } from '@/components/ui/use-toast';
import { cn } from '@/lib/utils';
import { UnifiedPaymentForm } from '@/components/finance/UnifiedPaymentForm';
import { EnhancedCustomerForm } from '@/components/customers/EnhancedCustomerForm';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';

// Animation variants
const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      delayChildren: 0.2,
    },
  },
};

const itemVariants = {
  hidden: { opacity: 0, y: 20 },
  visible: {
    opacity: 1,
    y: 0,
    transition: {
      type: 'spring',
      stiffness: 300,
      damping: 24,
    },
  },
};

const fadeInUp = {
  hidden: { opacity: 0, y: 30 },
  visible: {
    opacity: 1,
    y: 0,
    transition: {
      type: 'spring',
      stiffness: 200,
      damping: 20,
    },
  },
};

const scaleIn = {
  hidden: { opacity: 0, scale: 0.9 },
  visible: {
    opacity: 1,
    scale: 1,
    transition: {
      type: 'spring',
      stiffness: 200,
      damping: 15,
    },
  },
};

// ===== Helper Functions =====

// Validate Qatari QID (11 digits)
const isValidQatarQID = (qid: string | null | undefined): boolean => {
  if (!qid) return false;
  const cleanQID = qid.replace(/\D/g, '');
  return cleanQID.length === 11;
};

// Validate Qatari phone number (starts with 3, 5, 6, 7)
const isValidQatarPhone = (phone: string | null | undefined): boolean => {
  if (!phone) return false;
  const cleanPhone = phone.replace(/\D/g, '');
  if (cleanPhone.startsWith('974')) {
    const localNumber = cleanPhone.substring(3);
    return localNumber.length === 8 && /^[3567]/.test(localNumber);
  }
  return cleanPhone.length === 8 && /^[3567]/.test(cleanPhone);
};

// ===== Components =====

// MissingDataWarnings Component
const MissingDataWarnings = ({ customer }: { customer: any }) => {
  const { missingFields, invalidFields } = useMemo(() => {
    const missing: { label: string; priority: 'high' | 'medium' | 'low' }[] = [];
    const invalid: { label: string; value: string }[] = [];

    if (!customer.national_id && !customer.qid) {
      missing.push({ label: 'Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ© / QID', priority: 'high' });
    } else {
      const qid = customer.qid || customer.national_id;
      if (qid && !isValidQatarQID(qid)) {
        invalid.push({ label: 'QID ØºÙŠØ± ØµØ­ÙŠØ­', value: qid });
      }
    }
    if (!customer.driver_license) {
      missing.push({ label: 'Ø±Ø®ØµØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©', priority: 'high' });
    }

    if (customer.phone && !isValidQatarPhone(customer.phone)) {
      invalid.push({ label: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù‚ÙŠØ§Ø³ÙŠ', value: customer.phone });
    }

    if (!customer.address) {
      missing.push({ label: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', priority: 'medium' });
    }
    if (!customer.email) {
      missing.push({ label: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', priority: 'medium' });
    }
    if (!customer.date_of_birth) {
      missing.push({ label: 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯', priority: 'low' });
    }

    return { missingFields: missing, invalidFields: invalid };
  }, [customer]);

  if (missingFields.length === 0 && invalidFields.length === 0) return null;

  const highPriorityCount = missingFields.filter(f => f.priority === 'high').length;
  const hasIssues = highPriorityCount > 0 || invalidFields.length > 0;

  return (
    <motion.div
      initial={{ opacity: 0, y: -10 }}
      animate={{ opacity: 1, y: 0 }}
      className={cn(
        "mb-4 p-4 rounded-xl border flex items-start gap-3",
        hasIssues ? "bg-amber-50 border-amber-200" : "bg-blue-50 border-blue-200"
      )}
    >
      <AlertTriangle className={cn(
        "w-5 h-5 mt-0.5",
        hasIssues ? "text-amber-500" : "text-blue-500"
      )} />
      <div className="flex-1">
        {missingFields.length > 0 && (
          <>
            <h4 className={cn(
              "text-sm font-bold mb-1",
              hasIssues ? "text-amber-800" : "text-blue-800"
            )}>
              Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ© ({missingFields.length})
            </h4>
            <div className="flex flex-wrap gap-2 mb-2">
              {missingFields.map((field, idx) => (
                <Badge
                  key={idx}
                  className={cn(
                    "text-xs",
                    field.priority === 'high' ? "bg-red-100 text-red-700" :
                    field.priority === 'medium' ? "bg-amber-100 text-amber-700" :
                    "bg-neutral-100 text-neutral-600"
                  )}
                >
                  {field.label}
                </Badge>
              ))}
            </div>
          </>
        )}
        {invalidFields.length > 0 && (
          <>
            <h4 className="text-sm font-bold mb-1 text-orange-800">
              Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© ({invalidFields.length})
            </h4>
            <div className="flex flex-wrap gap-2">
              {invalidFields.map((field, idx) => (
                <Badge key={idx} className="text-xs bg-orange-100 text-orange-700">
                  {field.label}
                </Badge>
              ))}
            </div>
          </>
        )}
      </div>
    </motion.div>
  );
};

// Empty State Component
const EmptyState = ({
  icon: Icon,
  title,
  description,
  action
}: {
  icon: any;
  title: string;
  description: string;
  action?: React.ReactNode;
}) => (
  <motion.div
    variants={scaleIn}
    initial="hidden"
    animate="visible"
    className="flex flex-col items-center justify-center py-16 px-6 text-center"
  >
    <div className="relative mb-6">
      <div className="absolute inset-0 bg-gradient-to-br from-rose-500/20 to-rose-600/20 rounded-full blur-3xl" />
      <div className="relative w-20 h-20 rounded-2xl bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 flex items-center justify-center border border-slate-200 dark:border-slate-700">
        <Icon className="w-10 h-10 text-slate-400" strokeWidth={1.5} />
      </div>
    </div>
    <h3 className="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-2">
      {title}
    </h3>
    <p className="text-sm text-slate-500 dark:text-slate-400 max-w-sm mb-6">
      {description}
    </p>
    {action}
  </motion.div>
);

// Stats Card Component
const StatsCard = ({
  icon: Icon,
  label,
  value,
  gradient,
  iconBg,
  trend,
  suffix,
  progress
}: {
  icon: any;
  label: string;
  value: string | number;
  gradient: string;
  iconBg: string;
  trend?: string;
  suffix?: string;
  progress?: number;
}) => (
  <motion.div
    variants={itemVariants}
    whileHover={{ y: -4, transition: { duration: 0.2 } }}
    className="relative group"
  >
    <div className="absolute inset-0 bg-gradient-to-br from-rose-500/0 to-rose-600/0 group-hover:from-rose-500/5 group-hover:to-rose-600/5 rounded-2xl transition-all duration-300" />
    <div className="relative bg-white dark:bg-slate-900 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-xl transition-all duration-300">
      <div className={cn(
        "w-14 h-14 rounded-2xl flex items-center justify-center mb-4",
        iconBg
      )}>
        <Icon className={cn("w-7 h-7", gradient)} strokeWidth={2} />
      </div>
      <div className="mb-1">
        <span className="text-3xl font-bold bg-gradient-to-br from-slate-900 to-slate-600 dark:from-slate-100 dark:to-slate-400 bg-clip-text text-transparent">
          {value}
        </span>
        {suffix && (
          <span className="text-sm font-medium text-slate-500 dark:text-slate-400 mr-2">
            {suffix}
          </span>
        )}
      </div>
      <div className="text-sm font-medium text-slate-600 dark:text-slate-400 mb-3">
        {label}
      </div>
      {progress !== undefined && (
        <div className="mt-4">
          <Progress value={progress} className="h-1.5 bg-slate-100 dark:bg-slate-800" />
        </div>
      )}
      {trend && (
        <div className="mt-3 text-xs text-slate-500 dark:text-slate-400">
          {trend}
        </div>
      )}
    </div>
  </motion.div>
);

// Info Item Component
const InfoItem = ({
  icon: Icon,
  label,
  value,
  iconBg,
  iconGradient
}: {
  icon: any;
  label: string;
  value: string | number;
  iconBg: string;
  iconGradient: string;
}) => (
  <motion.div
    variants={itemVariants}
    whileHover={{ scale: 1.02 }}
    className="group"
  >
    <div className="flex items-start gap-4 p-4 rounded-2xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 hover:border-rose-200 dark:hover:border-rose-800 hover:shadow-md transition-all duration-200">
      <div className={cn("w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0", iconBg)}>
        <Icon className={cn("w-5 h-5", iconGradient)} strokeWidth={2} />
      </div>
      <div className="flex-1 min-w-0">
        <div className="text-xs font-medium text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wide">
          {label}
        </div>
        <div className="text-sm font-semibold text-slate-900 dark:text-slate-100 truncate">
          {value || '-'}
        </div>
      </div>
    </div>
  </motion.div>
);

// ===== Tab Components =====

// Personal Info Tab Component
const PersonalInfoTab = ({ customer }: { customer: any }) => {
  const infoItems = [
    { label: 'ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„', value: customer.employer || '-', icon: Building2 },
    { label: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©', value: customer.group_name || 'Ø¹Ù…ÙŠÙ„ Ø¹Ø§Ø¯ÙŠ', icon: User },
    { label: 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„', value: `${customer.first_name_ar || customer.first_name || ''} ${customer.last_name_ar || customer.last_name || ''}`.trim() || '-', icon: User },
    { label: 'Ø§Ù„Ù…Ù†ØµØ¨', value: customer.job_title || '-', icon: Briefcase },
    { label: 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„', value: customer.first_name_ar || customer.first_name || '-', icon: User },
    { label: 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆØ³Ø·', value: customer.middle_name || '-', icon: User },
    { label: 'Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©', value: customer.last_name_ar || customer.last_name || '-', icon: User },
  ];

  const addressItems = [
    { label: 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙÙŠØ¯Ø±Ø§Ù„ÙŠ', value: customer.national_id || '-' },
    { label: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† 1', value: customer.address || '-' },
    { label: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† 2', value: customer.address_2 || '-' },
    { label: 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', value: customer.city || '-' },
    { label: 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', value: customer.state || '-' },
    { label: 'Ø§Ù„Ø¨Ù„Ø¯', value: customer.country || 'Ù‚Ø·Ø±' },
    { label: 'Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ', value: customer.postal_code || '-' },
  ];

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      className="grid grid-cols-1 lg:grid-cols-2 gap-6"
    >
      <div className="bg-white dark:bg-slate-900 rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
        <h4 className="text-sm font-bold text-slate-900 dark:text-slate-100 mb-4">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h4>
        <div className="grid grid-cols-2 gap-4">
          {infoItems.map((item, index) => (
            <div key={index} className="space-y-1">
              <p className="text-xs text-slate-500 dark:text-slate-400">{item.label}</p>
              <p className="text-sm font-semibold text-slate-900 dark:text-slate-100">{item.value}</p>
            </div>
          ))}
        </div>
      </div>

      <div className="bg-white dark:bg-slate-900 rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
        <h4 className="text-sm font-bold text-slate-900 dark:text-slate-100 mb-4">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</h4>
        <div className="grid grid-cols-2 gap-4">
          {addressItems.map((item, index) => (
            <div key={index} className="space-y-1">
              <p className="text-xs text-slate-500 dark:text-slate-400">{item.label}</p>
              <p className="text-sm font-semibold text-slate-900 dark:text-slate-100">{item.value}</p>
            </div>
          ))}
        </div>
      </div>
    </motion.div>
  );
};

// Phone Numbers Tab Component
const PhoneNumbersTab = ({ customer }: { customer: any }) => {
  const phones = [
    { type: 'Ø±Ø¦ÙŠØ³ÙŠ', number: customer.phone, icon: Phone },
    { type: 'Ø«Ø§Ù†ÙˆÙŠ', number: customer.secondary_phone || '-', icon: Phone },
    { type: 'Ø¹Ù…Ù„', number: customer.work_phone || '-', icon: Briefcase },
    { type: 'ÙˆØ§ØªØ³Ø§Ø¨', number: customer.whatsapp || customer.phone || '-', icon: MessageSquare },
  ];

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      className="bg-white dark:bg-slate-900 rounded-2xl p-6 border border-slate-200 dark:border-slate-700"
    >
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {phones.map((phone, index) => {
          const isValid = phone.number !== '-' && isValidQatarPhone(phone.number);
          const hasNumber = phone.number && phone.number !== '-';

          return (
            <div
              key={index}
              className={cn(
                "p-4 rounded-xl border transition-colors",
                hasNumber && !isValid
                  ? "bg-amber-50 dark:bg-amber-950/20 border-amber-200 dark:border-amber-800"
                  : "bg-slate-50 dark:bg-slate-900/50 border-slate-200 dark:border-slate-700 hover:border-rose-200 dark:hover:border-rose-800"
              )}
            >
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-3">
                  <div className={cn(
                    "w-10 h-10 rounded-xl flex items-center justify-center",
                    hasNumber && !isValid ? "bg-amber-100 dark:bg-amber-900/30" : "bg-rose-100 dark:bg-rose-900/30"
                  )}>
                    <phone.icon className={cn(
                      "w-5 h-5",
                      hasNumber && !isValid ? "text-amber-600 dark:text-amber-400" : "text-rose-600 dark:text-rose-400"
                    )} />
                  </div>
                  <span className="text-xs font-medium text-slate-500 dark:text-slate-400">{phone.type}</span>
                </div>
                {hasNumber && (
                  <Badge className={cn(
                    "text-[10px]",
                    isValid ? "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400" : "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400"
                  )}>
                    {isValid ? 'ØµØ­ÙŠØ­' : 'ØºÙŠØ± Ù‚ÙŠØ§Ø³ÙŠ'}
                  </Badge>
                )}
              </div>
              <p className="text-lg font-bold text-slate-900 dark:text-slate-100 font-mono" dir="ltr">
                {phone.number}
              </p>
              {phone.number !== '-' && (
                <div className="flex gap-2 mt-2">
                  <Button
                    variant="ghost"
                    size="sm"
                    className="text-rose-600 hover:text-rose-700 dark:text-rose-400 p-0 h-auto"
                    onClick={() => window.open(`tel:${phone.number}`, '_self')}
                  >
                    <PhoneCall className="w-4 h-4 mr-1" />
                    Ø§ØªØµØ§Ù„
                  </Button>
                  <Button
                    variant="ghost"
                    size="sm"
                    className="text-emerald-600 hover:text-emerald-700 dark:text-emerald-400 p-0 h-auto"
                    onClick={() => window.open(`https://wa.me/${phone.number.replace(/[^0-9]/g, '')}`, '_blank')}
                  >
                    <MessageSquare className="w-4 h-4 mr-1" />
                    ÙˆØ§ØªØ³Ø§Ø¨
                  </Button>
                </div>
              )}
            </div>
          );
        })}
      </div>
    </motion.div>
  );
};

// Notes Tab Component - CRM Integration
const NotesTab = ({ customerId, customerPhone }: { customerId: string; customerPhone?: string }) => {
  const [newNote, setNewNote] = useState('');
  const [noteType, setNoteType] = useState<'note' | 'phone' | 'whatsapp'>('note');
  const [isAdding, setIsAdding] = useState(false);

  const { activities, isLoading, addActivity, isAddingActivity } = useCustomerCRMActivity(customerId);

  const handleAddNote = async () => {
    if (!newNote.trim()) return;

    try {
      await addActivity({
        note_type: noteType,
        content: newNote,
        title: noteType === 'phone' ? 'Ù…ÙƒØ§Ù„Ù…Ø© Ù‡Ø§ØªÙÙŠØ©' : noteType === 'whatsapp' ? 'Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨' : 'Ù…Ù„Ø§Ø­Ø¸Ø©',
      });
      setNewNote('');
      setIsAdding(false);
    } catch (error) {
      console.error('Error adding note:', error);
    }
  };

  const getActivityIcon = (type: string, status?: string) => {
    switch (type) {
      case 'phone':
      case 'call':
        if (status === 'no_answer') return <PhoneOff className="w-4 h-4 text-red-500" />;
        if (status === 'busy') return <PhoneIncoming className="w-4 h-4 text-amber-500" />;
        return <Phone className="w-4 h-4 text-emerald-500" />;
      case 'whatsapp':
        return <MessageSquare className="w-4 h-4 text-emerald-500" />;
      case 'email':
        return <Mail className="w-4 h-4 text-blue-500" />;
      case 'followup':
        return <Bell className="w-4 h-4 text-amber-500" />;
      default:
        return <FileText className="w-4 h-4 text-slate-500" />;
    }
  };

  const getActivityLabel = (type: string) => {
    switch (type) {
      case 'phone':
      case 'call': return 'Ù…ÙƒØ§Ù„Ù…Ø©';
      case 'whatsapp': return 'ÙˆØ§ØªØ³Ø§Ø¨';
      case 'email': return 'Ø¨Ø±ÙŠØ¯';
      case 'note': return 'Ù…Ù„Ø§Ø­Ø¸Ø©';
      case 'followup': return 'Ù…ØªØ§Ø¨Ø¹Ø©';
      default: return 'ØªÙØ§Ø¹Ù„';
    }
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      className="space-y-4"
    >
      <div className="bg-white dark:bg-slate-900 rounded-2xl p-4 border border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h4 className="text-sm font-bold text-slate-900 dark:text-slate-100">Ø³Ø¬Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h4>
            <p className="text-xs text-slate-500 dark:text-slate-400">{activities.length} ØªÙØ§Ø¹Ù„ Ù…Ø³Ø¬Ù„</p>
          </div>
          <div className="flex items-center gap-2">
            {customerPhone && (
              <>
                <Button
                  variant="outline"
                  size="sm"
                  className="gap-2"
                  onClick={() => window.open(`tel:${customerPhone}`)}
                >
                  <Phone className="w-4 h-4" />
                  Ø§ØªØµØ§Ù„
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  className="gap-2 text-emerald-600 border-emerald-200 hover:bg-emerald-50 dark:text-emerald-400 dark:border-emerald-800"
                  onClick={() => window.open(`https://wa.me/${customerPhone.replace(/[^0-9]/g, '')}`)}
                >
                  <MessageSquare className="w-4 h-4" />
                  ÙˆØ§ØªØ³Ø§Ø¨
                </Button>
              </>
            )}
            <Button
              size="sm"
              className="gap-2 bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700"
              onClick={() => setIsAdding(!isAdding)}
            >
              <Plus className="w-4 h-4" />
              Ø¥Ø¶Ø§ÙØ©
            </Button>
          </div>
        </div>

        <AnimatePresence>
          {isAdding && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              exit={{ opacity: 0, height: 0 }}
              className="border-t border-slate-100 dark:border-slate-800 pt-4"
            >
              <div className="flex gap-2 mb-3">
                <Button
                  variant={noteType === 'note' ? 'default' : 'outline'}
                  size="sm"
                  onClick={() => setNoteType('note')}
                  className={noteType === 'note' ? 'bg-gradient-to-r from-rose-500 to-rose-600' : ''}
                >
                  <FileText className="w-4 h-4 ml-1" />
                  Ù…Ù„Ø§Ø­Ø¸Ø©
                </Button>
                <Button
                  variant={noteType === 'phone' ? 'default' : 'outline'}
                  size="sm"
                  onClick={() => setNoteType('phone')}
                  className={noteType === 'phone' ? 'bg-emerald-500' : ''}
                >
                  <Phone className="w-4 h-4 ml-1" />
                  Ù…ÙƒØ§Ù„Ù…Ø©
                </Button>
                <Button
                  variant={noteType === 'whatsapp' ? 'default' : 'outline'}
                  size="sm"
                  onClick={() => setNoteType('whatsapp')}
                  className={noteType === 'whatsapp' ? 'bg-emerald-600' : ''}
                >
                  <MessageSquare className="w-4 h-4 ml-1" />
                  ÙˆØ§ØªØ³Ø§Ø¨
                </Button>
              </div>
              <Textarea
                value={newNote}
                onChange={(e) => setNewNote(e.target.value)}
                placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ù‡Ù†Ø§..."
                className="min-h-[100px] mb-3"
              />
              <div className="flex justify-end gap-2">
                <Button variant="outline" size="sm" onClick={() => setIsAdding(false)}>
                  Ø¥Ù„ØºØ§Ø¡
                </Button>
                <Button
                  size="sm"
                  className="gap-2 bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700"
                  onClick={handleAddNote}
                  disabled={!newNote.trim() || isAddingActivity}
                >
                  {isAddingActivity ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <Send className="w-4 h-4" />
                  )}
                  Ø­ÙØ¸
                </Button>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </div>

      {isLoading ? (
        <div className="flex items-center justify-center py-12">
          <RefreshCw className="w-6 h-6 animate-spin text-slate-400" />
        </div>
      ) : activities.length > 0 ? (
        <div className="relative">
          <div className="absolute right-6 top-0 bottom-0 w-0.5 bg-slate-200 dark:bg-slate-700" />
          <div className="space-y-3">
            {activities.map((activity, index) => (
              <motion.div
                key={activity.id}
                initial={{ opacity: 0, x: -20 }}
                animate={{ opacity: 1, x: 0 }}
                transition={{ delay: index * 0.05 }}
                className="relative pr-14"
              >
                <div className="absolute right-4 w-5 h-5 rounded-full bg-white dark:bg-slate-900 border-2 border-rose-300 flex items-center justify-center shadow-sm">
                  {getActivityIcon(activity.note_type, activity.call_status)}
                </div>
                <div className="bg-white dark:bg-slate-900 rounded-xl p-4 border border-slate-200 dark:border-slate-700 hover:border-rose-200 dark:hover:border-rose-800 transition-colors">
                  <div className="flex items-start justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <Badge variant="outline" className="text-xs">
                        {getActivityLabel(activity.note_type)}
                      </Badge>
                      {activity.is_important && (
                        <Badge className="text-xs bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400">Ù…Ù‡Ù…</Badge>
                      )}
                    </div>
                    <span className="text-xs text-slate-400">
                      {format(new Date(activity.created_at), 'dd MMM yyyy - HH:mm', { locale: ar })}
                    </span>
                  </div>
                  <p className="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap">{activity.content}</p>
                </div>
              </motion.div>
            ))}
          </div>
        </div>
      ) : (
        <div className="bg-slate-50 dark:bg-slate-900/50 rounded-2xl p-12 text-center border border-slate-200 dark:border-slate-700">
          <MessageSquare className="w-12 h-12 text-slate-300 mx-auto mb-3" />
          <p className="text-slate-600 dark:text-slate-400 font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>
          <p className="text-slate-400 text-sm mt-1">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ù…ÙƒØ§Ù„Ù…Ø©</p>
        </div>
      )}
    </motion.div>
  );
};

// Followups Tab Component
const FollowupsTab = ({ customerId, companyId }: { customerId: string; companyId: string }) => {
  const [isAdding, setIsAdding] = useState(false);
  const [newFollowup, setNewFollowup] = useState({
    title: '',
    notes: '',
    scheduled_date: '',
    priority: 'medium' as 'low' | 'medium' | 'high' | 'urgent'
  });

  const { data: followups, isLoading, refetch } = useQuery({
    queryKey: ['customer-followups', customerId],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('scheduled_followups')
        .select('*')
        .eq('customer_id', customerId)
        .eq('company_id', companyId)
        .order('scheduled_date', { ascending: true });

      if (error) throw error;
      return data || [];
    },
    enabled: !!customerId && !!companyId
  });

  const handleAddFollowup = async () => {
    if (!newFollowup.title.trim() || !newFollowup.scheduled_date) return;

    try {
      const { error } = await supabase
        .from('scheduled_followups')
        .insert({
          customer_id: customerId,
          company_id: companyId,
          title: newFollowup.title,
          notes: newFollowup.notes,
          scheduled_date: newFollowup.scheduled_date,
          priority: newFollowup.priority,
          status: 'pending'
        });

      if (error) throw error;

      setNewFollowup({ title: '', notes: '', scheduled_date: '', priority: 'medium' });
      setIsAdding(false);
      refetch();
    } catch (error) {
      console.error('Error adding followup:', error);
    }
  };

  const handleCompleteFollowup = async (followupId: string) => {
    try {
      const { error } = await supabase
        .from('scheduled_followups')
        .update({ status: 'completed', completed_at: new Date().toISOString() })
        .eq('id', followupId);

      if (error) throw error;
      refetch();
    } catch (error) {
      console.error('Error completing followup:', error);
    }
  };

  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'urgent': return 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-400 dark:border-red-800';
      case 'high': return 'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/30 dark:text-orange-400 dark:border-orange-800';
      case 'medium': return 'bg-amber-100 text-amber-700 border-amber-200 dark:bg-amber-900/30 dark:text-amber-400 dark:border-amber-800';
      default: return 'bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-400 dark:border-emerald-800';
    }
  };

  const getPriorityLabel = (priority: string) => {
    switch (priority) {
      case 'urgent': return 'Ø¹Ø§Ø¬Ù„';
      case 'high': return 'Ø¹Ø§Ù„ÙŠ';
      case 'medium': return 'Ù…ØªÙˆØ³Ø·';
      default: return 'Ù…Ù†Ø®ÙØ¶';
    }
  };

  const pendingFollowups = followups?.filter(f => f.status !== 'completed') || [];
  const completedFollowups = followups?.filter(f => f.status === 'completed') || [];

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      className="space-y-4"
    >
      <div className="bg-white dark:bg-slate-900 rounded-2xl p-4 border border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h4 className="text-sm font-bold text-slate-900 dark:text-slate-100">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©</h4>
            <p className="text-xs text-slate-500 dark:text-slate-400">{pendingFollowups.length} Ù…ØªØ§Ø¨Ø¹Ø© Ù‚Ø§Ø¯Ù…Ø©</p>
          </div>
          <Button
            size="sm"
            className="gap-2 bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700"
            onClick={() => setIsAdding(!isAdding)}
          >
            <Plus className="w-4 h-4" />
            Ø¥Ø¶Ø§ÙØ© Ù…ØªØ§Ø¨Ø¹Ø©
          </Button>
        </div>

        <AnimatePresence>
          {isAdding && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              exit={{ opacity: 0, height: 0 }}
              className="border-t border-slate-100 dark:border-slate-800 pt-4 space-y-3"
            >
              <div className="grid grid-cols-2 gap-3">
                <input
                  type="text"
                  value={newFollowup.title}
                  onChange={(e) => setNewFollowup(prev => ({ ...prev, title: e.target.value }))}
                  placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©..."
                  className="px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-rose-500 bg-white dark:bg-slate-900"
                />
                <input
                  type="datetime-local"
                  value={newFollowup.scheduled_date}
                  onChange={(e) => setNewFollowup(prev => ({ ...prev, scheduled_date: e.target.value }))}
                  className="px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-rose-500 bg-white dark:bg-slate-900"
                />
              </div>
              <div className="flex gap-2">
                {(['low', 'medium', 'high', 'urgent'] as const).map(priority => (
                  <Button
                    key={priority}
                    variant={newFollowup.priority === priority ? 'default' : 'outline'}
                    size="sm"
                    onClick={() => setNewFollowup(prev => ({ ...prev, priority }))}
                    className={newFollowup.priority === priority ? getPriorityColor(priority) : ''}
                  >
                    {getPriorityLabel(priority)}
                  </Button>
                ))}
              </div>
              <Textarea
                value={newFollowup.notes}
                onChange={(e) => setNewFollowup(prev => ({ ...prev, notes: e.target.value }))}
                placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."
                className="min-h-[80px]"
              />
              <div className="flex justify-end gap-2">
                <Button variant="outline" size="sm" onClick={() => setIsAdding(false)}>
                  Ø¥Ù„ØºØ§Ø¡
                </Button>
                <Button
                  size="sm"
                  className="gap-2 bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700"
                  onClick={handleAddFollowup}
                  disabled={!newFollowup.title.trim() || !newFollowup.scheduled_date}
                >
                  <Plus className="w-4 h-4" />
                  Ø­ÙØ¸ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                </Button>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </div>

      {isLoading ? (
        <div className="flex items-center justify-center py-12">
          <RefreshCw className="w-6 h-6 animate-spin text-slate-400" />
        </div>
      ) : pendingFollowups.length > 0 ? (
        <div className="space-y-3">
          {pendingFollowups.map((followup, index) => (
            <motion.div
              key={followup.id}
              initial={{ opacity: 0, x: -20 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: index * 0.05 }}
              className="bg-white dark:bg-slate-900 rounded-xl p-4 border border-slate-200 dark:border-slate-700 hover:border-rose-200 dark:hover:border-rose-800 transition-colors"
            >
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <div className="flex items-center gap-2 mb-2">
                    <Bell className="w-4 h-4 text-rose-500" />
                    <h5 className="font-medium text-slate-900 dark:text-slate-100">{followup.title}</h5>
                    <Badge className={cn("text-xs", getPriorityColor(followup.priority))}>
                      {getPriorityLabel(followup.priority)}
                    </Badge>
                  </div>
                  {followup.notes && (
                    <p className="text-sm text-slate-600 dark:text-slate-400 mb-2">{followup.notes}</p>
                  )}
                  <div className="flex items-center gap-4 text-xs text-slate-500 dark:text-slate-400">
                    <span className="flex items-center gap-1">
                      <Calendar className="w-3 h-3" />
                      {format(new Date(followup.scheduled_date), 'dd MMM yyyy - HH:mm', { locale: ar })}
                    </span>
                    {differenceInDays(new Date(followup.scheduled_date), new Date()) <= 0 && (
                      <Badge variant="destructive" className="text-xs">Ù…ØªØ£Ø®Ø±Ø©</Badge>
                    )}
                  </div>
                </div>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => handleCompleteFollowup(followup.id)}
                  className="text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50 dark:text-emerald-400"
                >
                  <CheckCircle className="w-5 h-5" />
                </Button>
              </div>
            </motion.div>
          ))}
        </div>
      ) : (
        <div className="bg-slate-50 dark:bg-slate-900/50 rounded-2xl p-12 text-center border border-slate-200 dark:border-slate-700">
          <Bell className="w-12 h-12 text-slate-300 mx-auto mb-3" />
          <p className="text-slate-600 dark:text-slate-400 font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØªØ§Ø¨Ø¹Ø§Øª Ù…Ø¬Ø¯ÙˆÙ„Ø©</p>
          <p className="text-slate-400 text-sm mt-1">Ø£Ø¶Ù Ù…ØªØ§Ø¨Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ°ÙƒÙŠØ±</p>
        </div>
      )}

      {completedFollowups.length > 0 && (
        <div className="mt-6">
          <h5 className="text-sm font-medium text-slate-500 dark:text-slate-400 mb-3">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ({completedFollowups.length})</h5>
          <div className="space-y-2">
            {completedFollowups.slice(0, 5).map(followup => (
              <div
                key={followup.id}
                className="bg-slate-50 dark:bg-slate-900/50 rounded-lg p-3 border border-slate-100 dark:border-slate-800 opacity-60"
              >
                <div className="flex items-center gap-2">
                  <CheckCircle className="w-4 h-4 text-emerald-500" />
                  <span className="text-sm text-slate-600 dark:text-slate-400 line-through">{followup.title}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </motion.div>
  );
};

/**
 * Main Customer Details Page Component
 */
const CustomerDetailsPage = () => {
  const { customerId } = useParams<{ customerId: string }>();
  const navigate = useNavigate();
  const { toast } = useToast();
  const { companyId, isAuthenticating } = useUnifiedCompanyAccess();
  const queryClient = useQueryClient();

  // Local state
  const [activeTab, setActiveTab] = useState('contracts');
  const [isPaymentDialogOpen, setIsPaymentDialogOpen] = useState(false);
  const [selectedDocumentType, setSelectedDocumentType] = useState<string>('identity');
  const fileInputRef = useRef<HTMLInputElement | null>(null);
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);
  const [isArchiveDialogOpen, setIsArchiveDialogOpen] = useState(false);
  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);
  const [selectedContract, setSelectedContract] = useState<any>(null);
  const [selectedPayment, setSelectedPayment] = useState<any>(null);
  const [currentPage, setCurrentPage] = useState(1);
  const itemsPerPage = 10;

  // Fetch customer data
  const { data: customer, isLoading: loadingCustomer, error: customerError } = useQuery({
    queryKey: ['customer-details', customerId, companyId],
    queryFn: async () => {
      console.log('ğŸ” [CustomerDetails] Fetching customer:', { customerId, companyId });

      if (!customerId) {
        console.error('âŒ [CustomerDetails] Customer ID is missing');
        throw new Error('Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…ÙÙ‚ÙˆØ¯');
      }

      if (!companyId) {
        console.error('âŒ [CustomerDetails] Company ID is missing');
        throw new Error('Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ø±ÙƒØ© Ù…ÙÙ‚ÙˆØ¯ - ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
      }

      const { data, error } = await supabase
        .from('customers')
        .select('*')
        .eq('id', customerId)
        .eq('company_id', companyId)
        .single();

      if (error) {
        console.error('âŒ [CustomerDetails] Error fetching customer:', {
          error,
          customerId,
          companyId,
          code: error.code,
          message: error.message,
          details: error.details
        });
        throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„: ${error.message}`);
      }

      if (!data) {
        console.error('âŒ [CustomerDetails] Customer not found:', { customerId, companyId });
        throw new Error('Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
      }

      console.log('âœ… [CustomerDetails] Customer fetched successfully:', data.id);
      return data;
    },
    enabled: !!customerId && !!companyId,
    retry: 1,
    staleTime: 30 * 1000,
  });

  // Fetch customer contracts
  const { data: contracts = [], isLoading: loadingContracts } = useQuery({
    queryKey: ['customer-contracts', customerId],
    queryFn: async () => {
      if (!customerId) return [];

      const { data, error } = await supabase
        .from('contracts')
        .select(`
          *,
          vehicle:vehicles!vehicle_id(
            id,
            make,
            model,
            year,
            plate_number
          )
        `)
        .eq('customer_id', customerId)
        .eq('company_id', companyId)
        .order('created_at', { ascending: false });

      if (error) throw error;
      return data || [];
    },
    enabled: !!customerId,
  });

  // Fetch customer payments
  const { data: payments = [], isLoading: loadingPayments } = useQuery({
    queryKey: ['customer-payments', customerId],
    queryFn: async () => {
      if (!customerId) return [];

      const { data, error } = await supabase
        .from('payments')
        .select('*')
        .eq('customer_id', customerId)
        .eq('company_id', companyId)
        .order('payment_date', { ascending: false })
        .limit(10);

      if (error) throw error;
      return data || [];
    },
    enabled: !!customerId,
  });

  // Fetch customer invoices
  const { data: customerInvoices = [], isLoading: loadingInvoices } = useQuery({
    queryKey: ['customer-invoices', customerId, companyId],
    queryFn: async () => {
      if (!customerId || !companyId) return [];

      const { data, error } = await supabase
        .from('invoices')
        .select(`
          *,
          contract:contracts!contract_id(id, contract_number)
        `)
        .eq('customer_id', customerId)
        .eq('company_id', companyId)
        .order('created_at', { ascending: false })
        .limit(20);

      if (error) {
        console.error('Error fetching invoices:', error);
        return [];
      }
      return data || [];
    },
    enabled: !!customerId && !!companyId,
  });

  // Fetch customer documents
  const { data: documents = [], isLoading: loadingDocuments } = useCustomerDocuments(customerId);
  const uploadDocument = useUploadCustomerDocument();
  const deleteDocument = useDeleteCustomerDocument();
  const downloadDocument = useDownloadCustomerDocument();

  // Fetch traffic violations
  const { data: trafficViolations = [], isLoading: loadingViolations } = useQuery({
    queryKey: ['customer-traffic-violations', customerId, companyId],
    queryFn: async () => {
      if (!customerId || !companyId) return [];

      const { data, error } = await supabase
        .from('traffic_violations')
        .select(`
          *,
          contract:contracts!contract_id(
            id,
            contract_number,
            customer_id
          ),
          vehicle:vehicles!vehicle_id(
            id,
            make,
            model,
            plate_number
          )
        `)
        .eq('company_id', companyId)
        .order('violation_date', { ascending: false });

      if (error) {
        console.error('Error fetching traffic violations:', error);
        return [];
      }

      const customerViolations = data?.filter(
        v => v.contract?.customer_id === customerId
      ) || [];

      return customerViolations;
    },
    enabled: !!customerId && !!companyId,
  });

  // Calculate statistics
  const stats = useMemo(() => {
    const activeContracts = contracts.filter(c => c.status === 'active').length;
    const totalPayments = payments.reduce((sum, p) => sum + (p.amount || 0), 0);

    const totalContractAmount = contracts
      .filter(c => c.status === 'active')
      .reduce((sum, c) => sum + (c.contract_amount || 0), 0);
    const totalPaid = contracts
      .filter(c => c.status === 'active')
      .reduce((sum, c) => sum + (c.total_paid || 0), 0);
    const outstandingAmount = totalContractAmount - totalPaid;

    const paidOnTime = payments.filter(p => p.payment_status === 'completed').length;
    const commitmentRate = payments.length > 0 ? Math.round((paidOnTime / payments.length) * 100) : 100;

    return {
      activeContracts,
      outstandingAmount,
      commitmentRate,
      totalPayments,
    };
  }, [contracts, payments]);

  // Format customer name
  const customerName = useMemo(() => {
    if (!customer) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    if (customer.customer_type === 'corporate') {
      return customer.company_name_ar || customer.company_name || 'Ø´Ø±ÙƒØ©';
    }
    const firstName = customer.first_name_ar || customer.first_name || '';
    const lastName = customer.last_name_ar || customer.last_name || '';
    const name = `${firstName} ${lastName}`.trim();
    return name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  }, [customer]);

  // Format contracts for display
  const formattedContracts = useMemo(() => {
    return contracts.map(contract => {
      const vehicleName = contract.vehicle
        ? `${contract.vehicle.make} ${contract.vehicle.model} ${contract.vehicle.year || ''}`
        : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

      const endDate = contract.end_date ? new Date(contract.end_date) : null;
      const daysRemaining = endDate ? differenceInDays(endDate, new Date()) : 0;

      return {
        id: contract.id,
        vehicle: contract.vehicle,
        vehicleName,
        contractNumber: contract.contract_number,
        startDate: contract.start_date,
        endDate: contract.end_date,
        monthlyAmount: contract.monthly_amount || 0,
        status: contract.status,
        paymentStatus: (contract.total_paid || 0) >= (contract.contract_amount || 0) ? 'paid' : 'pending',
        daysRemaining,
      };
    });
  }, [contracts]);

  // Format payments for display
  const formattedPayments = useMemo(() => {
    return payments.map(payment => ({
      id: payment.id,
      paymentNumber: payment.payment_number || payment.id.substring(0, 8),
      date: payment.payment_date || payment.created_at,
      contractNumber: payment.contract_id || '-',
      amount: payment.amount || 0,
      paymentMethod: payment.payment_method || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
      status: payment.payment_status === 'completed' ? 'paid' : payment.payment_status === 'pending' ? 'pending' : 'failed',
    }));
  }, [payments]);

  // Event handlers
  const handleBack = useCallback(() => {
    navigate('/customers');
  }, [navigate]);

  const handleEdit = useCallback(() => {
    setIsEditDialogOpen(true);
  }, []);

  const handleEditSuccess = useCallback((updatedCustomer: any) => {
    toast({
      title: 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­',
      description: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­',
    });

    queryClient.invalidateQueries({ queryKey: ['customer-details', customerId, companyId] });
    queryClient.invalidateQueries({ queryKey: ['customer-contracts', customerId] });

    setIsEditDialogOpen(false);
  }, [toast, queryClient, customerId, companyId]);

  const handleDelete = useCallback(() => {
    setIsDeleteDialogOpen(true);
  }, []);

  const confirmDelete = useCallback(async () => {
    if (!customerId) return;

    try {
      const { error } = await supabase
        .from('customers')
        .delete()
        .eq('id', customerId)
        .eq('company_id', companyId);

      if (error) throw error;

      toast({
        title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­',
        description: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­',
      });

      navigate('/customers');
    } catch (error: any) {
      toast({
        title: 'Ø®Ø·Ø£',
        description: error.message || 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„',
        variant: 'destructive',
      });
    } finally {
      setIsDeleteDialogOpen(false);
    }
  }, [customerId, navigate, toast, companyId]);

  const handleArchive = useCallback(() => {
    setIsArchiveDialogOpen(true);
  }, []);

  const confirmArchive = useCallback(async () => {
    if (!customerId) return;

    try {
      const { error } = await supabase
        .from('customers')
        .update({ is_active: false })
        .eq('id', customerId)
        .eq('company_id', companyId);

      if (error) throw error;

      toast({
        title: 'ØªÙ… Ø§Ù„Ø£Ø±Ø´ÙØ© Ø¨Ù†Ø¬Ø§Ø­',
        description: 'ØªÙ… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­',
      });

      queryClient.invalidateQueries({ queryKey: ['customer-details', customerId, companyId] });
    } catch (error: any) {
      toast({
        title: 'Ø®Ø·Ø£',
        description: error.message || 'ÙØ´Ù„ Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„',
        variant: 'destructive',
      });
    } finally {
      setIsArchiveDialogOpen(false);
    }
  }, [customerId, companyId, queryClient, toast]);

  const handleGenerateReport = useCallback(async () => {
    if (!customer || !customerId) return;

    toast({
      title: 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±',
      description: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...',
    });

    const { generateCustomerReport } = await import('@/hooks/useCustomerPDFReport');
    const result = await generateCustomerReport(customerId);

    if (result.success) {
      toast({
        title: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±',
        description: `ØªÙ… ØªÙ†Ø²ÙŠÙ„ ${result.fileName}`,
      });
    } else {
      toast({
        title: 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±',
        description: result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹',
        variant: 'destructive',
      });
    }
  }, [customerId, customer, toast]);

  const handleFileSelect = useCallback((event: React.ChangeEvent<HTMLInputElement>) => {
    const files = event.target.files;
    if (!files || files.length === 0 || !customerId) return;

    const file = files[0];

    if (file.size > 10 * 1024 * 1024) {
      toast({
        title: 'Ø®Ø·Ø£',
        description: 'Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª',
        variant: 'destructive',
      });
      return;
    }

    uploadDocument.mutate({
      customer_id: customerId,
      document_type: selectedDocumentType,
      document_name: file.name,
      file: file,
    });

    event.target.value = '';
  }, [customerId, selectedDocumentType, uploadDocument, toast]);

  const handleUploadClick = useCallback(() => {
    fileInputRef.current?.click();
  }, []);

  const handleDeleteDocument = useCallback((documentId: string) => {
    if (window.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ØŸ')) {
      deleteDocument.mutate(documentId);
    }
  }, [deleteDocument]);

  const handleDownloadDocument = useCallback((document: any) => {
    downloadDocument.mutate(document);
  }, [downloadDocument]);

  const handleViewContract = useCallback((contractId: string) => {
    navigate(`/contracts/${contractId}`);
  }, [navigate]);

  const handleRenewContract = useCallback((contract: any) => {
    navigate(`/contracts?renew=${contract.id}`);
  }, [navigate]);

  const handleContinuePayment = useCallback((contract: any) => {
    setSelectedContract(contract);
    setIsPaymentDialogOpen(true);
  }, []);

  const handleViewPayment = useCallback((payment: any) => {
    setSelectedPayment(payment);
  }, []);

  const handleNextPage = useCallback(() => {
    setCurrentPage(prev => prev + 1);
  }, []);

  const handlePreviousPage = useCallback(() => {
    setCurrentPage(prev => Math.max(1, prev - 1));
  }, []);

  const handleViewVehicle = useCallback((vehicleId: string) => {
    navigate(`/vehicles/${vehicleId}`);
  }, [navigate]);

  const handleNotifications = useCallback(() => {
    navigate('/notifications');
  }, [navigate]);

  const handleSettings = useCallback(() => {
    navigate('/settings');
  }, [navigate]);

  const isLoading = loadingCustomer || loadingContracts || loadingPayments;

  useEffect(() => {
    console.log('ğŸ” [CustomerDetailsPage] Debug:', {
      customerId,
      companyId,
      isLoading,
      isAuthenticating,
      hasCustomer: !!customer,
      customerError: customerError?.message,
    });
  }, [customerId, companyId, isLoading, isAuthenticating, customer, customerError]);

  if (isAuthenticating || !companyId || isLoading) {
    return <PageSkeletonFallback />;
  }

  if (!companyId) {
    console.error('âŒ [CustomerDetailsPage] Company ID is missing');
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 via-slate-50 to-rose-50 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950 flex items-center justify-center p-4">
        <motion.div
          variants={scaleIn}
          initial="hidden"
          animate="visible"
          className="bg-white dark:bg-slate-900 rounded-2xl p-8 max-w-md w-full border border-slate-200 dark:border-slate-700 shadow-xl"
        >
          <div className="text-center">
            <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-rose-500 to-rose-600 flex items-center justify-center mx-auto mb-4">
              <Shield className="w-8 h-8 text-white" strokeWidth={2} />
            </div>
            <h3 className="text-xl font-bold text-slate-900 dark:text-slate-100 mb-3">
              Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø±ÙƒØ©
            </h3>
            <p className="text-slate-600 dark:text-slate-400 mb-6">
              Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
            </p>
            <div className="flex gap-3 justify-center">
              <Button onClick={handleBack} variant="outline" className="rounded-xl">
                Ø§Ù„Ø¹ÙˆØ¯Ø©
              </Button>
              <Button
                onClick={() => window.location.href = '/auth'}
                className="bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 rounded-xl"
              >
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
              </Button>
            </div>
          </div>
        </motion.div>
      </div>
    );
  }

  if (customerError || !customer) {
    console.error('âŒ [CustomerDetailsPage] Error or no customer:', {
      error: customerError,
      errorMessage: customerError?.message,
      hasCustomer: !!customer,
      customerId,
      companyId,
    });

    let errorMessage = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„';
    if (customerError) {
      if (customerError instanceof Error) {
        errorMessage = customerError.message;
      } else if (typeof customerError === 'object' && 'message' in customerError) {
        errorMessage = String(customerError.message);
      }
    }

    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 via-slate-50 to-rose-50 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950 flex items-center justify-center p-4">
        <motion.div
          variants={scaleIn}
          initial="hidden"
          animate="visible"
          className="bg-white dark:bg-slate-900 rounded-2xl p-8 max-w-md w-full border border-slate-200 dark:border-slate-700 shadow-xl"
        >
          <div className="text-center">
            <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-rose-500 to-rose-600 flex items-center justify-center mx-auto mb-4">
              <FileX className="w-8 h-8 text-white" strokeWidth={2} />
            </div>
            <h3 className="text-xl font-bold text-slate-900 dark:text-slate-100 mb-3">
              Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
            </h3>
            <p className="text-slate-600 dark:text-slate-400 mb-6">
              {errorMessage}
            </p>
            {!customerId && (
              <p className="text-sm text-rose-600 dark:text-rose-400 mb-4 font-medium">
                âš ï¸ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…ÙÙ‚ÙˆØ¯
              </p>
            )}
            <div className="bg-slate-50 dark:bg-slate-900 rounded-xl p-4 mb-6 text-right">
              <p className="text-xs text-slate-500 dark:text-slate-400 mb-2 font-medium">ØªÙØ§ØµÙŠÙ„ ØªÙ‚Ù†ÙŠØ©:</p>
              <p className="text-xs font-mono text-slate-600 dark:text-slate-400">Customer ID: {customerId || 'N/A'}</p>
              <p className="text-xs font-mono text-slate-600 dark:text-slate-400">Company ID: {companyId || 'N/A'}</p>
            </div>
            <Button
              onClick={handleBack}
              className="bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 rounded-xl w-full"
            >
              Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
            </Button>
          </div>
        </motion.div>
      </div>
    );
  }

  const getInitials = (name: string): string => {
    if (!name || name === 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') return 'ØŸ';
    const names = name.split(' ').filter(n => n.length > 0);
    if (names.length === 0) return 'ØŸ';
    return names
      .slice(0, 2)
      .map((n) => n[0])
      .join('')
      .toUpperCase();
  };

  const tabs = [
    { id: 'personal-info', label: 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„', icon: User, count: 0 },
    { id: 'phones', label: 'Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡Ø§ØªÙ', icon: Phone, count: 0 },
    { id: 'contracts', label: 'Ø§Ù„Ø¹Ù‚ÙˆØ¯', icon: FileText, count: formattedContracts.length },
    { id: 'vehicles', label: 'Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª', icon: Car, count: formattedContracts.length },
    { id: 'invoices', label: 'Ø§Ù„ÙÙˆØ§ØªÙŠØ±', icon: Wallet, count: customerInvoices.length },
    { id: 'payments', label: 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª', icon: CreditCard, count: formattedPayments.length },
    { id: 'documents', label: 'Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª', icon: Folder, count: documents.length },
    { id: 'violations', label: 'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª', icon: AlertTriangle, count: trafficViolations.length },
    { id: 'notes', label: 'CRM ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª', icon: MessageSquare, count: 0 },
    { id: 'followups', label: 'Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª', icon: Bell, count: 0 },
    { id: 'activity', label: 'Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·', icon: Activity, count: 0 },
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-slate-50 to-rose-50 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950" dir="rtl">
      {/* Navigation Bar */}
      <motion.nav
        initial={{ y: -100, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ type: 'spring', stiffness: 300, damping: 30 }}
        className="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-b border-slate-200 dark:border-slate-700 fixed top-0 left-0 right-0 z-50 shadow-sm"
      >
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center gap-4">
              <motion.div whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={handleBack}
                  className="w-10 h-10 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800"
                >
                  <ArrowRight className="w-5 h-5 text-slate-600 dark:text-slate-400" />
                </Button>
              </motion.div>
              <div>
                <h1 className="text-base font-bold text-slate-900 dark:text-slate-100">
                  ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„
                </h1>
                <p className="text-xs text-slate-500 dark:text-slate-400">
                  Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
                </p>
              </div>
            </div>

            <div className="flex items-center gap-2">
              {/* Quick Action Buttons */}
              {customer?.phone && (
                <>
                  <TooltipProvider>
                    <Tooltip>
                      <TooltipTrigger asChild>
                        <motion.div whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => window.open(`tel:${customer.phone}`, '_self')}
                            className="gap-2 text-blue-600 border-blue-200 hover:bg-blue-50 dark:text-blue-400 dark:border-blue-800 rounded-xl"
                          >
                            <Phone className="w-4 h-4" />
                            <span className="hidden sm:inline">Ø§ØªØµØ§Ù„</span>
                          </Button>
                        </motion.div>
                      </TooltipTrigger>
                      <TooltipContent>
                        <p>Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©</p>
                      </TooltipContent>
                    </Tooltip>
                  </TooltipProvider>
                  <TooltipProvider>
                    <Tooltip>
                      <TooltipTrigger asChild>
                        <motion.div whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => {
                              const whatsappNumber = customer.whatsapp || customer.phone;
                              const cleanedNumber = whatsappNumber.replace(/[^0-9]/g, '');
                              window.open(`https://wa.me/${cleanedNumber}`, '_blank');
                            }}
                            className="gap-2 text-emerald-600 border-emerald-200 hover:bg-emerald-50 dark:text-emerald-400 dark:border-emerald-800 rounded-xl"
                          >
                            <MessageSquare className="w-4 h-4" />
                            <span className="hidden sm:inline">ÙˆØ§ØªØ³Ø§Ø¨</span>
                          </Button>
                        </motion.div>
                      </TooltipTrigger>
                      <TooltipContent>
                        <p>Ù…Ø±Ø§Ø³Ù„Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</p>
                      </TooltipContent>
                    </Tooltip>
                  </TooltipProvider>
                </>
              )}
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <motion.div whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => navigate(`/customers/crm?customer=${customerId}`)}
                        className="gap-2 border-purple-200 text-purple-600 hover:bg-purple-50 dark:text-purple-400 dark:border-purple-800 rounded-xl"
                      >
                        <Activity className="w-4 h-4" />
                        <span className="hidden sm:inline">CRM</span>
                      </Button>
                    </motion.div>
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>

              <span className="text-slate-300 dark:text-slate-600 mx-1">|</span>

              <motion.div whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
                <Button
                  variant="ghost"
                  size="icon"
                  className="w-10 h-10 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 relative"
                  onClick={handleNotifications}
                >
                  <Bell className="w-5 h-5 text-slate-600 dark:text-slate-400" />
                  <span className="absolute top-1.5 left-1.5 w-2 h-2 bg-gradient-to-br from-rose-500 to-rose-600 rounded-full animate-pulse"></span>
                </Button>
              </motion.div>
              <motion.div whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
                <Button
                  variant="ghost"
                  size="icon"
                  className="w-10 h-10 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800"
                  onClick={handleSettings}
                >
                  <Settings className="w-5 h-5 text-slate-600 dark:text-slate-400" />
                </Button>
              </motion.div>
              <Avatar className="w-9 h-9 cursor-pointer rounded-xl">
                <AvatarFallback className="bg-gradient-to-br from-rose-500 to-rose-600 text-white text-sm font-bold rounded-xl">
                  Ùƒ
                </AvatarFallback>
              </Avatar>
            </div>
          </div>
        </div>
      </motion.nav>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-12">
        <motion.div
          variants={containerVariants}
          initial="hidden"
          animate="visible"
        >
          {/* Customer Profile Header */}
          <motion.div
            variants={fadeInUp}
            className="bg-white dark:bg-slate-900 rounded-2xl p-6 mb-6 border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-xl transition-all duration-300"
          >
            <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
              <div className="flex items-start gap-5">
                <motion.div
                  whileHover={{ scale: 1.05, rotate: 5 }}
                  transition={{ type: 'spring', stiffness: 300 }}
                >
                  <Avatar className="w-20 h-20 rounded-2xl flex-shrink-0 ring-4 ring-rose-100 dark:ring-rose-900/30">
                    <AvatarFallback className="bg-gradient-to-br from-rose-500 to-rose-600 text-white text-2xl font-bold rounded-2xl">
                      {getInitials(customerName)}
                    </AvatarFallback>
                  </Avatar>
                </motion.div>

                <div>
                  <div className="flex items-center gap-3 mb-3 flex-wrap">
                    <h2 className="text-2xl font-bold bg-gradient-to-br from-slate-900 to-slate-600 dark:from-slate-100 dark:to-slate-400 bg-clip-text text-transparent">
                      {customerName}
                    </h2>
                    <Badge className={cn(
                      "flex items-center gap-1.5 rounded-full px-3 py-1 font-medium",
                      customer.is_active
                        ? "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400"
                        : "bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-400"
                    )}>
                      <CheckCircle className="w-3.5 h-3.5" />
                      {customer.is_active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}
                    </Badge>
                    {customer.is_vip && (
                      <Badge className="bg-gradient-to-br from-amber-100 to-amber-200 text-amber-700 dark:from-amber-900/30 dark:to-amber-800/30 dark:text-amber-400 flex items-center gap-1.5 rounded-full px-3 py-1 font-medium">
                        <Star className="w-3.5 h-3.5 fill-current" />
                        Ø¹Ù…ÙŠÙ„ Ù…Ù…ÙŠØ²
                      </Badge>
                    )}
                  </div>
                  <div className="flex items-center gap-5 text-sm text-slate-600 dark:text-slate-400 flex-wrap">
                    <span className="flex items-center gap-1.5 font-mono">
                      <Hash className="w-4 h-4" />
                      {customer.customer_code || customer.id.substring(0, 8)}
                    </span>
                    <span className="flex items-center gap-1.5">
                      <Calendar className="w-4 h-4" />
                      Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {customer.created_at ? format(new Date(customer.created_at), 'dd/MM/yyyy', { locale: ar }) : '-'}
                    </span>
                    <span className="flex items-center gap-1.5">
                      <Clock className="w-4 h-4" />
                      Ø¢Ø®Ø± Ù†Ø´Ø§Ø·: {customer.updated_at ? format(new Date(customer.updated_at), 'dd/MM/yyyy', { locale: ar }) : '-'}
                    </span>
                  </div>
                </div>
              </div>

              <div className="flex items-center gap-2 flex-wrap">
                <motion.div whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }}>
                  <Button
                    onClick={handleEdit}
                    className="bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 gap-2 rounded-xl shadow-lg shadow-rose-500/20"
                  >
                    <Edit3 className="w-4 h-4" />
                    ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                  </Button>
                </motion.div>
                <motion.div whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }}>
                  <Button
                    variant="outline"
                    onClick={handleGenerateReport}
                    className="gap-2 rounded-xl border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800"
                  >
                    <FileText className="w-4 h-4" />
                    Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±
                  </Button>
                </motion.div>
                <motion.div whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }}>
                  <Button
                    variant="outline"
                    onClick={handleArchive}
                    className="gap-2 rounded-xl border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800"
                  >
                    <Archive className="w-4 h-4" />
                    Ø£Ø±Ø´ÙØ©
                  </Button>
                </motion.div>
                <motion.div whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }}>
                  <Button
                    variant="outline"
                    onClick={handleDelete}
                    className="gap-2 border-rose-200 text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-950/30 rounded-xl"
                  >
                    <Trash2 className="w-4 h-4" />
                    Ø­Ø°Ù
                  </Button>
                </motion.div>
              </div>
            </div>
          </motion.div>

          {/* Missing Data Warnings */}
          <MissingDataWarnings customer={customer} />

          {/* Stats Cards */}
          <motion.div
            variants={containerVariants}
            className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"
          >
            <StatsCard
              icon={FileText}
              label="Ø¹Ù‚ÙˆØ¯ Ù†Ø´Ø·Ø©"
              value={stats.activeContracts}
              gradient="text-blue-600"
              iconBg="bg-blue-50 dark:bg-blue-950/30"
            />
            <StatsCard
              icon={Wallet}
              label="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚"
              value={stats.outstandingAmount.toLocaleString('en-US')}
              suffix="Ø±.Ø³"
              gradient="text-amber-600"
              iconBg="bg-amber-50 dark:bg-amber-950/30"
              trend="ÙŠØ³ØªØ­Ù‚ Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…"
            />
            <StatsCard
              icon={TrendingUp}
              label="Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…"
              value={`${stats.commitmentRate}%`}
              gradient="text-emerald-600"
              iconBg="bg-emerald-50 dark:bg-emerald-950/30"
              progress={stats.commitmentRate}
            />
            <StatsCard
              icon={CreditCard}
              label="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª"
              value={stats.totalPayments.toLocaleString('en-US')}
              suffix="Ø±.Ø³"
              gradient="text-purple-600"
              iconBg="bg-purple-50 dark:bg-purple-950/30"
              trend={`${payments.length} Ø¯ÙØ¹Ø© Ù…ÙƒØªÙ…Ù„Ø©`}
            />
          </motion.div>

          {/* Personal Information */}
          <motion.div
            variants={fadeInUp}
            className="bg-white dark:bg-slate-900 rounded-2xl p-6 mb-6 border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-xl transition-all duration-300"
          >
            <div className="flex items-center gap-3 mb-6">
              <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-rose-500 to-rose-600 flex items-center justify-center">
                <User className="w-5 h-5 text-white" strokeWidth={2} />
              </div>
              <h3 className="text-lg font-bold text-slate-900 dark:text-slate-100">
                Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©
              </h3>
            </div>

            <motion.div
              variants={containerVariants}
              className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
            >
              <InfoItem
                icon={Mail}
                label="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
                value={customer.email || '-'}
                iconBg="bg-blue-50 dark:bg-blue-950/30"
                iconGradient="text-blue-600"
              />
              <InfoItem
                icon={Phone}
                label="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„"
                value={customer.phone || '-'}
                iconBg="bg-emerald-50 dark:bg-emerald-950/30"
                iconGradient="text-emerald-600"
              />
              <InfoItem
                icon={MapPin}
                label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"
                value={customer.address || '-'}
                iconBg="bg-purple-50 dark:bg-purple-950/30"
                iconGradient="text-purple-600"
              />
              <InfoItem
                icon={Cake}
                label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯"
                value={customer.date_of_birth || '-'}
                iconBg="bg-amber-50 dark:bg-amber-950/30"
                iconGradient="text-amber-600"
              />
              <InfoItem
                icon={CreditCard}
                label="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©"
                value={customer.national_id || '-'}
                iconBg="bg-rose-50 dark:bg-rose-950/30"
                iconGradient="text-rose-600"
              />
              <InfoItem
                icon={Briefcase}
                label="Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„"
                value={customer.customer_type === 'individual' ? 'ÙØ±Ø¯' : customer.customer_type === 'corporate' ? 'Ø´Ø±ÙƒØ©' : '-'}
                iconBg="bg-cyan-50 dark:bg-cyan-950/30"
                iconGradient="text-cyan-600"
              />
            </motion.div>
          </motion.div>

          {/* Tabs Section */}
          <motion.div
            variants={fadeInUp}
            className="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden"
          >
            {/* Tab Navigation */}
            <div className="border-b border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 overflow-x-auto">
              <div className="flex min-w-max">
                {tabs.map((tab, index) => (
                  <motion.button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={cn(
                      "relative px-6 py-4 font-semibold text-sm transition-all duration-200 flex items-center gap-2 whitespace-nowrap",
                      activeTab === tab.id
                        ? 'text-rose-600 dark:text-rose-400'
                        : 'text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-800'
                    )}
                    initial={{ opacity: 0, y: -10 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: index * 0.05 }}
                  >
                    <tab.icon className="w-4 h-4" strokeWidth={2} />
                    {tab.label}
                    {tab.count > 0 && (
                      <Badge
                        variant={activeTab === tab.id ? "default" : "secondary"}
                        className={cn(
                          "mr-1 text-xs rounded-full",
                          activeTab === tab.id
                            ? "bg-gradient-to-br from-rose-500 to-rose-600 text-white"
                            : "bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400"
                        )}
                      >
                        {tab.count}
                      </Badge>
                    )}
                    {activeTab === tab.id && (
                      <motion.div
                        layoutId="activeTab"
                        className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-rose-500 to-rose-600"
                        transition={{ type: 'spring', stiffness: 500, damping: 30 }}
                      />
                    )}
                  </motion.button>
                ))}
              </div>
            </div>

            {/* Tab Content */}
            <AnimatePresence mode="wait">
              <motion.div
                key={activeTab}
                initial={{ opacity: 0, x: 20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -20 }}
                transition={{ duration: 0.2 }}
                className="p-6"
              >
                {/* Contracts Tab */}
                {activeTab === 'contracts' && (
                  <div>
                    <div className="flex items-center justify-between mb-6">
                      <div>
                        <h3 className="text-lg font-bold text-slate-900 dark:text-slate-100">
                          Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù†Ø´Ø·Ø©
                        </h3>
                        <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
                          Ø¥Ø¬Ù…Ø§Ù„ÙŠ {formattedContracts.length} Ø¹Ù‚Ø¯ Ù†Ø´Ø·
                        </p>
                      </div>
                      <motion.div whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }}>
                        <Button
                          className="bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 gap-2 rounded-xl shadow-lg shadow-rose-500/20"
                          onClick={() => navigate(`/contracts?customer=${customerId}`)}
                        >
                          <Plus className="w-4 h-4" />
                          Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯
                        </Button>
                      </motion.div>
                    </div>

                    <AnimatePresence>
                      {formattedContracts.length > 0 ? (
                        <motion.div
                          variants={containerVariants}
                          initial="hidden"
                          animate="visible"
                          className="space-y-4"
                        >
                          {formattedContracts.map((contract, index) => (
                            <motion.div
                              key={contract.id}
                              variants={itemVariants}
                              whileHover={{ y: -2, transition: { duration: 0.2 } }}
                              className="group bg-white dark:bg-slate-900 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-xl hover:border-rose-200 dark:hover:border-rose-800 transition-all duration-300 cursor-pointer"
                              onClick={() => navigate(`/contracts/${contract.contractNumber}`)}
                            >
                              <div className="flex items-start justify-between mb-5 pb-4 border-b border-slate-100 dark:border-slate-800">
                                <div className="flex items-start gap-4 flex-1">
                                  <motion.div
                                    whileHover={{ scale: 1.05, rotate: 5 }}
                                    className={cn(
                                      "w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0",
                                      index % 3 === 0 ? "bg-gradient-to-br from-blue-500 to-blue-600" :
                                      index % 3 === 1 ? "bg-gradient-to-br from-purple-500 to-purple-600" :
                                      "bg-gradient-to-br from-rose-500 to-rose-600"
                                    )}
                                  >
                                    <Car className="w-7 h-7 text-white" strokeWidth={2} />
                                  </motion.div>
                                  <div className="flex-1">
                                    <h4 className="text-lg font-bold text-slate-900 dark:text-slate-100 mb-1">
                                      {contract.vehicleName}
                                    </h4>
                                    <div className="flex items-center gap-3 text-sm text-slate-500 dark:text-slate-400">
                                      <span className="font-mono">#{contract.contractNumber}</span>
                                      <span>â€¢</span>
                                      <span>Ø¨Ø¯Ø£ ÙÙŠ {contract.startDate ? format(new Date(contract.startDate), 'dd/MM/yyyy', { locale: ar }) : '-'}</span>
                                    </div>
                                  </div>
                                </div>
                                <Badge className={cn(
                                  "rounded-full px-3 py-1 font-medium",
                                  contract.status === 'active'
                                    ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400'
                                    : 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400'
                                )}>
                                  {contract.status === 'active' ? 'Ù†Ø´Ø·' : 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'}
                                </Badge>
                              </div>

                              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <div>
                                  <div className="text-xs font-medium text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wide">
                                    Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ
                                  </div>
                                  <div className={cn(
                                    "text-base font-bold",
                                    index % 3 === 0 ? "text-blue-600" :
                                    index % 3 === 1 ? "text-purple-600" :
                                    "text-rose-600"
                                  )}>
                                    {contract.monthlyAmount.toLocaleString('en-US')} Ø±.Ø³
                                  </div>
                                </div>
                                <div>
                                  <div className="text-xs font-medium text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wide">
                                    ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                                  </div>
                                  <div className="text-base font-bold text-slate-900 dark:text-slate-100">
                                    {contract.endDate ? format(new Date(contract.endDate), 'dd/MM/yyyy', { locale: ar }) : '-'}
                                  </div>
                                </div>
                                <div>
                                  <div className="text-xs font-medium text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wide">
                                    Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
                                  </div>
                                  <div className={cn(
                                    "text-base font-bold",
                                    contract.daysRemaining <= 30 ? "text-amber-600" :
                                    contract.daysRemaining <= 60 ? "text-yellow-600" :
                                    "text-emerald-600"
                                  )}>
                                    {contract.daysRemaining} ÙŠÙˆÙ…
                                  </div>
                                </div>
                                <div>
                                  <div className="text-xs font-medium text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wide">
                                    Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
                                  </div>
                                  <div className={cn(
                                    "text-base font-bold",
                                    contract.paymentStatus === 'paid' ? "text-emerald-600" : "text-amber-600"
                                  )}>
                                    {contract.paymentStatus === 'paid' ? 'Ù…Ø¯ÙÙˆØ¹' : 'Ù…Ø¹Ù„Ù‚'}
                                  </div>
                                </div>
                              </div>

                              <div className="flex items-center gap-2 pt-4 border-t border-slate-100 dark:border-slate-800">
                                <Button
                                  variant="outline"
                                  className="flex-1 gap-2 rounded-xl border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleViewContract(contract.contractNumber);
                                  }}
                                >
                                  <Eye className="w-4 h-4" />
                                  Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                                </Button>
                                {contract.paymentStatus === 'paid' ? (
                                  <Button
                                    variant="outline"
                                    className="flex-1 gap-2 rounded-xl border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleRenewContract(contract);
                                    }}
                                  >
                                    <RefreshCw className="w-4 h-4" />
                                    ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯
                                  </Button>
                                ) : (
                                  <Button
                                    className="flex-1 gap-2 bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 rounded-xl"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleContinuePayment(contract);
                                    }}
                                  >
                                    <CreditCard className="w-4 h-4" />
                                    Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯ÙØ¹
                                  </Button>
                                )}
                              </div>
                            </motion.div>
                          ))}
                        </motion.div>
                      ) : (
                        <EmptyState
                          icon={FileText}
                          title="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚ÙˆØ¯"
                          description="Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ø¹Ù‚ÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯"
                          action={
                            <Button
                              className="bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 gap-2 rounded-xl mt-4"
                              onClick={() => navigate(`/contracts?customer=${customerId}`)}
                            >
                              <Plus className="w-4 h-4" />
                              Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯
                            </Button>
                          }
                        />
                      )}
                    </AnimatePresence>
                  </div>
                )}

                {/* Payments Tab */}
                {activeTab === 'payments' && (
                  <div>
                    <div className="flex items-center justify-between mb-6">
                      <div>
                        <h3 className="text-lg font-bold text-slate-900 dark:text-slate-100">
                          Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
                        </h3>
                        <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
                          Ø¢Ø®Ø± {formattedPayments.length} Ø¹Ù…Ù„ÙŠØ© Ø¯ÙØ¹
                        </p>
                      </div>
                      <motion.div whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }}>
                        <Button
                          className="bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 gap-2 rounded-xl shadow-lg shadow-rose-500/20"
                          onClick={() => window.open('/payment-registration', '_blank')}
                        >
                          <Plus className="w-4 h-4" />
                          ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
                        </Button>
                      </motion.div>
                    </div>

                    <AnimatePresence>
                      {formattedPayments.length > 0 ? (
                        <motion.div
                          variants={containerVariants}
                          initial="hidden"
                          animate="visible"
                          className="overflow-x-auto"
                        >
                          <table className="w-full">
                            <thead className="bg-slate-50 dark:bg-slate-900 border-b-2 border-slate-200 dark:border-slate-700">
                              <tr>
                                {['Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø¹Ù‚Ø¯', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'].map((header) => (
                                  <th key={header} className="px-6 py-4 text-right text-xs font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wide">
                                    {header}
                                  </th>
                                ))}
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-200 dark:divide-slate-700">
                              {formattedPayments.map((payment, index) => (
                                <motion.tr
                                  key={payment.id}
                                  variants={itemVariants}
                                  whileHover={{ scale: 1.01 }}
                                  className="transition-all duration-200 hover:bg-slate-50 dark:hover:bg-slate-900/50"
                                >
                                  <td className="px-6 py-4 text-sm font-mono text-slate-900 dark:text-slate-100 font-semibold">
                                    #{payment.paymentNumber}
                                  </td>
                                  <td className="px-6 py-4 text-sm text-slate-700 dark:text-slate-300">
                                    {payment.date ? format(new Date(payment.date), 'dd/MM/yyyy', { locale: ar }) : '-'}
                                  </td>
                                  <td className="px-6 py-4 text-sm text-slate-700 dark:text-slate-300 font-mono">
                                    #{payment.contractNumber.substring(0, 8)}
                                  </td>
                                  <td className="px-6 py-4 text-sm font-bold text-slate-900 dark:text-slate-100">
                                    {payment.amount.toLocaleString('en-US')} Ø±.Ø³
                                  </td>
                                  <td className="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">
                                    <div className="flex items-center gap-2">
                                      {payment.paymentMethod.includes('Ø¨Ù†Ùƒ') && <Landmark className="w-4 h-4" />}
                                      {payment.paymentMethod.includes('Ù†Ù‚Ø¯') && <Banknote className="w-4 h-4" />}
                                      {payment.paymentMethod.includes('Ø¨Ø·Ø§Ù‚Ø©') && <CreditCard className="w-4 h-4" />}
                                      {payment.paymentMethod.includes('Ù…Ø­ÙØ¸Ø©') && <Smartphone className="w-4 h-4" />}
                                      {payment.paymentMethod}
                                    </div>
                                  </td>
                                  <td className="px-6 py-4">
                                    <Badge className={cn(
                                      "rounded-full px-3 py-1 font-medium",
                                      payment.status === 'paid'
                                        ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400' :
                                      payment.status === 'pending'
                                        ? 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400'
                                        : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'
                                    )}>
                                      {payment.status === 'paid' ? 'Ù…Ø¯ÙÙˆØ¹' : payment.status === 'pending' ? 'Ù…Ø¹Ù„Ù‚' : 'ÙØ´Ù„'}
                                    </Badge>
                                  </td>
                                  <td className="px-6 py-4">
                                    <Button
                                      variant="outline"
                                      size="sm"
                                      className="gap-2 rounded-lg border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800"
                                      onClick={() => handleViewPayment(payment)}
                                    >
                                      <Eye className="w-3.5 h-3.5" />
                                      Ø¹Ø±Ø¶
                                    </Button>
                                  </td>
                                </motion.tr>
                              ))}
                            </tbody>
                          </table>
                        </motion.div>
                      ) : (
                        <EmptyState
                          icon={CreditCard}
                          title="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª"
                          description="Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯"
                          action={
                            <Button
                              className="bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 gap-2 rounded-xl mt-4"
                              onClick={() => window.open('/payment-registration', '_blank')}
                            >
                              <Plus className="w-4 h-4" />
                              ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
                            </Button>
                          }
                        />
                      )}
                    </AnimatePresence>
                  </div>
                )}

                {/* Vehicles Tab */}
                {activeTab === 'vehicles' && (
                  <div>
                    <div className="mb-6">
                      <h3 className="text-lg font-bold text-slate-900 dark:text-slate-100">
                        Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©
                      </h3>
                      <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
                        Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚Ø©
                      </p>
                    </div>

                    <AnimatePresence>
                      {formattedContracts.length > 0 ? (
                        <motion.div
                          variants={containerVariants}
                          initial="hidden"
                          animate="visible"
                          className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
                        >
                          {formattedContracts.map((contract, index) => (
                            <motion.div
                              key={contract.id}
                              variants={itemVariants}
                              whileHover={{ y: -4, transition: { duration: 0.2 } }}
                              className="group bg-white dark:bg-slate-900 rounded-2xl p-5 border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-xl transition-all duration-300"
                            >
                              <div className="flex items-start gap-3 mb-4">
                                <motion.div
                                  whileHover={{ scale: 1.05, rotate: 5 }}
                                  className={cn(
                                    "w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0",
                                    index % 3 === 0 ? "bg-gradient-to-br from-blue-500 to-blue-600" :
                                    index % 3 === 1 ? "bg-gradient-to-br from-purple-500 to-purple-600" :
                                    "bg-gradient-to-br from-rose-500 to-rose-600"
                                  )}
                                >
                                  <Car className="w-7 h-7 text-white" strokeWidth={2} />
                                </motion.div>
                                <div className="flex-1">
                                  <h4 className="font-bold text-slate-900 dark:text-slate-100 mb-1">
                                    {contract.vehicle?.make} {contract.vehicle?.model}
                                  </h4>
                                  <p className="text-xs text-slate-500 dark:text-slate-400">
                                    Ù…ÙˆØ¯ÙŠÙ„ {contract.vehicle?.year}
                                  </p>
                                  <Badge className="mt-2 bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 rounded-full px-3 py-1 text-xs font-medium">
                                    Ù†Ø´Ø·
                                  </Badge>
                                </div>
                              </div>

                              <div className="space-y-2 pt-3 border-t border-slate-100 dark:border-slate-800">
                                <div className="flex items-center justify-between text-sm">
                                  <span className="text-slate-500 dark:text-slate-400">Ø§Ù„Ù„ÙˆØ­Ø©:</span>
                                  <span className="font-mono font-semibold text-slate-900 dark:text-slate-100">
                                    {contract.vehicle?.plate_number || '-'}
                                  </span>
                                </div>
                                <div className="flex items-center justify-between text-sm">
                                  <span className="text-slate-500 dark:text-slate-400">Ø§Ù„Ø¹Ù‚Ø¯:</span>
                                  <span className="font-mono font-semibold text-slate-900 dark:text-slate-100">
                                    #{contract.contractNumber}
                                  </span>
                                </div>
                                <div className="flex items-center justify-between text-sm">
                                  <span className="text-slate-500 dark:text-slate-400">Ø§Ù„Ù…Ø¯Ø©:</span>
                                  <span className="font-semibold text-slate-900 dark:text-slate-100">
                                    {contract.daysRemaining} ÙŠÙˆÙ… Ù…ØªØ¨Ù‚ÙŠ
                                  </span>
                                </div>
                              </div>

                              <Button
                                variant="outline"
                                className="w-full mt-4 gap-2 rounded-xl border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800"
                                onClick={() => handleViewVehicle(contract.vehicle?.id || '')}
                              >
                                <Eye className="w-4 h-4" />
                                Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                              </Button>
                            </motion.div>
                          ))}
                        </motion.div>
                      ) : (
                        <EmptyState
                          icon={Car}
                          title="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª"
                          description="Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ¦Ø¬Ø§Ø± Ø£ÙŠ Ø³ÙŠØ§Ø±Ø§Øª Ù…Ù† Ù‚Ø¨Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„"
                        />
                      )}
                    </AnimatePresence>
                  </div>
                )}

                {/* Documents Tab */}
                {activeTab === 'documents' && (
                  <div>
                    <div className="mb-6">
                      <h3 className="text-lg font-bold text-slate-900 dark:text-slate-100">
                        Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª
                      </h3>
                      <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
                        {documents.length > 0
                          ? `${documents.length} Ù…Ø³ØªÙ†Ø¯ Ù…Ø±ÙÙˆØ¹`
                          : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù…Ø±ÙÙˆØ¹Ø©'}
                      </p>
                    </div>

                    {/* Upload Area */}
                    <motion.div
                      variants={itemVariants}
                      whileHover={{ scale: 1.01 }}
                      className="relative group cursor-pointer border-2 border-dashed border-slate-300 dark:border-slate-700 hover:border-rose-400 dark:hover:border-rose-600 rounded-2xl p-8 text-center transition-all duration-300 mb-6"
                      onClick={handleUploadClick}
                    >
                      <div className="absolute inset-0 bg-gradient-to-br from-rose-500/0 to-rose-600/0 group-hover:from-rose-500/5 group-hover:to-rose-600/5 rounded-2xl transition-all duration-300" />
                      <div className="relative">
                        <motion.div
                          whileHover={{ scale: 1.05, rotate: 5 }}
                          className="w-16 h-16 rounded-2xl bg-gradient-to-br from-rose-50 to-rose-100 dark:from-rose-950/30 dark:to-rose-900/30 flex items-center justify-center mx-auto mb-4"
                        >
                          <Upload className="w-8 h-8 text-rose-600 dark:text-rose-400" strokeWidth={2} />
                        </motion.div>
                        <h4 className="font-semibold text-slate-900 dark:text-slate-100 mb-2">
                          Ø±ÙØ¹ Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯
                        </h4>
                        <p className="text-sm text-slate-500 dark:text-slate-400 mb-4">
                          Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø«Ù… Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù
                        </p>

                        <div className="flex items-center justify-center gap-4 mb-4">
                          <select
                            value={selectedDocumentType}
                            onChange={(e) => setSelectedDocumentType(e.target.value)}
                            className="px-4 py-2 border border-slate-300 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-rose-500 focus:border-rose-500 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100"
                            onClick={(e) => e.stopPropagation()}
                          >
                            <option value="identity">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ©</option>
                            <option value="license">Ø±Ø®ØµØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</option>
                            <option value="contract">Ø¹Ù‚Ø¯</option>
                            <option value="invoice">ÙØ§ØªÙˆØ±Ø©</option>
                            <option value="receipt">Ø¥ÙŠØµØ§Ù„</option>
                            <option value="insurance">ØªØ£Ù…ÙŠÙ†</option>
                            <option value="other">Ø£Ø®Ø±Ù‰</option>
                          </select>
                        </div>

                        <input
                          ref={fileInputRef}
                          type="file"
                          className="hidden"
                          onChange={handleFileSelect}
                          accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                        />

                        <Button
                          className="bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 gap-2 rounded-xl"
                          onClick={(e) => {
                            e.stopPropagation();
                            handleUploadClick();
                          }}
                          disabled={uploadDocument.isPending}
                        >
                          <Upload className="w-4 h-4" />
                          {uploadDocument.isPending ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...' : 'Ø§Ø®ØªØ± Ù…Ù„Ù'}
                        </Button>
                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-4">
                          Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: PDF, JPG, PNG, DOC, DOCX (Ø­ØªÙ‰ 10MB)
                        </p>
                      </div>
                    </motion.div>

                    {/* Documents List */}
                    <AnimatePresence>
                      {loadingDocuments ? (
                        <div className="text-center py-8 text-slate-500 dark:text-slate-400">
                          <RefreshCw className="w-6 h-6 animate-spin mx-auto mb-2" />
                          Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª...
                        </div>
                      ) : documents.length > 0 ? (
                        <motion.div
                          variants={containerVariants}
                          initial="hidden"
                          animate="visible"
                          className="space-y-3"
                        >
                          {documents.map((doc) => (
                            <motion.div
                              key={doc.id}
                              variants={itemVariants}
                              whileHover={{ x: 4, transition: { duration: 0.2 } }}
                              className="bg-white dark:bg-slate-900 rounded-2xl p-5 border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-xl hover:border-rose-200 dark:hover:border-rose-800 transition-all duration-300"
                            >
                              <div className="flex items-start justify-between gap-4">
                                <div className="flex items-start gap-4 flex-1">
                                  <motion.div
                                    whileHover={{ scale: 1.05, rotate: 5 }}
                                    className="w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0 bg-gradient-to-br from-blue-500 to-blue-600"
                                  >
                                    <FileText className="w-6 h-6 text-white" strokeWidth={2} />
                                  </motion.div>
                                  <div className="flex-1">
                                    <h4 className="font-bold text-slate-900 dark:text-slate-100 mb-1">
                                      {doc.document_name}
                                    </h4>
                                    <div className="flex items-center gap-3 text-sm text-slate-500 dark:text-slate-400">
                                      <Badge className="bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 rounded-full px-3 py-1 text-xs font-medium">
                                        {doc.document_type === 'identity' ? 'Ù‡ÙˆÙŠØ©' :
                                         doc.document_type === 'license' ? 'Ø±Ø®ØµØ©' :
                                         doc.document_type === 'contract' ? 'Ø¹Ù‚Ø¯' :
                                         doc.document_type === 'invoice' ? 'ÙØ§ØªÙˆØ±Ø©' :
                                         doc.document_type === 'receipt' ? 'Ø¥ÙŠØµØ§Ù„' :
                                         doc.document_type === 'insurance' ? 'ØªØ£Ù…ÙŠÙ†' :
                                         'Ø£Ø®Ø±Ù‰'}
                                      </Badge>
                                      <span>â€¢</span>
                                      <span>{format(new Date(doc.uploaded_at), 'dd/MM/yyyy', { locale: ar })}</span>
                                      {doc.file_size && (
                                        <>
                                          <span>â€¢</span>
                                          <span>{(doc.file_size / 1024 / 1024).toFixed(2)} MB</span>
                                        </>
                                      )}
                                    </div>
                                    {doc.notes && (
                                      <p className="text-sm text-slate-600 dark:text-slate-400 mt-2">{doc.notes}</p>
                                    )}
                                  </div>
                                </div>

                                <div className="flex items-center gap-2">
                                  <Button
                                    variant="outline"
                                    size="sm"
                                    className="gap-2 rounded-lg border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800"
                                    onClick={() => handleDownloadDocument(doc)}
                                    disabled={downloadDocument.isPending}
                                  >
                                    <Download className="w-4 h-4" />
                                    ØªØ­Ù…ÙŠÙ„
                                  </Button>
                                  <Button
                                    variant="outline"
                                    size="sm"
                                    className="gap-2 border-rose-200 text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-950/30 rounded-lg"
                                    onClick={() => handleDeleteDocument(doc.id)}
                                    disabled={deleteDocument.isPending}
                                  >
                                    <Trash2 className="w-4 h-4" />
                                    Ø­Ø°Ù
                                  </Button>
                                </div>
                              </div>
                            </motion.div>
                          ))}
                        </motion.div>
                      ) : (
                        <EmptyState
                          icon={Folder}
                          title="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª"
                          description="Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø£ÙŠ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯"
                          action={
                            <Button
                              className="bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 gap-2 rounded-xl mt-4"
                              onClick={handleUploadClick}
                            >
                              <Upload className="w-4 h-4" />
                              Ø±ÙØ¹ Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯
                            </Button>
                          }
                        />
                      )}
                    </AnimatePresence>
                  </div>
                )}

                {/* Violations Tab */}
                {activeTab === 'violations' && (
                  <div>
                    <div className="flex items-center justify-between mb-6">
                      <div>
                        <h3 className="text-lg font-bold text-slate-900 dark:text-slate-100">
                          Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙˆØ±ÙŠØ©
                        </h3>
                        <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
                          Ø¥Ø¬Ù…Ø§Ù„ÙŠ {trafficViolations.length} Ù…Ø®Ø§Ù„ÙØ© Ù…Ø³Ø¬Ù„Ø©
                        </p>
                      </div>
                    </div>

                    <AnimatePresence>
                      {loadingViolations ? (
                        <div className="flex items-center justify-center py-8">
                          <RefreshCw className="w-6 h-6 animate-spin text-slate-400" />
                          <span className="mr-2 text-slate-500 dark:text-slate-400">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª...</span>
                        </div>
                      ) : trafficViolations.length > 0 ? (
                        <motion.div
                          variants={containerVariants}
                          initial="hidden"
                          animate="visible"
                          className="space-y-4"
                        >
                          {trafficViolations.map((violation: any, index: number) => (
                            <motion.div
                              key={violation.id}
                              variants={itemVariants}
                              whileHover={{ y: -2, transition: { duration: 0.2 } }}
                              className="bg-white dark:bg-slate-900 rounded-2xl p-5 border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-xl transition-all duration-300"
                            >
                              <div className="flex items-start justify-between mb-4">
                                <div className="flex items-start gap-4">
                                  <motion.div
                                    whileHover={{ scale: 1.05 }}
                                    className={cn(
                                      "w-12 h-12 rounded-xl flex items-center justify-center",
                                      violation.status === 'paid'
                                        ? "bg-emerald-100 dark:bg-emerald-950/30"
                                        : violation.status === 'pending'
                                          ? "bg-amber-100 dark:bg-amber-950/30"
                                          : "bg-red-100 dark:bg-red-950/30"
                                    )}
                                  >
                                    <AlertTriangle className={cn(
                                      "w-6 h-6",
                                      violation.status === 'paid'
                                        ? "text-emerald-600 dark:text-emerald-400"
                                        : violation.status === 'pending'
                                          ? "text-amber-600 dark:text-amber-400"
                                          : "text-red-600 dark:text-red-400"
                                    )} strokeWidth={2} />
                                  </motion.div>
                                  <div>
                                    <h4 className="font-bold text-slate-900 dark:text-slate-100">
                                      {violation.violation_type}
                                    </h4>
                                    <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
                                      Ø±Ù‚Ù… Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©: {violation.violation_number}
                                    </p>
                                    {violation.vehicle && (
                                      <p className="text-sm text-slate-500 dark:text-slate-400">
                                        Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: {violation.vehicle.make} {violation.vehicle.model} - {violation.vehicle.plate_number}
                                      </p>
                                    )}
                                  </div>
                                </div>
                                <Badge className={cn(
                                  "rounded-full px-3 py-1 font-medium",
                                  violation.status === 'paid'
                                    ? "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400"
                                    : violation.status === 'pending'
                                      ? "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400"
                                      : "bg-red-100 text-red-700 dark:bg-red-950/30 dark:text-red-400"
                                )}>
                                  {violation.status === 'paid' ? 'Ù…Ø¯ÙÙˆØ¹Ø©' : violation.status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø³Ø¯Ø§Ø¯' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©'}
                                </Badge>
                              </div>

                              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                                <div>
                                  <p className="text-xs font-medium text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wide">
                                    ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©
                                  </p>
                                  <p className="font-semibold text-slate-900 dark:text-slate-100">
                                    {violation.violation_date
                                      ? format(new Date(violation.violation_date), 'dd/MM/yyyy', { locale: ar })
                                      : '-'}
                                  </p>
                                </div>
                                <div>
                                  <p className="text-xs font-medium text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wide">
                                    Ø§Ù„Ù…ÙˆÙ‚Ø¹
                                  </p>
                                  <p className="font-semibold text-slate-900 dark:text-slate-100">
                                    {violation.location || '-'}
                                  </p>
                                </div>
                                <div>
                                  <p className="text-xs font-medium text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wide">
                                    Ø§Ù„Ù…Ø¨Ù„Øº
                                  </p>
                                  <p className="font-bold text-rose-600 dark:text-rose-400">
                                    {violation.fine_amount?.toLocaleString()} Ø±.Ù‚
                                  </p>
                                </div>
                                <div>
                                  <p className="text-xs font-medium text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wide">
                                    Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…ØµØ¯Ø±Ø©
                                  </p>
                                  <p className="font-semibold text-slate-900 dark:text-slate-100">
                                    {violation.issuing_authority || '-'}
                                  </p>
                                </div>
                              </div>

                              {violation.violation_description && (
                                <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                                  <p className="text-xs font-medium text-slate-500 dark:text-slate-400 mb-1 uppercase tracking-wide">
                                    Ø§Ù„ÙˆØµÙ
                                  </p>
                                  <p className="text-sm text-slate-700 dark:text-slate-300">
                                    {violation.violation_description}
                                  </p>
                                </div>
                              )}

                              {violation.contract && (
                                <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                                  <Button
                                    variant="outline"
                                    size="sm"
                                    className="gap-2 rounded-lg border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800"
                                    onClick={() => navigate(`/contracts/${violation.contract.contract_number}`)}
                                  >
                                    <FileText className="w-4 h-4" />
                                    Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø¯ #{violation.contract.contract_number}
                                  </Button>
                                </div>
                              )}
                            </motion.div>
                          ))}
                        </motion.div>
                      ) : (
                        <EmptyState
                          icon={AlertTriangle}
                          title="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª"
                          description="Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ù…Ø®Ø§Ù„ÙØ§Øª Ø¹Ù„Ù‰ Ø¹Ù‚ÙˆØ¯ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„"
                        />
                      )}
                    </AnimatePresence>
                  </div>
                )}

                {/* Personal Info Tab */}
                {activeTab === 'personal-info' && (
                  <motion.div
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                  >
                    <PersonalInfoTab customer={customer} />
                  </motion.div>
                )}

                {/* Phone Numbers Tab */}
                {activeTab === 'phones' && (
                  <motion.div
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                  >
                    <PhoneNumbersTab customer={customer} />
                  </motion.div>
                )}

                {/* Invoices Tab */}
                {activeTab === 'invoices' && (
                  <div>
                    <div className="flex items-center justify-between mb-6">
                      <div>
                        <h3 className="text-lg font-bold text-slate-900 dark:text-slate-100">
                          Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                        </h3>
                        <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
                          {customerInvoices.length} ÙØ§ØªÙˆØ±Ø©
                        </p>
                      </div>
                    </div>

                    <AnimatePresence>
                      {loadingInvoices ? (
                        <div className="flex items-center justify-center py-8">
                          <RefreshCw className="w-6 h-6 animate-spin text-slate-400" />
                        </div>
                      ) : customerInvoices.length > 0 ? (
                        <motion.div
                          variants={containerVariants}
                          initial="hidden"
                          animate="visible"
                          className="space-y-3"
                        >
                          {customerInvoices.map((invoice, index) => {
                            const outstanding = (invoice.total_amount || 0) - (invoice.paid_amount || 0);
                            const isPaid = invoice.payment_status === 'paid';
                            const isOverdue = !isPaid && invoice.due_date && new Date(invoice.due_date) < new Date();

                            return (
                              <motion.div
                                key={invoice.id}
                                variants={itemVariants}
                                whileHover={{ y: -2, transition: { duration: 0.2 } }}
                                className={cn(
                                  "flex items-center justify-between p-4 rounded-xl border transition-all cursor-pointer hover:shadow-md",
                                  isPaid ? "bg-emerald-50 dark:bg-emerald-950/20 border-emerald-200 dark:border-emerald-800" :
                                  isOverdue ? "bg-red-50 dark:bg-red-950/20 border-red-200 dark:border-red-800" :
                                  "bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700"
                                )}
                                onClick={() => navigate(`/finance/invoices/${invoice.id}`)}
                              >
                                <div className="flex items-center gap-3">
                                  <div className={cn(
                                    "w-10 h-10 rounded-lg flex items-center justify-center",
                                    isPaid ? "bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400" :
                                    isOverdue ? "bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400" :
                                    "bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400"
                                  )}>
                                    <FileText className="w-5 h-5" />
                                  </div>
                                  <div>
                                    <p className="font-bold text-slate-900 dark:text-slate-100">{invoice.invoice_number || `INV-${invoice.id.substring(0, 8)}`}</p>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">
                                      {invoice.created_at ? format(new Date(invoice.created_at), 'dd/MM/yyyy', { locale: ar }) : '-'}
                                    </p>
                                  </div>
                                </div>
                                <div className="text-left">
                                  <p className={cn(
                                    "font-bold",
                                    isPaid ? "text-emerald-600 dark:text-emerald-400" : isOverdue ? "text-red-600 dark:text-red-400" : "text-amber-600 dark:text-amber-400"
                                  )}>
                                    {invoice.total_amount?.toLocaleString()} Ø±.Ù‚
                                  </p>
                                  <Badge className={cn(
                                    "text-[10px]",
                                    isPaid ? "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400" :
                                    isOverdue ? "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400" :
                                    "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400"
                                  )}>
                                    {isPaid ? 'Ù…Ø³Ø¯Ø¯' : isOverdue ? 'Ù…ØªØ£Ø®Ø±' : 'Ù…Ø³ØªØ­Ù‚'}
                                  </Badge>
                                </div>
                              </motion.div>
                            );
                          })}
                        </motion.div>
                      ) : (
                        <EmptyState
                          icon={Wallet}
                          title="Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±"
                          description="Ù„Ù… ÙŠØªÙ… Ø¥ØµØ¯Ø§Ø± Ø£ÙŠ ÙÙˆØ§ØªÙŠØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„"
                        />
                      )}
                    </AnimatePresence>
                  </div>
                )}

                {/* Notes/CRM Tab */}
                {activeTab === 'notes' && (
                  <motion.div
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                  >
                    <NotesTab
                      customerId={customerId || ''}
                      customerPhone={customer?.phone || customer?.mobile_number}
                    />
                  </motion.div>
                )}

                {/* Followups Tab */}
                {activeTab === 'followups' && (
                  <motion.div
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                  >
                    <FollowupsTab
                      customerId={customerId || ''}
                      companyId={companyId || ''}
                    />
                  </motion.div>
                )}

                {/* Activity Tab */}
                {activeTab === 'activity' && (
                  <div>
                    <div className="mb-6">
                      <h3 className="text-lg font-bold text-slate-900 dark:text-slate-100">
                        Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·
                      </h3>
                      <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
                        Ø¢Ø®Ø± Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
                      </p>
                    </div>

                    <EmptyState
                      icon={Activity}
                      title="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø©"
                      description="Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø£Ù†Ø´Ø·Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯"
                    />
                  </div>
                )}
              </motion.div>
            </AnimatePresence>
          </motion.div>
        </motion.div>
      </main>

      {/* Payment Dialog */}
      <UnifiedPaymentForm
        open={isPaymentDialogOpen}
        onOpenChange={setIsPaymentDialogOpen}
        type="customer_payment"
        customerId={customerId}
        contractId={selectedContract?.id}
        onSuccess={() => {
          queryClient.invalidateQueries({ queryKey: ['customer-payments', customerId] });
          queryClient.invalidateQueries({ queryKey: ['customer-details', customerId, companyId] });
          setSelectedContract(null);
        }}
      />

      {/* Delete Dialog */}
      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
        <AlertDialogContent className="max-w-md rounded-2xl">
          <AlertDialogHeader>
            <AlertDialogTitle className="text-xl font-bold text-rose-600 dark:text-rose-400 flex items-center gap-2">
              <Trash2 className="w-5 h-5" strokeWidth={2} />
              ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„
            </AlertDialogTitle>
            <AlertDialogDescription className="text-base text-slate-600 dark:text-slate-400 mt-4">
              Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ <span className="font-bold text-slate-900 dark:text-slate-100">{customerName}</span>ØŸ
              <br />
              <br />
              <span className="text-rose-600 dark:text-rose-400 font-semibold">âš ï¸ ØªØ­Ø°ÙŠØ±:</span> Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ ÙˆÙ„Ù† ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter className="gap-2 mt-4">
            <AlertDialogCancel className="mt-0 rounded-xl">Ø¥Ù„ØºØ§Ø¡</AlertDialogCancel>
            <AlertDialogAction
              onClick={confirmDelete}
              className="bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 rounded-xl"
            >
              Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      {/* Archive Dialog */}
      <AlertDialog open={isArchiveDialogOpen} onOpenChange={setIsArchiveDialogOpen}>
        <AlertDialogContent className="max-w-md rounded-2xl">
          <AlertDialogHeader>
            <AlertDialogTitle className="text-xl font-bold text-amber-600 dark:text-amber-400 flex items-center gap-2">
              <Archive className="w-5 h-5" strokeWidth={2} />
              ØªØ£ÙƒÙŠØ¯ Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„
            </AlertDialogTitle>
            <AlertDialogDescription className="text-base text-slate-600 dark:text-slate-400 mt-4">
              Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ <span className="font-bold text-slate-900 dark:text-slate-100">{customerName}</span>ØŸ
              <br />
              <br />
              Ø³ÙŠØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙ„Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø£Ø±Ø´ÙØ© Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter className="gap-2 mt-4">
            <AlertDialogCancel className="mt-0 rounded-xl">Ø¥Ù„ØºØ§Ø¡</AlertDialogCancel>
            <AlertDialogAction
              onClick={confirmArchive}
              className="bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 rounded-xl"
            >
              Ù†Ø¹Ù…ØŒ Ø£Ø±Ø´Ù Ø§Ù„Ø¹Ù…ÙŠÙ„
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      {/* Edit Dialog */}
      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto rounded-2xl">
          <DialogHeader>
            <DialogTitle className="text-xl font-bold flex items-center gap-2">
              <Edit3 className="w-5 h-5 text-blue-600" strokeWidth={2} />
              ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
            </DialogTitle>
            <DialogDescription>
              Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ {customerName}
            </DialogDescription>
          </DialogHeader>
          {customer && (
            <EnhancedCustomerForm
              mode="edit"
              editingCustomer={customer}
              onSuccess={handleEditSuccess}
              onCancel={() => setIsEditDialogOpen(false)}
              context="standalone"
              integrationMode="dialog"
              showDuplicateCheck={false}
            />
          )}
        </DialogContent>
      </Dialog>

      {/* Payment Details Dialog */}
      {selectedPayment && (
        <Dialog open={!!selectedPayment} onOpenChange={() => setSelectedPayment(null)}>
          <DialogContent className="max-w-lg rounded-2xl">
            <DialogHeader>
              <DialogTitle className="text-xl font-bold flex items-center gap-2">
                <CreditCard className="w-5 h-5 text-blue-600" strokeWidth={2} />
                ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©
              </DialogTitle>
              <DialogDescription>
                Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙØµÙŠÙ„ÙŠØ© Ø¹Ù† Ø§Ù„Ø¯ÙØ¹Ø© Ø±Ù‚Ù… #{selectedPayment.paymentNumber}
              </DialogDescription>
            </DialogHeader>
            <div className="space-y-4 py-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl">
                  <div className="text-sm text-slate-500 dark:text-slate-400 mb-1">Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©</div>
                  <div className="text-base font-semibold font-mono text-slate-900 dark:text-slate-100">
                    #{selectedPayment.paymentNumber}
                  </div>
                </div>
                <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl">
                  <div className="text-sm text-slate-500 dark:text-slate-400 mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
                  <div className="text-base font-semibold text-slate-900 dark:text-slate-100">
                    {selectedPayment.date ? format(new Date(selectedPayment.date), 'dd/MM/yyyy', { locale: ar }) : '-'}
                  </div>
                </div>
                <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl">
                  <div className="text-sm text-slate-500 dark:text-slate-400 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº</div>
                  <div className="text-lg font-bold text-emerald-600 dark:text-emerald-400">
                    {selectedPayment.amount.toLocaleString('en-US')} Ø±.Ø³
                  </div>
                </div>
                <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl">
                  <div className="text-sm text-slate-500 dark:text-slate-400 mb-1">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
                  <div className="text-base font-semibold text-slate-900 dark:text-slate-100">
                    {selectedPayment.paymentMethod}
                  </div>
                </div>
                <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl">
                  <div className="text-sm text-slate-500 dark:text-slate-400 mb-1">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</div>
                  <div className="text-base font-semibold font-mono text-slate-900 dark:text-slate-100">
                    #{selectedPayment.contractNumber.substring(0, 8)}
                  </div>
                </div>
                <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl">
                  <div className="text-sm text-slate-500 dark:text-slate-400 mb-1">Ø§Ù„Ø­Ø§Ù„Ø©</div>
                  <Badge className={cn(
                    "rounded-full px-3 py-1 font-medium",
                    selectedPayment.status === 'paid'
                      ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400' :
                    selectedPayment.status === 'pending'
                      ? 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400'
                      : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'
                  )}>
                    {selectedPayment.status === 'paid' ? 'Ù…Ø¯ÙÙˆØ¹' : selectedPayment.status === 'pending' ? 'Ù…Ø¹Ù„Ù‚' : 'ÙØ´Ù„'}
                  </Badge>
                </div>
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setSelectedPayment(null)} className="rounded-xl">
                Ø¥ØºÙ„Ø§Ù‚
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      )}
    </div>
  );
};

export default CustomerDetailsPage;
