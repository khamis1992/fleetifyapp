# نظام استيراد شجرة الحسابات المحسن

## نظرة عامة

تم تطوير نظام محسن لاستيراد شجرة الحسابات من ملفات CSV مع الميزات التالية:

- **السحب والإفلات**: رفع الملفات بسهولة عبر السحب والإفلات
- **التعرف التلقائي على التسلسل الهرمي**: إنشاء العلاقات الهرمية تلقائياً
- **معاينة البيانات**: جدول قابل للفرز والتمرير لمعاينة البيانات
- **شجرة الحسابات**: عرض هرمي للحسابات مع التحقق من صحة العلاقات
- **التحقق من الأخطاء**: إظهار الأخطاء الهرمية باللون الأحمر
- **تقرير الأخطاء**: تنزيل تقرير مفصل بالأخطاء

## المكونات

### 1. CSVDragDropUpload
مكون السحب والإفلات لرفع ملفات CSV مع:
- دعم أنواع الملفات: `.csv`, `.xlsx`, `.xls`
- التحقق من حجم الملف (حد أقصى 10 ميجابايت)
- معاينة معلومات الملف
- رسائل خطأ واضحة

### 2. AccountsPreviewTable
جدول معاينة البيانات مع:
- فرز قابل للتخصيص لجميع الأعمدة
- بحث في البيانات
- تصفية حسب الحالة (صحيح/خطأ)
- ترقيم الصفحات
- إظهار الأخطاء الهرمية

### 3. AccountsTreeView
عرض شجرة الحسابات مع:
- عرض هرمي للحسابات
- توسيع/طي العقد
- إظهار الأخطاء الهرمية باللون الأحمر
- أيقونات مختلفة للحسابات الرئيسية والفرعية
- معلومات المستوى والحالة

## الـ Hook المحسن

### useEnhancedChartOfAccountsCSVUpload

يوفر الوظائف التالية:

#### processHierarchy(rawData)
- تحليل البيانات وإنشاء التسلسل الهرمي تلقائياً
- تحديد نوع الحساب بناءً على الرقم الأول
- العثور على الحسابات الأب تلقائياً
- التحقق من صحة العلاقات الهرمية

#### processCSVData(data)
- معالجة البيانات المستوردة
- تصفية الصفوف الفارغة
- إضافة أرقام الصفوف للتتبع

#### uploadAccounts()
- رفع الحسابات إلى قاعدة البيانات
- دعم التحديث والإنشاء
- معالجة الأخطاء الشاملة
- تقرير مفصل بالنتائج

## تنسيق ملف CSV المطلوب

```csv
المستوى,رقم الحساب,الوصف,الوصف بالإنجليزي
1,1,الأصول,Assets
2,11,الأصول المتداولة,Current Assets
3,111,النقدية وما يعادلها,Cash and Cash Equivalents
4,1101,النقدية,Cash
5,11101,الصندوق الرئيسي,Main Cash Fund
```

## قواعد التسلسل الهرمي

1. **تحديد الأب**: كل حساب يعرف أبوه بالاعتماد على رقم الحساب
2. **مثال**: `1110101` ابن للحساب `11101`، وهذا ابن للحساب `111`
3. **الترتيب**: يجب أن يكون الحساب الأب موجوداً قبل الحساب الفرعي
4. **الأخطاء**: إذا لم يتم العثور على الأب → يظهر الحساب باللون الأحمر

## أنواع الحسابات التلقائية

يتم تحديد نوع الحساب تلقائياً بناءً على الرقم الأول:

- **1**: أصول (Assets) - مدين
- **2**: خصوم (Liabilities) - دائن  
- **3**: حقوق الملكية (Equity) - دائن
- **4**: إيرادات (Revenue) - دائن
- **5-9**: مصروفات (Expenses) - مدين

## واجهة المستخدم

### التبويبات

1. **رفع الملف**: السحب والإفلات مع التعليمات
2. **معاينة البيانات**: جدول قابل للفرز والبحث
3. **شجرة الحسابات**: عرض هرمي مع التحقق من الأخطاء
4. **النتائج**: تقرير مفصل بنتائج الاستيراد

### الميزات التفاعلية

- **السحب والإفلات**: رفع سهل للملفات
- **المعاينة الفورية**: عرض البيانات قبل الحفظ
- **التحقق التلقائي**: فحص العلاقات الهرمية
- **رسائل الأخطاء**: إظهار واضح للمشاكل
- **تقرير الأخطاء**: تنزيل ملف CSV بالأخطاء

## الاستخدام

```typescript
import { ChartOfAccountsCSVUpload } from '@/components/finance/ChartOfAccountsCSVUpload';

<ChartOfAccountsCSVUpload
  open={showUpload}
  onOpenChange={setShowUpload}
  onUploadComplete={() => {
    setShowUpload(false);
    // تحديث البيانات
  }}
/>
```

## التحسينات المستقبلية

- [ ] دعم ملفات Excel المعقدة
- [ ] استيراد الأرصدة الافتتاحية
- [ ] دعم العملات المتعددة
- [ ] تصدير شجرة الحسابات
- [ ] قوالب جاهزة لأنواع الأعمال المختلفة
