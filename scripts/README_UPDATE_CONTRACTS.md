# تحديث بيانات العقود من ملف JSON

## نظرة عامة

هذا السكربت يقوم بتحديث بيانات العقود المرتبطة بالعملاء في شركة العراف بناءً على البيانات الموجودة في ملف JSON.

## الملف المطلوب

الملف يجب أن يكون في المسار: `.cursor/المركبات_مع_العملاء (1).json`

## البيانات المطلوبة

كل سجل في الملف يجب أن يحتوي على:
- `رقم المركبة`: رقم المركبة في النظام
- `اسم العميل`: اسم العميل
- `تاريخ بداية العقد`: تاريخ بداية العقد (بأي تنسيق: dd/mm/yyyy أو dd-mm-yyyy أو yyyy-mm-dd)
- `قيمة القسط`: قيمة القسط الشهري (رقم)
- `رقم الجوال`: رقم الجوال (اختياري للمساعدة في البحث)
- `ملاحظات`: ملاحظات إضافية (اختياري)

## ما يقوم به السكربت

1. **البحث عن المركبات**: يبحث عن المركبات في قاعدة البيانات باستخدام:
   - `vehicle_number`
   - `plate_number`
   - `license_plate`

2. **البحث عن العملاء**: يبحث عن العملاء باستخدام:
   - رقم الجوال (الأكثر دقة)
   - الاسم الكامل
   - الاسم الأول والأخير

3. **تحديث العقود**: 
   - يبحث عن العقود الموجودة المرتبطة بالمركبة والعميل
   - يحدث العقود النشطة بالبيانات الجديدة
   - ينشئ عقود جديدة إذا لم تكن موجودة
   - ينشط العقود الملغاة إذا كانت موجودة

4. **تحديث البيانات**:
   - `start_date`: تاريخ بداية العقد
   - `contract_date`: تاريخ العقد
   - `monthly_rent`: قيمة القسط الشهري
   - `end_date`: تاريخ النهاية (يتم حسابه تلقائياً: سنة واحدة من تاريخ البداية)
   - `notes`: الملاحظات

## الاستخدام

```bash
npm run update:contracts
```

أو:

```bash
npx tsx scripts/update-contracts-from-json.ts
```

## المتطلبات

- يجب أن تكون متغيرات البيئة (`VITE_SUPABASE_URL` و `SUPABASE_SERVICE_ROLE_KEY`) معرّفة في ملف `.env`
- يجب أن يكون الملف JSON موجوداً في المسار المحدد
- يجب أن تكون المركبات والعملاء موجودين في قاعدة البيانات

## الإحصائيات

بعد انتهاء السكربت، ستحصل على تقرير شامل يتضمن:
- إجمالي السجلات المعالجة
- عدد المركبات الموجودة وغير الموجودة
- عدد العملاء الموجودين وغير الموجودين
- عدد العقود المحدثة والمنشأة
- قائمة بالأخطاء إن وجدت

## ملاحظات مهمة

1. **المركبات غير الموجودة**: إذا لم يتم العثور على المركبة، سيتم تخطي السجل
2. **العملاء غير الموجودين**: إذا لم يتم العثور على العميل، سيتم تخطي السجل
3. **التواريخ غير الصالحة**: إذا كان تاريخ بداية العقد غير صالح، سيتم تخطي السجل
4. **قيمة القسط**: يجب أن تكون قيمة القسط رقماً صالحاً أكبر من صفر

## الأمان

- السكربت يستخدم `SUPABASE_SERVICE_ROLE_KEY` الذي لديه صلاحيات كاملة
- يجب التأكد من عدم مشاركة مفاتيح API بشكل علني
- يُنصح بعمل نسخة احتياطية من قاعدة البيانات قبل التشغيل

