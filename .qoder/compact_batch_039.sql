DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '7035' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97477909052' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'MOJEEB AMIN', '97477909052', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'MOJEEB AMIN', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024142' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '7035', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '557098' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97430532292' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'ANOUER MATHLOUTHI', '97430532292', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'ANOUER MATHLOUTHI', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO202425' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '557098', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '751340' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = 'nan' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'MOHAMED KAMEL OSMAN ABDALLA', 'nan', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'MOHAMED KAMEL OSMAN ABDALLA', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024260' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '751340', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '10666' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97433211272' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'snoonu snoonu', '97433211272', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'snoonu snoonu', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'Ret-2018188' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '10666', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '7057' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97470882208' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'بسام فتحي اللوز', '97470882208', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'بسام فتحي اللوز', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'AGR-302522-016' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '7057', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '5888' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97477024940' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'atef sghairi', '97477024940', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'atef sghairi', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024177' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '5888', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '2775' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97451476442' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'أنور جنبيني', '97451476442', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'أنور جنبيني', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'AGR-202504-404457' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '2775', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '7041' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97431492385' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'abdul basit khan', '97431492385', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'abdul basit khan', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'MR202471' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '7041', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '21860' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97433333971' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'saeed al-hebabi', '97433333971', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'saeed al-hebabi', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024281' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '21860', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '10672' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97477179042' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'ganga chaudhary', '97477179042', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'ganga chaudhary', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024255' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '10672', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

SELECT COUNT(*) as processed FROM contracts WHERE company_id = '24bc0b21-4e2d-4413-9842-31719a3669f4' AND status = 'cancelled' AND vehicle_id IS NOT NULL;