DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '856589' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97455133110' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'sabri mbarki', '97455133110', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'sabri mbarki', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024295' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '856589', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '2778' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '33721869' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'يوسف سقام', '33721869', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'يوسف سقام', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'AGR-202504-397268' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '2778', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '10668' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97470184904' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'عبد المنعم', '97470184904', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'عبد المنعم', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'AGR-202504-400949' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '10668', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '5897' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97433079976' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'ABDALLA ABDALLA', '97433079976', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'ABDALLA ABDALLA', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024135' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '5897', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '7063' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97466230309' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'hakim kouas', '97466230309', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'hakim kouas', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024334' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '7063', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '10858' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97455984233' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'DEO SSENYANJA', '97455984233', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'DEO SSENYANJA', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'MR2024123' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '10858', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '2770' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97455039533' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'tarek boutemedjet', '97455039533', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'tarek boutemedjet', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024327' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '2770', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '2783' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97477710585' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'ABDELLATIF ELHADAD', '97477710585', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'ABDELLATIF ELHADAD', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024258' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '2783', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '7058' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97455146823' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'MOHAMED CHOUCHENE', '97455146823', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'MOHAMED CHOUCHENE', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = '319' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '7058', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '648144' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97470715743' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'muhammad mahmood', '97470715743', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'muhammad mahmood', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024269' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '648144', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

SELECT COUNT(*) as processed FROM contracts WHERE company_id = '24bc0b21-4e2d-4413-9842-31719a3669f4' AND status = 'cancelled' AND vehicle_id IS NOT NULL;