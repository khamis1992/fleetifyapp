DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '570468' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97471108770' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'abdelkader abdelkader', '97471108770', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'abdelkader abdelkader', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'MR202463' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '570468', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '646507' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97433211272' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'snoonu snoonu', '97433211272', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'snoonu snoonu', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'Ret-2018213' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '646507', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '7041' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97455304449' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'mohamed ahmed', '97455304449', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'mohamed ahmed', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024305' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '7041', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '739649' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '70598989' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'abduaziz almhauod', '70598989', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'abduaziz almhauod', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'Ret-201896' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '739649', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '11473' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97433211272' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'snoonu snoonu', '97433211272', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'snoonu snoonu', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'Ret-2018212' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '11473', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '7072' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97433211272' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'snoonu snoonu', '97433211272', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'snoonu snoonu', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'Ret-2018196' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '7072', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '10665' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97477013644' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'AHMED EDRISS', '97477013644', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'AHMED EDRISS', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024273' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '10665', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '2774' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97466521616' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'هاني براهمي', '97466521616', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'هاني براهمي', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'AGR-202504-410464' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '2774', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '7075' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97450446192' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'Mohammad Haitham ettahar elhaddi mohamad', '97450446192', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'Mohammad Haitham ettahar elhaddi mohamad', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO202418' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '7075', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '2776' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97455339605' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'Salih abdullah mohamed Ahmad', '97455339605', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'Salih abdullah mohamed Ahmad', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO202446' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '2776', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

SELECT COUNT(*) as processed FROM contracts WHERE company_id = '24bc0b21-4e2d-4413-9842-31719a3669f4' AND status = 'cancelled' AND vehicle_id IS NOT NULL;