DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '5891' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97471503673' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'موسى حيمر', '97471503673', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'موسى حيمر', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'AGR-202504-418432' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '5891', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '9999' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97433781937' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'mohamed elnakhli', '97433781937', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'mohamed elnakhli', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024243' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '9999', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '7039' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97439989880' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'abrar zaib', '97439989880', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'abrar zaib', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'MR202468' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '7039', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '722134' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97430059056' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'mouheb ouni', '97430059056', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'mouheb ouni', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO202492' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '722134', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '857051' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97430586471' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'CHIHEB HEDHLI', '97430586471', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'CHIHEB HEDHLI', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024285' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '857051', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '2774' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97451076544' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'saber dhibi', '97451076544', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'saber dhibi', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024293' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '2774', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '2779' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97466230309' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'ahmed abdalla mahmoud abdalla mahmoud abdalla', '97466230309', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'ahmed abdalla mahmoud abdalla mahmoud abdalla', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024338' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '2779', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '9891' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97455984233' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'DEO SSENYANJA', '97455984233', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'DEO SSENYANJA', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024118' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '9891', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '7065' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '9745578515' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'azhari hakim khalid hakim', '9745578515', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'azhari hakim khalid hakim', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024342' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '7065', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

DO $$ DECLARE v_company_id UUID := '24bc0b21-4e2d-4413-9842-31719a3669f4'; v_vehicle_id UUID; v_customer_id UUID; v_contract_id UUID; BEGIN SELECT id INTO v_vehicle_id FROM vehicles WHERE plate_number = '548682' AND company_id = v_company_id LIMIT 1; IF v_vehicle_id IS NULL THEN RETURN; END IF; SELECT id INTO v_customer_id FROM customers WHERE phone = '97466104053' AND company_id = v_company_id LIMIT 1; IF v_customer_id IS NULL THEN WITH next_code AS (SELECT COALESCE(MAX(CAST(SUBSTRING(customer_code FROM 'IND-25-([0-9]+)') AS INTEGER)), 0) + 1 as code FROM customers WHERE company_id = v_company_id AND customer_code LIKE 'IND-25-%') INSERT INTO customers (company_id, customer_type, first_name, phone, customer_code, created_at, updated_at) SELECT v_company_id, 'individual', 'salah masaad', '97466104053', 'IND-25-' || LPAD(code::TEXT, 4, '0'), NOW(), NOW() FROM next_code RETURNING id INTO v_customer_id; ELSE UPDATE customers SET first_name = 'salah masaad', updated_at = NOW() WHERE id = v_customer_id; END IF; SELECT id INTO v_contract_id FROM contracts WHERE contract_number = 'LTO2024147' AND company_id = v_company_id AND status = 'cancelled' LIMIT 1; IF v_contract_id IS NOT NULL THEN UPDATE contracts SET vehicle_id = v_vehicle_id, customer_id = v_customer_id, license_plate = '548682', updated_at = NOW() WHERE id = v_contract_id; UPDATE vehicles SET status = 'available', updated_at = NOW() WHERE id = v_vehicle_id AND status != 'rented'; END IF; END $$;

SELECT COUNT(*) as processed FROM contracts WHERE company_id = '24bc0b21-4e2d-4413-9842-31719a3669f4' AND status = 'cancelled' AND vehicle_id IS NOT NULL;