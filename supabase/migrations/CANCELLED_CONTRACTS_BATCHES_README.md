# Cancelled Contracts Migration - Batched Execution

## Problem

The original migration `20251025200000_link_all_cancelled_from_file.sql` was timing out because it tried to process 392 cancelled contracts in a single transaction with multiple database lookups per contract.

**Error:**
```
Error: SQL query ran into an upstream timeout
```

## Solution

Split the migration into **8 smaller batches** of ~50 contracts each. Each batch runs independently and should complete in under 10 seconds.

## Batch Files

| File | Contracts | Range |
|------|-----------|-------|
| `2025102520000001_link_cancelled_batch_1.sql` | 50 | 1-50 |
| `2025102520000002_link_cancelled_batch_2.sql` | 50 | 51-100 |
| `2025102520000003_link_cancelled_batch_3.sql` | 50 | 101-150 |
| `2025102520000004_link_cancelled_batch_4.sql` | 50 | 151-200 |
| `2025102520000005_link_cancelled_batch_5.sql` | 50 | 201-250 |
| `2025102520000006_link_cancelled_batch_6.sql` | 50 | 251-300 |
| `2025102520000007_link_cancelled_batch_7.sql` | 50 | 301-350 |
| `2025102520000008_link_cancelled_batch_8.sql` | 42 | 351-392 |

**Total:** 392 contracts across 8 batches

## How to Run

### Option 1: Automatic (Recommended)

Run all batches automatically in sequence:

```bash
node scripts/run-cancelled-contracts-batches.cjs
```

This will:
- Run each batch in order
- Show progress for each batch
- Stop if any batch fails
- Display summary at the end

### Option 2: Manual (One at a Time)

Run each batch individually:

```bash
npx supabase db execute --file supabase/migrations/2025102520000001_link_cancelled_batch_1.sql
npx supabase db execute --file supabase/migrations/2025102520000002_link_cancelled_batch_2.sql
npx supabase db execute --file supabase/migrations/2025102520000003_link_cancelled_batch_3.sql
npx supabase db execute --file supabase/migrations/2025102520000004_link_cancelled_batch_4.sql
npx supabase db execute --file supabase/migrations/2025102520000005_link_cancelled_batch_5.sql
npx supabase db execute --file supabase/migrations/2025102520000006_link_cancelled_batch_6.sql
npx supabase db execute --file supabase/migrations/2025102520000007_link_cancelled_batch_7.sql
npx supabase db execute --file supabase/migrations/2025102520000008_link_cancelled_batch_8.sql
```

## What Each Batch Does

Each batch migration:

1. **Finds the vehicle** by plate number
   - Skips if vehicle not found

2. **Finds or creates the customer** by phone number
   - Creates new customer with auto-incrementing code `IND-25-XXXX`
   - Updates existing customer name if found
   - Handles duplicate phone numbers gracefully

3. **Links the contract**
   - Updates contract with `vehicle_id` and `customer_id`
   - Updates `license_plate` field
   - Only processes contracts with status `cancelled` or `under_review`

4. **Updates vehicle status**
   - Sets vehicle status to `available` (if not currently rented)

5. **Provides detailed logging**
   - Shows progress for each contract
   - Reports created/updated/skipped counts
   - Clear success/error messages

## Expected Output

Each batch will output:

```
Processing batch X/8 (50 contracts)...
✅ Created customer: John Doe (Phone: 97412345678)
✅ Linked contract: LTO2024139 → Vehicle: xxx-xxx → Customer: yyy-yyy
...
========== Batch X/8 Complete ==========
Contracts Updated: 48
Customers Created: 12
Customers Updated: 36
Skipped (no vehicle): 2
Skipped (no contract): 0
======================================
```

## Verification

After running all batches, verify the results:

```sql
-- Count successfully linked contracts
SELECT COUNT(*) FROM contracts
WHERE vehicle_id IS NOT NULL
AND customer_id IS NOT NULL
AND status IN ('cancelled', 'under_review');

-- Count newly created customers
SELECT COUNT(*) FROM customers
WHERE customer_code LIKE 'IND-25-%'
AND created_at > NOW() - INTERVAL '1 hour';

-- Check for any remaining unlinked cancelled contracts
SELECT COUNT(*) FROM contracts
WHERE (vehicle_id IS NULL OR customer_id IS NULL)
AND status IN ('cancelled', 'under_review');
```

## Troubleshooting

### If a batch fails:

1. **Check the error message** - it will show which contract failed
2. **Fix the data issue** (missing vehicle, invalid phone, etc.)
3. **Re-run the failed batch** - it's safe to run multiple times
4. **Continue with remaining batches**

### Safe to Re-run

All batches are **idempotent** - safe to run multiple times:
- Won't create duplicate customers (checks phone first)
- Won't overwrite correct data
- Only updates contracts that need linking

## Files

- **Split script:** `scripts/split-migration.cjs`
- **Run script:** `scripts/run-cancelled-contracts-batches.cjs`
- **Original migration:** `20251025200000_link_all_cancelled_from_file.sql` (archived)
- **Batch migrations:** `2025102520000001_link_cancelled_batch_*.sql` (8 files)

## Generated By

- Script: `scripts/split-migration.cjs`
- Date: 2025-10-25
- Total contracts: 392
- Batch size: 50
- Total batches: 8
