# ุชุญููู ูุธุงู ุงูููุงุชูุฑ ููุนููู 6b8e3932-6dc2-48b4-a607-a6b73de78b5d

## ๐ ุงูุจูุงูุงุช ุงููุนููุฉ

### ููุฎุต ุงูููุงุชูุฑ:
- **ุฅุฌูุงูู ุงูููุงุชูุฑ**: 49 ูุงุชูุฑุฉ
- **ุนุฏุฏ ุงูุนููุฏ**: 2 ุนูุฏ
- **ุฃูู ูุงุชูุฑุฉ**: 2024-01-01
- **ุขุฎุฑ ูุงุชูุฑุฉ**: 2026-02-01

### ุชูุงุตูู ุงูุนููุฏ:

#### ุงูุนูุฏ ุงูุฃูู: CNT-25-0466 (ููุบู)
- **ุชุงุฑูุฎ ุงูุจุฏุก**: 2024-01-28
- **ุชุงุฑูุฎ ุงูุงูุชูุงุก**: 2025-01-29
- **ุงูุญุงูุฉ**: ููุบู (cancelled)
- **ุงูุฅูุฌุงุฑ ุงูุดูุฑู**: 2,550 ุฑูุงู
- **ุงููุฏุฉ ุงููุนููุฉ**: ุณูุฉ ูุงุญุฏุฉ (12 ุดูุฑ)
- **ุงูููุงุชูุฑ ุงููุนููุฉ**: 23 ูุงุชูุฑุฉ โ๏ธ

#### ุงูุนูุฏ ุงูุซุงูู: C-ALF-0061 (ูุดุท)
- **ุชุงุฑูุฎ ุงูุจุฏุก**: 2024-01-29
- **ุชุงุฑูุฎ ุงูุงูุชูุงุก**: 2026-12-31
- **ุงูุญุงูุฉ**: ูุดุท (active)
- **ุงูุฅูุฌุงุฑ ุงูุดูุฑู**: 2,550 ุฑูุงู
- **ุงููุฏุฉ ุญุชู ุงูุขู**: 12 ุดูุฑ
- **ุงูููุงุชูุฑ ุงููุนููุฉ**: 26 ูุงุชูุฑุฉ โ๏ธ

### ุฃููุงุน ุงูููุงุชูุฑ:
- **sales**: 48 ูุงุชูุฑุฉ (122,400 ุฑูุงู)
- **service**: 1 ูุงุชูุฑุฉ (2,550 ุฑูุงู)

---

## ๐ ุงููุธุงู ุงููุนุชูุฏ ูุฅูุดุงุก ุงูููุงุชูุฑ

### ุงูููุงุนุฏ ุงูุตุญูุญุฉ:

#### 1. **ูุงุชูุฑุฉ ูุงุญุฏุฉ ููู ุนูุฏ ูู ูู ุดูุฑ**
```
ุงูุนูุฏ ูุจุฏุฃ ูู: 28 ููุงูุฑ 2024
ุฃูู ูุงุชูุฑุฉ: 1 ูุจุฑุงูุฑ 2024
ุงูููุงุชูุฑ ุงูุชุงููุฉ: 1 ูุงุฑุณุ 1 ุฃุจุฑููุ ... ุฅูุฎ
```

#### 2. **ุชูููุช ุฅูุดุงุก ุงูููุงุชูุฑ**
- โ ุชููุดุฃ ุงููุงุชูุฑุฉ ูู ุงูููู ุงูุฃูู ูู ุงูุดูุฑ ุงูุชุงูู ูุจุฏุก ุงูุนูุฏ
- โ `invoice_date` = ุฃูู ููู ูู ุงูุดูุฑ
- โ `due_date` = ุฃูู ููู ูู ุงูุดูุฑ (ููุณ ุงูุชุงุฑูุฎ)
- โ ูุซุงู: ุนูุฏ ูุจุฏุฃ ูู 28 ููุงูุฑ โ ุฃูู ูุงุชูุฑุฉ ูู 1 ูุจุฑุงูุฑ

#### 3. **ููุน ุงูุชูุฑุงุฑ**
- ููุฌุฏ trigger ุงุณูู `check_duplicate_monthly_invoice`
- ูููุน ุฅูุดุงุก ูุงุชูุฑุชูู ูููุณ ุงูุนูุฏ ูู ููุณ ุงูุดูุฑ
- ูุชุญูู ูู `due_date` ุฃู `invoice_date` ูุชุญุฏูุฏ ุงูุดูุฑ

#### 4. **ุงูุฏุงูุฉ ุงููุณุชุฎุฏูุฉ**
```sql
-- ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ูุฅูุดุงุก ุงูููุงุชูุฑ
backfill_contract_invoices(p_company_id, p_contract_id)

-- ููููุฉ ุนูููุง:
1. ุชุจุฏุฃ ูู ุงูุดูุฑ ุงูุชุงูู ูุชุงุฑูุฎ ุจุฏุก ุงูุนูุฏ
2. ุชูุดุฆ ูุงุชูุฑุฉ ูุงุญุฏุฉ ููู ุดูุฑ ุญุชู ุงูููู
3. ุชุชุฎุทู ุงูููุงุชูุฑ ุงูููุฌูุฏุฉ (ูุง ุชูุฑุฑ)
4. ุชุชููู ุนูุฏ ุชุงุฑูุฎ ุงูุชูุงุก ุงูุนูุฏ (ุฅู ููุฌุฏ)
```

---

## ๐ ุชุญููู ุงููุดููุฉ

### ุงูุนูุฏ ุงูุฃูู (CNT-25-0466):
- **ุงููุฏุฉ ุงููุนููุฉ**: 12 ุดูุฑ (ูู ููุงูุฑ 2024 ุฅูู ููุงูุฑ 2025)
- **ุงูููุงุชูุฑ ุงููุชููุนุฉ**: 12 ูุงุชูุฑุฉ (ูุจุฑุงูุฑ 2024 - ููุงูุฑ 2025)
- **ุงูููุงุชูุฑ ุงููุนููุฉ**: 23 ูุงุชูุฑุฉ โ๏ธ
- **ุงููุฑู**: +11 ูุงุชูุฑุฉ ุฒูุงุฏุฉ (ุชูุฑูุจุงู ุถุนู ุงูุนุฏุฏ!)

### ุงูุนูุฏ ุงูุซุงูู (C-ALF-0061):
- **ุงููุฏุฉ ุญุชู ุงูุขู**: 12 ุดูุฑ (ูู ููุงูุฑ 2024 ุฅูู ููุงูุฑ 2025)
- **ุงูููุงุชูุฑ ุงููุชููุนุฉ**: 13 ูุงุชูุฑุฉ (ูุจุฑุงูุฑ 2024 - ูุจุฑุงูุฑ 2026)
- **ุงูููุงุชูุฑ ุงููุนููุฉ**: 26 ูุงุชูุฑุฉ โ๏ธ
- **ุงููุฑู**: +13 ูุงุชูุฑุฉ ุฒูุงุฏุฉ (ุถุนู ุงูุนุฏุฏ ุชูุฑูุจุงู!)

---

## ๐ฏ ุงูุฃุณุจุงุจ ุงููุญุชููุฉ

### 1. **ุชุดุบูู ุฏุงูุฉ backfill ุนุฏุฉ ูุฑุงุช** โ
ูุจู ุฅุถุงูุฉ trigger ููุน ุงูุชูุฑุงุฑุ ูุงู ูู ุงููููู ุชุดุบูู ุงูุฏุงูุฉ ูุฑุชูู:
```sql
-- ุงููุฑุฉ ุงูุฃููู: ุฃูุดุฃุช 12 ูุงุชูุฑุฉ
SELECT * FROM backfill_contract_invoices('company_id');

-- ุงููุฑุฉ ุงูุซุงููุฉ: ุฃูุดุฃุช 12 ูุงุชูุฑุฉ ุฃุฎุฑู (ูุจู ูุฌูุฏ ุงูู trigger)
SELECT * FROM backfill_contract_invoices('company_id');

-- ุงููุชูุฌุฉ: 24 ูุงุชูุฑุฉ ุจุฏูุงู ูู 12!
```

### 2. **ููุงุชูุฑ ูู ูุตุงุฏุฑ ูุชุนุฏุฏุฉ** โ๏ธ
ุงููุธุงู ูููู ุฃู ููุดุฆ ููุงุชูุฑ ูู:
- โ ุงูุฏุงูุฉ ุงูุชููุงุฆูุฉ ุงูุดูุฑูุฉ
- โ ุนูุฏ ุฑุจุท ูุฏููุนุฉ ุจุนูุฏ (`createInvoiceForPayment`)
- โ ูู ุฅูุตุงูุงุช ุงูุฅูุฌุงุฑ (`rental_payment_receipts`)
- โ ุนูุฏ ุฅูุดุงุก ุงูุนูุฏ (ููุงุชูุฑ ูุณุจูุฉ)

### 3. **ููุงุชูุฑ ูุจู ุชุงุฑูุฎ ุจุฏุก ุงูุนูุฏ** ๐ด
ูุงุญุธ: ุฃูู ูุงุชูุฑุฉ ูู **2024-01-01** ููู ุงูุนูุฏ ุจุฏุฃ ูู **2024-01-28/29**!
- ูุฐุง ุฎุทุฃ! ูุฌุจ ุฃู ุชุจุฏุฃ ุงูููุงุชูุฑ ูู **2024-02-01**

---

## โ ุงูุญู ุงูููุชุฑุญ

### ุงูุฎุทูุฉ 1: ุงูุชุญูู ูู ุงูููุงุชูุฑ ุงูููุฑุฑุฉ
```sql
-- ุนุฑุถ ุฌููุน ุงูููุงุชูุฑ ููุฐุง ุงูุนููู ูุน ุชูุงุตูููุง
SELECT 
    i.id,
    i.invoice_number,
    i.invoice_type,
    i.invoice_date,
    i.due_date,
    DATE_TRUNC('month', COALESCE(i.due_date, i.invoice_date))::DATE as invoice_month,
    i.total_amount,
    i.payment_status,
    c.contract_number,
    i.created_at
FROM invoices i
JOIN contracts c ON c.id = i.contract_id
WHERE i.customer_id = '6b8e3932-6dc2-48b4-a607-a6b73de78b5d'
  AND i.status != 'cancelled'
ORDER BY c.contract_number, invoice_month, i.created_at;
```

### ุงูุฎุทูุฉ 2: ุญุฐู ุงูููุงุชูุฑ ุงูููุฑุฑุฉ
```sql
-- ุงุณุชุฎุฏุงู ุฏุงูุฉ ุงูุชูุธูู ุงูููุฌูุฏุฉ
-- ุชุญุชูุธ ุจุฃูุฏู ูุงุชูุฑุฉ ูุชุญุฐู ุงูุจุงูู
SELECT * FROM fix_duplicate_payment_invoices();
```

### ุงูุฎุทูุฉ 3: ุญุฐู ุงูููุงุชูุฑ ูุจู ุชุงุฑูุฎ ุจุฏุก ุงูุนูุฏ
```sql
-- ุญุฐู ุงูููุงุชูุฑ ุงูุชู ุชู ุฅูุดุงุคูุง ูุจู ุจุฏุก ุงูุนูุฏ
DELETE FROM invoices i
USING contracts c
WHERE i.contract_id = c.id
  AND i.customer_id = '6b8e3932-6dc2-48b4-a607-a6b73de78b5d'
  AND COALESCE(i.due_date, i.invoice_date) < DATE_TRUNC('month', c.start_date + INTERVAL '1 month')::DATE
  AND i.status != 'cancelled';
```

### ุงูุฎุทูุฉ 4: ุงูุชุญูู ูู ุงููุชูุฌุฉ
```sql
-- ุงูุชุญูู ูู ุนุฏุฏ ุงูููุงุชูุฑ ุจุนุฏ ุงูุชูุธูู
SELECT 
    c.contract_number,
    c.start_date,
    c.end_date,
    COUNT(i.id) as invoice_count,
    EXTRACT(MONTH FROM AGE(COALESCE(c.end_date, CURRENT_DATE), c.start_date))::INTEGER + 1 as expected_count
FROM contracts c
LEFT JOIN invoices i ON i.contract_id = c.id AND i.status != 'cancelled'
WHERE c.customer_id = '6b8e3932-6dc2-48b4-a607-a6b73de78b5d'
GROUP BY c.id, c.contract_number, c.start_date, c.end_date;
```

---

## ๐ ููุงุนุฏ ุงููุธุงู ุงูุตุญูุญุฉ

### โ ุงููุงุนุฏุฉ 1: ูุงุชูุฑุฉ ูุงุญุฏุฉ ุดูุฑูุงู
```
ุงูุนูุฏ: ููุงูุฑ 2024 - ุฏูุณูุจุฑ 2025 (24 ุดูุฑ)
ุงูููุงุชูุฑ ุงููุชููุนุฉ: 24 ูุงุชูุฑุฉ
ุงูุชูุฒูุน: ูุงุชูุฑุฉ ูุงุญุฏุฉ ูู ุงูููู ุงูุฃูู ูู ูู ุดูุฑ
```

### โ ุงููุงุนุฏุฉ 2: ุงูุจุฏุก ูู ุงูุดูุฑ ุงูุชุงูู
```
ุชุงุฑูุฎ ุจุฏุก ุงูุนูุฏ: 28 ููุงูุฑ 2024
ุฃูู ูุงุชูุฑุฉ: 1 ูุจุฑุงูุฑ 2024 (ูููุณ 1 ููุงูุฑ!)
```

### โ ุงููุงุนุฏุฉ 3: ุงูุงูุชูุงุก ุนูุฏ ููุงูุฉ ุงูุนูุฏ
```
ุชุงุฑูุฎ ุงูุชูุงุก ุงูุนูุฏ: 29 ููุงูุฑ 2025
ุขุฎุฑ ูุงุชูุฑุฉ: 1 ููุงูุฑ 2025
ูุง ุชูุฌุฏ ููุงุชูุฑ ุจุนุฏ ุงูุชูุงุก ุงูุนูุฏ
```

### โ ุงููุงุนุฏุฉ 4: ููุน ุงููุงุชูุฑุฉ
```
invoice_type: 'service' (ููุฅูุฌุงุฑ ุงูุดูุฑู)
invoice_date: ุฃูู ููู ูู ุงูุดูุฑ
due_date: ุฃูู ููู ูู ุงูุดูุฑ
status: 'sent'
payment_status: 'unpaid'
```

---

## ๐จ ุงููุดุงูู ุงูููุชุดูุฉ

### 1. ููุงุชูุฑ ูุจู ุจุฏุก ุงูุนูุฏ
- โ ุชูุฌุฏ ูุงุชูุฑุฉ ุจุชุงุฑูุฎ 2024-01-01
- โ ูุฌุจ ุฃู ุชุจุฏุฃ ูู 2024-02-01

### 2. ุนุฏุฏ ุงูููุงุชูุฑ ุฃูุซุฑ ูู ุงููุชููุน
- ุงูุนูุฏ ุงูุฃูู: 23 ูุงุชูุฑุฉ ุจุฏูุงู ูู 12
- ุงูุนูุฏ ุงูุซุงูู: 26 ูุงุชูุฑุฉ ุจุฏูุงู ูู 13
- **ุงูุณุจุจ ุงููุญุชูู**: ุชุดุบูู ุฏุงูุฉ backfill ูุฑุชูู ูุจู ุฅุถุงูุฉ ุงูู trigger

### 3. ููุน ุงูููุงุชูุฑ ูุฎุชูู
- โ ูุนุธู ุงูููุงุชูุฑ ูู ููุน "sales" (48 ูุงุชูุฑุฉ)
- โ ูุฌุจ ุฃู ุชููู ูู ููุน "service" (ููุฅูุฌุงุฑ)
- ููุท 1 ูุงุชูุฑุฉ ูู ููุน "service"

---

## ๐ก ุงูุชูุตูุงุช

### ููุนููู ุงูุญุงูู:
1. โ **ูุง ุชูุฌุฏ ููุงุชูุฑ ููุฑุฑุฉ** (ูู ููุณ ุงูุดูุฑ)
2. โ๏ธ **ููุฌุฏ ููุงุชูุฑ ุฒุงุฆุฏุฉ** (ุถุนู ุงูุนุฏุฏ ุงููุชููุน)
3. โ **ููุน ุงูููุงุชูุฑ ุฎุงุทุฆ** (sales ุจุฏูุงู ูู service)

### ุงูุญู:
1. **ุชุตุญูุญ ููุน ุงูููุงุชูุฑ**:
```sql
UPDATE invoices 
SET invoice_type = 'service'
WHERE customer_id = '6b8e3932-6dc2-48b4-a607-a6b73de78b5d'
  AND invoice_type = 'sales'
  AND contract_id IS NOT NULL;
```

2. **ุญุฐู ุงูููุงุชูุฑ ุงูุฒุงุฆุฏุฉ** (ุงุฎุชูุงุฑู):
   - ุฅุฐุง ูุงูุช ุงูููุงุชูุฑ ูุฏููุนุฉุ ูุง ุชุญุฐููุง
   - ุฅุฐุง ูุงูุช ุบูุฑ ูุฏููุนุฉ ูููุฑุฑุฉุ ูููู ุญุฐููุง

### ูููุธุงู ุจุดูู ุนุงู:
1. โ ุงูู trigger ููุฌูุฏ ุงูุขู ููููุน ุงูุชูุฑุงุฑ
2. โ ุงูุฏุงูุฉ `backfill_contract_invoices` ุชุนูู ุจุดูู ุตุญูุญ
3. โ๏ธ ุชุฃูุฏ ูู ุนุฏู ุชุดุบูู ุงูุฏุงูุฉ ุนุฏุฉ ูุฑุงุช
4. โ๏ธ ุงุณุชุฎุฏู `invoice_type = 'service'` ููุฅูุฌุงุฑ ุงูุดูุฑู

---

## ๐ ุงูุฎูุงุตุฉ

### ุงููุธุงู ุงููุนุชูุฏ:
- **ูุงุชูุฑุฉ ูุงุญุฏุฉ ุดูุฑูุงู** ููู ุนูุฏ
- ุชุจุฏุฃ ูู **ุงูุดูุฑ ุงูุชุงูู** ูุชุงุฑูุฎ ุจุฏุก ุงูุนูุฏ
- **ุงูููู ุงูุฃูู** ูู ูู ุดูุฑ
- ููุน ุงููุงุชูุฑุฉ: **service** (ูููุณ sales)

### ุณุจุจ ูุซุฑุฉ ุงูููุงุชูุฑ:
1. ุชุดุบูู ุฏุงูุฉ backfill ูุฑุชูู (ูุจู ูุฌูุฏ ุงูู trigger)
2. ุงุณุชุฎุฏุงู ููุน ูุงุชูุฑุฉ ุฎุงุทุฆ (sales ุจุฏูุงู ูู service)
3. ุฅูุดุงุก ููุงุชูุฑ ูุจู ุชุงุฑูุฎ ุจุฏุก ุงูุนูุฏ

### ุงููุถุน ุงูุญุงูู:
- โ ูุง ุชูุฌุฏ ููุงุชูุฑ ููุฑุฑุฉ ูู ููุณ ุงูุดูุฑ
- โ๏ธ ููุฌุฏ ููุงุชูุฑ ุฒุงุฆุฏุฉ (ุถุนู ุงูุนุฏุฏ)
- โ ููุน ุงูููุงุชูุฑ ุฎุงุทุฆ

**ุงููุธุงู ุงูุขู ูุญูู ุถุฏ ุงูุชูุฑุงุฑ** ุจูุถู ุงูู triggerุ ููู ุงูุจูุงูุงุช ุงููุฏููุฉ ุชุญุชุงุฌ ุชูุธูู.
