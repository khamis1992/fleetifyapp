# ุฅุตูุงุญ ูุดููุฉ ุชูููุฏ ุงูููุงุชูุฑ ููุนููุฏ ุงูููุบุงุฉ

## ุงููุดููุฉ
ุงููุธุงู ูุณุชูุฑ ูู ุฅูุดุงุก ููุงุชูุฑ ุดูุฑูุฉ ููุนููุฏ ุงูููุบุงุฉ ุชููุงุฆูุงู!

## ุงูุณุจุจ
ูู ููู `supabase/functions/generate-monthly-invoices/index.ts`:
- ุงูุณุทุฑ 46: ุงูุฏุงูุฉ ุชุจุญุซ ููุท ุนู ุงูุนููุฏ ุจุญุงูุฉ `active`
- ููููุง **ูุง ุชุณุชุซูู ุงูุนููุฏ ุงูููุบุงุฉ (cancelled)** ุจุดูู ุตุฑูุญ
- ุงููุดููุฉ: ูุฏ ุชููู ุจุนุถ ุงูุนููุฏ ููุง `status = 'active'` ููููุง ูู ุงููุงูุน ููุบุงุฉ

## ุงูุญู

### 1. ุชุญุฏูุซ ุฏุงูุฉ ุชูููุฏ ุงูููุงุชูุฑ ุงูุดูุฑูุฉ
- [x] ุฅุถุงูุฉ ุดุฑุท ุตุฑูุญ ูุงุณุชุซูุงุก ุงูุนููุฏ ุงูููุบุงุฉ (`.neq("status", "cancelled")`)
- [x] ุงูุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ููุงุชูุฑ ููุนููุฏ ุจุญุงูุฉ `cancelled`

### 2. ุฅุถุงูุฉ ูุญุต ุฅุถุงูู ูุจู ุฅูุดุงุก ุงููุงุชูุฑุฉ
- [x] ุงูุชุญูู ูู ุญุงูุฉ ุงูุนูุฏ ูุฑุฉ ุฃุฎุฑู ูุจู ุฅูุดุงุก ุงููุงุชูุฑุฉ
- [x] ุฅุถุงูุฉ log ููุนููุฏ ุงูููุบุงุฉ ุงูุชู ุชู ุชุฎุทููุง

### 3. ุฅูุบุงุก ุงูููุงุชูุฑ ุงููุณุชูุจููุฉ ููุนููุฏ ุงูููุบุงุฉ
- [x] ุนูุฏ ุฅูุบุงุก ุนูุฏุ ูุชู ุฅูุบุงุก ุฌููุน ุงูููุงุชูุฑ ุงููุณุชูุจููุฉ ุบูุฑ ุงููุฏููุนุฉ ุชููุงุฆูุงู

## ุงููููุงุช ุงููุทููุจ ุชุนุฏูููุง
1. `supabase/functions/generate-monthly-invoices/index.ts`
2. `src/services/repositories/ContractRepository.ts` (ุนูุฏ ุฅูุบุงุก ุงูุนูุฏ)

---

## ๐ ูุฑุงุฌุนุฉ ุงูุชุบููุฑุงุช

### โ ูุง ุชู ุฅูุฌุงุฒู

#### 1. ุฅุตูุงุญ ุฏุงูุฉ ุชูููุฏ ุงูููุงุชูุฑ ุงูุดูุฑูุฉ
**ุงูููู:** `supabase/functions/generate-monthly-invoices/index.ts`

**ุงูุชุบููุฑุงุช:**
- โ ุฅุถุงูุฉ ุดุฑุท `.neq("status", "cancelled")` ูู ุงุณุชุนูุงู ุงูุนููุฏ
- โ ุฅุถุงูุฉ ูุญุต ุฅุถุงูู ุฏุงุฎู ุงูุญููุฉ ูุชุฎุทู ุงูุนููุฏ ุงูููุบุงุฉ
- โ ุฅุถุงูุฉ log ูุงุถุญ ุนูุฏ ุชุฎุทู ุนูุฏ ููุบู

**ูุจู:**
```typescript
.eq("status", "active")
.gte("end_date", now.toISOString().split("T")[0]);
```

**ุจุนุฏ:**
```typescript
.eq("status", "active")
.neq("status", "cancelled") // ุงุณุชุซูุงุก ุงูุนููุฏ ุงูููุบุงุฉ ุจุดูู ุตุฑูุญ
.gte("end_date", now.toISOString().split("T")[0]);
```

#### 2. ุชุญุณูู ููุทู ุฅูุบุงุก ุงูุนูุฏ
**ุงูููู:** `src/services/repositories/ContractRepository.ts`

**ุงูุชุบููุฑุงุช:**
- โ ุชุญุฏูุซ ุฏุงูุฉ `updateStatus()` ูุฅูุบุงุก ุงูููุงุชูุฑ ุงููุณุชูุจููุฉ
- โ ุฅูุบุงุก ุงูููุงุชูุฑ ุจุฏูุงู ูู ุญุฐููุง (ููุญูุงุธ ุนูู ุงูุณุฌู)
- โ ุฅุถุงูุฉ ููุงุญุธุฉ ุชูุถุญ ุณุจุจ ุงูุฅูุบุงุก
- โ ุงุณุชูุฏุงู ุงูููุงุชูุฑ ุงููุณุชูุจููุฉ ููุท (`.gte('due_date', today)`)
- โ ุงุณุชูุฏุงู ุงูููุงุชูุฑ ุบูุฑ ุงููุฏููุนุฉ ููุท

**ุงูููุทู ุงูุฌุฏูุฏ:**
```typescript
if (status === 'cancelled') {
  // ุฅูุบุงุก ุฌููุน ุงูููุงุชูุฑ ุงููุณุชูุจููุฉ ุบูุฑ ุงููุฏููุนุฉ
  await supabase
    .from('invoices')
    .update({ 
      status: 'cancelled',
      payment_status: 'cancelled',
      notes: 'ุชู ุฅูุบุงุก ุงููุงุชูุฑุฉ ุจุณุจุจ ุฅูุบุงุก ุงูุนูุฏ'
    })
    .eq('contract_id', id)
    .gte('due_date', today) // ุงููุณุชูุจููุฉ ููุท
    .in('payment_status', ['unpaid', 'pending', 'sent']); // ุบูุฑ ุงููุฏููุนุฉ ููุท
}
```

### ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

#### ุงูุญูุงูุฉ ุนูู ูุณุชูููู:

**1. ูุณุชูู ุชูููุฏ ุงูููุงุชูุฑ (Edge Function):**
- โ ูู ูุชู ุชูููุฏ ููุงุชูุฑ ุฌุฏูุฏุฉ ููุนููุฏ ุงูููุบุงุฉ
- โ ูุญุต ูุฒุฏูุฌ: ูู ุงูุงุณุชุนูุงู + ุฏุงุฎู ุงูุญููุฉ
- โ ุชุณุฌูู ูุงุถุญ ููุนููุฏ ุงููุชุฎุทุงุฉ

**2. ูุณุชูู ุฅูุบุงุก ุงูุนูุฏ (Repository):**
- โ ุนูุฏ ุฅูุบุงุก ุนูุฏุ ูุชู ุฅูุบุงุก ุฌููุน ููุงุชูุฑู ุงููุณุชูุจููุฉ ุชููุงุฆูุงู
- โ ุงูุญูุงุธ ุนูู ุงูููุงุชูุฑ ุงููุฏููุฉ ุงููุฏููุนุฉ
- โ ุฅุถุงูุฉ ููุงุญุธุฉ ุชูุถูุญูุฉ ููู ูุงุชูุฑุฉ ููุบุงุฉ

### โจ ุงููุฒุงูุง

- โ **ููุน ุชูููุฏ ููุงุชูุฑ ุฌุฏูุฏุฉ** ููุนููุฏ ุงูููุบุงุฉ
- โ **ุฅูุบุงุก ุชููุงุฆู** ููููุงุชูุฑ ุงููุณุชูุจููุฉ ุนูุฏ ุฅูุบุงุก ุงูุนูุฏ
- โ **ุงูุญูุงุธ ุนูู ุงูุณุฌู** - ุฅูุบุงุก ุจุฏูุงู ูู ุญุฐู
- โ **ุญูุงูุฉ ูุฒุฏูุฌุฉ** - ูุญุต ูู ููุงููู ูุฎุชูููู
- โ **ูุถูุญ ูู ุงูุชุณุฌูู** - logs ูุงุถุญุฉ ูุชุชุจุน ุงููุดููุฉ

### ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูููุงุชูุฑ ุงููุฏููุฉ ุงููุฏููุนุฉ:** ูู ูุชู ุงููุณุงุณ ุจูุง (ููุญูุงุธ ุนูู ุงูุณุฌู ุงููุงูู)
2. **ุงูููุงุชูุฑ ุงููุณุชูุจููุฉ:** ุณูุชู ุฅูุบุงุคูุง ุชููุงุฆูุงู ุนูุฏ ุฅูุบุงุก ุงูุนูุฏ
3. **ุงูููุงุชูุฑ ุงูุญุงููุฉ ุบูุฑ ุงููุฏููุนุฉ:** ุณูุชู ุฅูุบุงุคูุง ุฃูุถุงู
4. **Edge Function:** ูุฌุจ ุฅุนุงุฏุฉ ูุดุฑูุง ุนูู Supabase ูุชูุนูู ุงูุชุบููุฑุงุช
