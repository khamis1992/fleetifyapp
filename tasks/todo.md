# خطة إصلاح نظام Fleetify - بناءً على الفحص الفني

## الهدف
إصلاح المشاكل المالية في نظام Fleetify وتفعيل جميع الميزات المحاسبية

## معايير القبول
- [ ] صفحة المدفوعات تعمل بدون أخطاء
- [ ] التقارير المالية تعرض أرقاماً حقيقية (ليست أصفاراً)
- [ ] القيود المحاسبية التلقائية تعمل عند إنشاء عقود
- [ ] أخطاء API (400 & 406) تم حلها أو تقليلها بشكل كبير
- [ ] دليل الحسابات مُعد بشكل صحيح

## النطاق وتقدير التأثير
الملفات المتوقع تعديلها:
- supabase/migrations/*.sql (RLS Policies)
- src/pages/finance/*.tsx (لا تحتاج تعديل - تعمل بشكل صحيح)
- إضافة SQL scripts للتهيئة الأولية

خارج النطاق:
- إعادة كتابة المكونات (غير مطلوب - الكود سليم)
- تغيير بنية قاعدة البيانات الأساسية

## المخاطر والتخفيف
| المخاطر | التخفيف |
|---------|---------|
| حذف بيانات موجودة | Backup كامل قبل البدء |
| تعطيل الوصول للمستخدمين | تنفيذ في وقت خارج ساعات العمل |
| مشاكل في RLS Policies | اختبار على staging أولاً |
| فقدان القيود المحاسبية | Dry run للسكريبتات |

## الخطوات

### المرحلة الأولى: Pre-flight Safety Checks ✅
- [ ] عمل Full Backup لقاعدة البيانات
- [ ] التأكد من عمل typecheck و lint
- [ ] فحص environment variables
- [ ] التحقق من staging environment

### المرحلة الثانية: التشخيص والتحقق (1-2 ساعة)
- [ ] تنفيذ SQL diagnosis script للتحقق من:
  - [ ] عدد الحسابات في chart_of_accounts
  - [ ] القيود الموجودة في journal_entries
  - [ ] ربط الحسابات في companies table
  - [ ] RLS Policies الحالية
- [ ] تحديد company_id الصحيح للعمل عليه
- [ ] فحص permissions للمستخدم الحالي
- [ ] تسجيل النتائج في ملف diagnosis_results.md

### المرحلة الثالثة: إصلاح RLS Policies (2-3 ساعات)
- [ ] مراجعة جميع Policies لجدول payments
- [ ] إصلاح Policy للـ SELECT
- [ ] إصلاح Policy للـ INSERT
- [ ] إصلاح Policy للـ UPDATE
- [ ] إصلاح Policy للـ DELETE
- [ ] اختبار كل Policy على حدة
- [ ] توثيق التغييرات

### المرحلة الرابعة: إعداد النظام المحاسبي (3-4 ساعات)
- [ ] إنشاء SQL script لإعداد دليل الحسابات الأساسي
- [ ] إضافة الحسابات الأساسية:
  - [ ] 1211 - الذمم المدينة
  - [ ] 4111 - إيرادات التأجير
  - [ ] 1111 - النقدية
  - [ ] 1121 - البنك
  - [ ] 2111 - الذمم الدائنة
- [ ] ربط الحسابات في companies table
- [ ] إنشاء cost centers أساسية
- [ ] اختبار الربط

### المرحلة الخامسة: الأرصدة الافتتاحية (1-2 ساعة)
- [ ] إنشاء قيد افتتاحي (Opening Entry)
- [ ] إدخال الأرصدة لحسابات الأصول
- [ ] إدخال الأرصدة لحسابات الخصوم
- [ ] إدخال الأرصدة لحسابات حقوق الملكية
- [ ] التحقق من توازن القيد (Debit = Credit)
- [ ] تحديث current_balance للحسابات

### المرحلة السادسة: اختبار القيود التلقائية (2-3 ساعات)
- [ ] إنشاء عقد تجريبي
- [ ] التحقق من إنشاء قيد محاسبي تلقائياً
- [ ] فحص journal_entries table
- [ ] فحص journal_entry_lines table
- [ ] التحقق من تحديث current_balance
- [ ] اختبار إلغاء عقد وحذف القيد
- [ ] توثيق السلوك

### المرحلة السابعة: إصلاح أخطاء API (2-4 ساعات)
- [ ] تفعيل detailed logging في الـ browser
- [ ] تحديد جميع الطلبات الفاشلة (400 & 406)
- [ ] تحليل كل خطأ على حدة
- [ ] إصلاح الأخطاء المتعلقة بـ RLS
- [ ] إصلاح الأخطاء المتعلقة بـ Validation
- [ ] إصلاح الأخطاء المتعلقة بـ Headers
- [ ] إعادة الاختبار للتأكد من الإصلاح

### المرحلة الثامنة: اختبار شامل (3-4 ساعات)
- [ ] اختبار صفحة المدفوعات
  - [ ] عرض قائمة المدفوعات
  - [ ] إنشاء دفعة جديدة
  - [ ] تعديل دفعة موجودة
  - [ ] حذف دفعة
- [ ] اختبار صفحة التحليل المالي
  - [ ] التحقق من الأرقام
  - [ ] اختبار الرسوم البيانية
  - [ ] اختبار النسب المالية
- [ ] اختبار صفحة التقارير
  - [ ] الميزانية العمومية
  - [ ] قائمة الدخل
  - [ ] تقرير التدفقات النقدية
  - [ ] تصدير PDF/Excel
- [ ] اختبار صفحة تتبع المدفوعات
- [ ] اختبار E2E للـ workflow الكامل

### المرحلة التاسعة: التوثيق والمراجعة (1-2 ساعة)
- [ ] تحديث SYSTEM_REFERENCE.md
- [ ] توثيق الحسابات الافتراضية
- [ ] توثيق عملية Setup للمستخدمين الجدد
- [ ] إنشاء Troubleshooting Guide
- [ ] كتابة Release Notes
- [ ] تحديث ملف README

### المرحلة العاشرة: Deployment (1 ساعة)
- [ ] مراجعة جميع التغييرات
- [ ] تنفيذ migrations على staging
- [ ] اختبار على staging
- [ ] إنشاء Rollback Plan
- [ ] تنفيذ migrations على production
- [ ] مراقبة Errors في الساعة الأولى
- [ ] إعلام الفريق بالنشر

## Notes
- الكود المصدري للواجهة سليم ولا يحتاج تعديلات كبيرة
- المشكلة الأساسية هي في إعداد البيانات وليس في الكود
- RLS Policies قد تحتاج مراجعة شاملة
- يُفضل تنفيذ كل مرحلة واختبارها قبل الانتقال للتالية

## Rollback Plan
في حالة وجود مشاكل:
1. استرجاع Backup قاعدة البيانات
2. إعادة deploy الإصدار السابق
3. إعلام الفريق والمستخدمين

## Success Metrics
- عدد أخطاء API < 5 في الجلسة الواحدة
- جميع التقارير تعرض أرقاماً صحيحة
- 100% من العقود الجديدة تنشئ قيود محاسبية
- User satisfaction > 8/10

---

## Review (سيتم تحديثها بعد الانتهاء)

### What Shipped
(سيتم إضافتها)

### Known Limitations
(سيتم إضافتها)

### Follow-ups
(سيتم إضافتها)
