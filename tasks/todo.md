# مهمة إصلاح مشكلة الفواتير المتكررة

## تحليل المشكلة

### جذور المشكلة:
1. **تعدد مصادر إنشاء الفواتير** - يوجد عدة أنظمة تنشئ فواتير:
   - `generate_invoice_for_contract_month` (SQL function)
   - `useAutomaticInvoiceGenerator.ts` (React hook)
   - `ContractInvoiceGenerator.tsx` (UI component)
   - `ContractInvoiceDialog.tsx` (UI dialog)
   - Edge functions

2. **فشل التحقق من وجود فاتورة سابقة** - دالة SQL تتحقق من `due_date` و `invoice_date` لكن:
   - لا تمنع الكود في Frontend من إنشاء فواتير
   - لا يوجد constraint على مستوى قاعدة البيانات

3. **أرقام فواتير مختلفة لنفس الشهر** - مثال:
   - `INV-C-ALF-0035-2024-12` (sent)
   - `INV-LTO2024340-202412-001` (draft)
   - نفس العقد، نفس الشهر

### الإحصائيات:
- **506 فاتورة مكررة** بحالة draft
- بعض العقود لها **3+ فواتير** لنفس الشهر

---

## خطة الحل

- [x] 1. تحليل جذور مشكلة الفواتير المتكررة
- [ ] 2. حذف الفواتير المتكررة (draft + غير المدفوعة)
- [ ] 3. إضافة UNIQUE INDEX لمنع التكرار المستقبلي
- [ ] 4. تحسين دالة التحقق من وجود فاتورة

---

## التفاصيل الفنية

### الفواتير التي سيتم الاحتفاظ بها:
- الفاتورة الأقدم أو التي حالتها (paid, sent, pending, overdue)
- إذا كان هناك عدة فواتير بنفس الحالة، نحتفظ بالأقدم

### الفواتير التي سيتم حذفها:
- الفواتير بحالة draft
- الفواتير المكررة الأحدث

---

## المراجعة

_(سيتم إضافتها بعد الانتهاء)_
