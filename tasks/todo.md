# مشكلة عرض حالة الفواتير في قائمة التحصيل الشهري

## المشكلة الأصلية
العميل **رافي** يظهر في قائمة التحصيل الشهري بأن لديه فواتير "غير مدفوع"، لكن عند الدخول إلى صفحة الدفع السريع لا تظهر أي فواتير.

## المشكلة الحقيقية ✅
الفواتير **مدفوعة** في قاعدة البيانات لكن تظهر **"غير مدفوع"** في الواجهة!

## التحليل

### بيانات العميل
- **ID**: `831a1b5b-af2e-4f16-bd18-4a72e95fe950`
- **الاسم**: رافي
- **الهاتف**: 33336834
- **عدد العقود**: 3 عقود نشطة
  - LTO2024104 (معين لأسامة)
  - LTO2024105 (معين لطارق البوزيدي)
  - LTO2024106 (معين لطارق البوزيدي)

### تحليل الفواتير
✅ **في قائمة التحصيل الشهري**: تظهر 31 فاتورة للعقد LTO2024104
❌ **في صفحة الدفع السريع**: لا تظهر أي فواتير

### السبب الجذري ✅

المشكلة في `useMonthlyCollections.ts` السطر **107**:

```typescript
if (inv.status === 'paid') status = 'paid';  // ❌ خطأ!
```

**الخطأ**: الكود يفحص `inv.status` (حالة الفاتورة) بدلاً من `inv.payment_status` (حالة الدفع)!

**البيانات الفعلية**:
- `payment_status = 'paid'` ✅ (مدفوعة)
- `status = 'overdue'` (كانت متأخرة لكن تم دفعها)

**النتيجة**: الكود يعتبرها غير مدفوعة ويعرض "غير مدفوع" في الواجهة!

### لماذا تظهر في قائمة التحصيل الشهري؟

في `useMonthlyCollections.ts` السطر **92**:
```typescript
.neq('status', 'cancelled')
```

يجلب **جميع** الفواتير (المدفوعة وغير المدفوعة) ثم يفلترها لاحقاً في السطر **130**:
```typescript
if (item.status !== 'paid') return true; // يعرض غير المدفوعة
// ويعرض المدفوعة فقط إذا كانت من هذا الشهر
```

## الحل ✅

تم إصلاح مشكلتين في `useMonthlyCollections.ts`:

### 1. إصلاح تحديد حالة الدفع (السطر 107)

**قبل الإصلاح** ❌:
```typescript
if (inv.status === 'paid') status = 'paid';
```

**بعد الإصلاح** ✅:
```typescript
if (inv.payment_status === 'paid') status = 'paid';
```

### 2. إخفاء الفواتير المدفوعة (السطر 124-137)

**قبل الإصلاح** ❌:
```typescript
.filter(item => {
  if (item.status !== 'paid') return true;
  // يعرض الفواتير المدفوعة من هذا الشهر
  return dueDate >= startOfCurrentMonth && dueDate <= endOfCurrentMonth;
});
```

**بعد الإصلاح** ✅:
```typescript
.filter(item => {
  // عرض فقط الفواتير غير المدفوعة
  return item.status !== 'paid';
});
```

## النتيجة

الآن قائمة التحصيل الشهري تعرض **فقط الفواتير غير المدفوعة**:
- ✅ الفواتير غير المدفوعة تظهر مع زر "تسجيل دفعة"
- ✅ الفواتير المدفوعة **لا تظهر** (تم إخفاؤها)
- ✅ الإحصائيات تحسب بشكل صحيح

## التأثير

هذا الإصلاح يحسّن:
1. ✅ قائمة التحصيل الشهري تركز على ما يحتاج متابعة فقط
2. ✅ تقليل الفوضى في الواجهة
3. ✅ تحسين تجربة الموظف (يرى فقط ما يحتاج عمل)
