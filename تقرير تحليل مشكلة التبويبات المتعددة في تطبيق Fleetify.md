# ุชูุฑูุฑ ุชุญููู ูุดููุฉ ุงูุชุจููุจุงุช ุงููุชุนุฏุฏุฉ ูู ุชุทุจูู Fleetify

## ููุฎุต ุงููุดููุฉ

ุนูุฏ ูุชุญ ุงูุชุทุจูู ูู ุชุจููุจุฉ ุฌุฏูุฏุฉ (New Tab) ุฃุซูุงุก ูุฌูุฏ ุชุจููุจุฉ ุฃุฎุฑู ููุชูุญุฉุ ูุญุฏุซ ุฎุทุฃ ูููุน ุงูุชุตูุญ ูู ุงูุชุจููุจุฉ ุงูุฌุฏูุฏุฉ. ุงููุณุชุฎุฏู ูุถุทุฑ ูุฅุบูุงู ุงูุชุจููุจุฉ ุงูุฃููู ุญุชู ูุชููู ูู ุงูุชุตูุญ ูู ุงูุชุจููุจุฉ ุงูุฌุฏูุฏุฉ.

---

## ุงูุณุจุจ ุงูุฌุฐุฑู ูููุดููุฉ

ุจุนุฏ ุชุญููู ุงูููุฏุ ุชู ุชุญุฏูุฏ **ุซูุงุซุฉ ุฃุณุจุงุจ ุฑุฆูุณูุฉ** ูููุดููุฉ:

### 1. **ุชุนุงุฑุถ ูู React Query Client**

ูู ููู `src/App.tsx` (ุงูุณุทูุฑ 103-154):

```typescript
const createQueryClient = () => {
  return new QueryClient({
    defaultOptions: {
      queries: {
        refetchOnMount: true,
        refetchOnWindowFocus: false,
        refetchOnReconnect: true,
        staleTime: 5 * 60 * 1000, // 5 ุฏูุงุฆู
        gcTime: 15 * 60 * 1000, // 15 ุฏูููุฉ
        networkMode: 'always',
        // ...
      },
    },
  });
};

const App: React.FC = () => {
  const queryClient = useMemo(() => createQueryClient(), []);
  // ...
};
```

**ุงููุดููุฉ:**
- ูู ุชุจููุจุฉ ุชูุดุฆ ูุณุฎุฉ ุฌุฏูุฏุฉ ูู `QueryClient`
- ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ (`staleTime: 5 ุฏูุงุฆู`, `gcTime: 15 ุฏูููุฉ`) ุชุฌุนู ุงูุจูุงูุงุช ุชุจูู ูู ุงูุฐุงูุฑุฉ ููุชุฑุฉ ุทูููุฉ
- ุนูุฏ ูุชุญ ุชุจููุจุฉ ุฌุฏูุฏุฉุ ูุญุฏุซ **ุชุนุงุฑุถ ูู ุงููุตูู ุฅูู ุงูุจูุงูุงุช ุงููุฎุฒูุฉ ูุคูุชุงู**
- `networkMode: 'always'` ูุฌุจุฑ ุงูุชุทุจูู ุนูู ูุญุงููุฉ ุฌูุจ ุงูุจูุงูุงุช ุญุชู ูู ูุงูุช ูุชููุฑุฉ ูู ุชุจููุจุฉ ุฃุฎุฑู

### 2. **ุนุฏู ูุฌูุฏ ุขููุฉ ููุชูุงุตู ุจูู ุงูุชุจููุจุงุช**

ุจุนุฏ ุงูุจุญุซ ูู ุงูููุฏ:
- **ูุง ููุฌุฏ ุงุณุชุฎุฏุงู ูู `BroadcastChannel API`** ููุชูุงุตู ุจูู ุงูุชุจููุจุงุช
- **ูุง ููุฌุฏ ุงุณุชุฎุฏุงู ูู `SharedWorker`** ููุดุงุฑูุฉ ุงูุญุงูุฉ
- **ูุง ููุฌุฏ ุงุณุชุฎุฏุงู ูู `storage` events** ูููุฒุงููุฉ

**ุงููุชูุฌุฉ:**
- ูู ุชุจููุจุฉ ุชุนูู ุจุดูู ูุณุชูู ุชูุงูุงู
- ูุง ุชูุฌุฏ ุขููุฉ ูุชูุณูู ุงููุตูู ุฅูู ุงูููุงุฑุฏ ุงููุดุชุฑูุฉ
- ุนูุฏ ูุญุงููุฉ ุงูุชุจููุจุชูู ุงููุตูู ุฅูู ููุณ ุงูุจูุงูุงุชุ ูุญุฏุซ ุชุนุงุฑุถ

### 3. **ูุดููุฉ ูู ุฅุฏุงุฑุฉ ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ (Cache)**

ูู ููู `src/utils/cacheUtils.ts` (ุงูุณุทูุฑ 10-19):

```typescript
// Global query client instance
let queryClientInstance: QueryClient | null = null;

export const setQueryClient = (client: QueryClient) => {
  queryClientInstance = client;
};

export const getQueryClient = (): QueryClient | null => {
  return queryClientInstance;
};
```

**ุงููุดููุฉ:**
- ูุชู ุงุณุชุฎุฏุงู **ูุชุบูุฑ ุนุงู (Global Variable)** ูุชุฎุฒูู `QueryClient`
- ุนูุฏ ูุชุญ ุชุจููุจุฉ ุฌุฏูุฏุฉุ ูุชู **ุงุณุชุจุฏุงู** `queryClientInstance` ุจูุณุฎุฉ ุฌุฏูุฏุฉ
- ูุฐุง ูุณุจุจ **ููุฏุงู ุงููุฑุฌุน** ููู `QueryClient` ูู ุงูุชุจููุจุฉ ุงูุฃููู
- ุงููุชูุฌุฉ: **ุชุนุงุฑุถ ูู ุงูุญุงูุฉ** ุจูู ุงูุชุจููุจุงุช

---

## ุงูุชุฃุซูุฑ ุนูู ุงูุชุทุจูู

### ุงูุณููู ุงูุญุงูู:
1. **ุงูุชุจููุจุฉ ุงูุฃููู** ุชุนูู ุจุดูู ุทุจูุนู
2. ุนูุฏ ูุชุญ **ุงูุชุจููุจุฉ ุงูุซุงููุฉ**:
   - ูุชู ุฅูุดุงุก `QueryClient` ุฌุฏูุฏ
   - ูุชู ุงุณุชุจุฏุงู `queryClientInstance` ุงูุนุงู
   - ุงูุชุจููุจุฉ ุงูุฃููู ุชููุฏ ุงูุงุชุตุงู ุจู `QueryClient` ุงูุฎุงุต ุจูุง
   - ุงูุชุจููุจุฉ ุงูุซุงููุฉ ุชุญุงูู ุงููุตูู ุฅูู ููุณ ุงูุจูุงูุงุช
   - ูุญุฏุซ **ุชุนุงุฑู (Race Condition)** ูู ุงููุตูู ุฅูู ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ
3. **ุงููุชูุฌุฉ:** ุงูุชุจููุจุฉ ุงูุซุงููุฉ ุชุชุฌูุฏ ุฃู ุชุนุฑุถ ุฃุฎุทุงุก

### ุงูุฃุฎุทุงุก ุงููุชููุนุฉ:
- `Cannot read properties of null` ูู React Query
- `Network request failed` ุจุณุจุจ ุชุนุงุฑุถ ุงูุทูุจุงุช
- `Infinite loading` ุจุณุจุจ ุนุฏู ุงููุฏุฑุฉ ุนูู ุฌูุจ ุงูุจูุงูุงุช
- `Context errors` ุจุณุจุจ ููุฏุงู ุงููุฑุฌุน ููู Context Providers

---

## ุงูุญููู ุงูููุชุฑุญุฉ

### ุงูุญู 1: ุงุณุชุฎุฏุงู BroadcastChannel API (ุงูุญู ุงูููุตู ุจู)

ุฅุถุงูุฉ ุขููุฉ ููุชูุงุตู ุจูู ุงูุชุจููุจุงุช ุจุงุณุชุฎุฏุงู `BroadcastChannel`:

```typescript
// src/utils/tabSyncManager.ts
const channel = new BroadcastChannel('fleetify-app-sync');

// ูู ุงูุชุจููุจุฉ ุงูุฃููู
channel.postMessage({ type: 'NEW_TAB_OPENED' });

// ูู ุงูุชุจููุจุฉ ุงูุฌุฏูุฏุฉ
channel.addEventListener('message', (event) => {
  if (event.data.type === 'NEW_TAB_OPENED') {
    // ุชูุณูู ุงููุตูู ุฅูู ุงูููุงุฑุฏ
  }
});
```

**ุงููุฒุงูุง:**
- ุชูุงุตู ููุฑู ุจูู ุงูุชุจููุจุงุช
- ูุง ูุชุทูุจ ุชุนุฏููุงุช ูุจูุฑุฉ ูู ุงูููุฏ
- ูุฏุนู ูู ูุจู ุฌููุน ุงููุชุตูุญุงุช ุงูุญุฏูุซุฉ

### ุงูุญู 2: ุชุนุฏูู ุฅุนุฏุงุฏุงุช React Query

ุชุนุฏูู ุงูุฅุนุฏุงุฏุงุช ูุชูููู ุงูุชุนุงุฑุถ:

```typescript
const createQueryClient = () => {
  return new QueryClient({
    defaultOptions: {
      queries: {
        refetchOnMount: 'always', // ุฅุฌุจุงุฑ ุฅุนุงุฏุฉ ุฌูุจ ุงูุจูุงูุงุช
        refetchOnWindowFocus: true, // ุฅุนุงุฏุฉ ุฌูุจ ุนูุฏ ุงูุชุฑููุฒ ุนูู ุงููุงูุฐุฉ
        staleTime: 0, // ุชูููู ููุช ุงูุจูุงุก ูู ุงูุฐุงูุฑุฉ
        gcTime: 5 * 60 * 1000, // ุชูููู ููุช ุงูุชุฎุฒูู ุงููุคูุช
        networkMode: 'online', // ุงุณุชุฎุฏุงู ูุถุน online ุจุฏูุงู ูู always
      },
    },
  });
};
```

**ุงููุฒุงูุง:**
- ุณูู ุงูุชูููุฐ
- ูููู ูู ุงูุชุนุงุฑุถ ุจุดูู ูุจูุฑ

**ุงูุนููุจ:**
- ูุฏ ูุฒูุฏ ูู ุนุฏุฏ ุงูุทูุจุงุช ุฅูู ุงูุฎุงุฏู
- ูุฏ ูุคุซุฑ ุนูู ุงูุฃุฏุงุก ููููุงู

### ุงูุญู 3: ุงุณุชุฎุฏุงู Tab ID ูุชูููุฒ ุงูุชุจููุจุงุช

ุฅุถุงูุฉ ูุนุฑู ูุฑูุฏ ููู ุชุจููุจุฉ:

```typescript
// src/utils/tabManager.ts
const getTabId = () => {
  let tabId = sessionStorage.getItem('tab-id');
  if (!tabId) {
    tabId = `tab-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    sessionStorage.setItem('tab-id', tabId);
  }
  return tabId;
};

// ูู App.tsx
const tabId = getTabId();
const queryClient = useMemo(() => {
  const client = createQueryClient();
  client.setDefaultOptions({
    queries: {
      queryKeyHashFn: (queryKey) => {
        return JSON.stringify([...queryKey, tabId]);
      },
    },
  });
  return client;
}, [tabId]);
```

**ุงููุฒุงูุง:**
- ูู ุชุจููุจุฉ ููุง ุฐุงูุฑุฉ ูุคูุชุฉ ูููุตูุฉ
- ูููุน ุงูุชุนุงุฑุถ ุจุดูู ูุงูู

**ุงูุนููุจ:**
- ูุฒูุฏ ูู ุงุณุชููุงู ุงูุฐุงูุฑุฉ
- ูุฏ ูุชุทูุจ ุชุนุฏููุงุช ูู ุงูููุฏ ุงูุญุงูู

### ุงูุญู 4: ุฅุฒุงูุฉ ุงููุชุบูุฑ ุงูุนุงู ูู cacheUtils

ุชุนุฏูู `src/utils/cacheUtils.ts` ูุงุณุชุฎุฏุงู Context ุจุฏูุงู ูู ุงููุชุบูุฑ ุงูุนุงู:

```typescript
// ุฅุฒุงูุฉ ุงููุชุบูุฑ ุงูุนุงู
// let queryClientInstance: QueryClient | null = null;

// ุงุณุชุฎุฏุงู Context ูููุตูู ุฅูู QueryClient
import { useQueryClient } from '@tanstack/react-query';

export const invalidateQueries = async (queryKeys: string | string[]) => {
  // ุงุณุชุฎุฏุงู useQueryClient() hook ุจุฏูุงู ูู ุงููุชุบูุฑ ุงูุนุงู
  // ูุฌุจ ุงุณุชุฏุนุงุก ูุฐู ุงูุฏุงูุฉ ูู ุฏุงุฎู Component
};
```

**ุงููุฒุงูุง:**
- ูุญู ูุดููุฉ ุงููุชุบูุฑ ุงูุนุงู
- ูุชุจุน ุฃูุถู ุงูููุงุฑุณุงุช ูู React

**ุงูุนููุจ:**
- ูุชุทูุจ ุฅุนุงุฏุฉ ููููุฉ ุจุนุถ ุงูุฏูุงู

---

## ุงูุญู ุงูููุตู ุจู (ุฎุทูุฉ ุจุฎุทูุฉ)

### ุงููุฑุญูุฉ 1: ุฅุถุงูุฉ BroadcastChannel ููุชูุงุตู ุจูู ุงูุชุจููุจุงุช

1. ุฅูุดุงุก ููู `src/utils/tabSyncManager.ts`
2. ุฅุถุงูุฉ ููุทู ูููุดู ุนู ุงูุชุจููุจุงุช ุงูุฌุฏูุฏุฉ
3. ุชูุณูู ุงููุตูู ุฅูู ุงูููุงุฑุฏ ุงููุดุชุฑูุฉ

### ุงููุฑุญูุฉ 2: ุชุนุฏูู ุฅุนุฏุงุฏุงุช React Query

1. ุชูููู `staleTime` ุฅูู `0` ุฃู `1 * 60 * 1000` (ุฏูููุฉ ูุงุญุฏุฉ)
2. ุชูููู `gcTime` ุฅูู `5 * 60 * 1000` (5 ุฏูุงุฆู)
3. ุชุบููุฑ `networkMode` ุฅูู `'online'`
4. ุฅุถุงูุฉ `refetchOnWindowFocus: true`

### ุงููุฑุญูุฉ 3: ุฅุฒุงูุฉ ุงููุชุบูุฑ ุงูุนุงู ูู cacheUtils

1. ุฅุฒุงูุฉ `queryClientInstance` ุงูุนุงู
2. ุงุณุชุฎุฏุงู `useQueryClient()` hook ูู ุฌููุน ุงูุฏูุงู
3. ุชุญููู ุงูุฏูุงู ุฅูู Custom Hooks

### ุงููุฑุญูุฉ 4: ุงูุงุฎุชุจุงุฑ

1. ูุชุญ ุงูุชุทุจูู ูู ุชุจููุจุชูู
2. ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก
3. ุงูุชุญูู ูู ุฅููุงููุฉ ุงูุชุตูุญ ูู ููุง ุงูุชุจููุจุชูู
4. ุงุฎุชุจุงุฑ ุงูุชุฒุงูู ุจูู ุงูุชุจููุจุงุช

---

## ุงูุฎูุงุตุฉ

ุงููุดููุฉ ูุงุชุฌุฉ ุนู **ุชุนุงุฑุถ ูู ุฅุฏุงุฑุฉ ุงูุญุงูุฉ** ุจูู ุงูุชุจููุจุงุช ุงููุชุนุฏุฏุฉุ ุจุณุจุจ:
1. ุนุฏู ูุฌูุฏ ุขููุฉ ููุชูุงุตู ุจูู ุงูุชุจููุจุงุช
2. ุงุณุชุฎุฏุงู ูุชุบูุฑ ุนุงู ูุชุฎุฒูู `QueryClient`
3. ุฅุนุฏุงุฏุงุช React Query ุงูุชู ุชุณุจุจ ุชุนุงุฑู ูู ุงููุตูู ุฅูู ุงูุจูุงูุงุช

**ุงูุญู ุงูุฃูุซู** ูู ุชุทุจูู **ุงูุญููู ุงูุซูุงุซุฉ ุงูุฃููู ูุนุงู** ูุถูุงู ุนูู ุงูุชุทุจูู ุจุดูู ุตุญูุญ ูู ุงูุชุจููุจุงุช ุงููุชุนุฏุฏุฉ.

---

## โ ุชู ุงูุชูููุฐ ุจูุฌุงุญ!

**ุชุงุฑูุฎ ุงูุชูููุฐ:** 29 ููุงูุฑ 2026

### ุงูุญููู ุงููููุฐุฉ:
1. โ **ุงูุญู 1:** ุฅุถุงูุฉ BroadcastChannel API ููุชูุงุตู ุจูู ุงูุชุจููุจุงุช
2. โ **ุงูุญู 2:** ุชุนุฏูู ุฅุนุฏุงุฏุงุช React Query ูุชูููู ุงูุชุนุงุฑุถ
3. โ **ุงูุญู 3:** ุฅุถุงูุฉ Tab ID ูู React Query ูุนุฒู ุงูู cache
4. โ **ุงูุญู 4:** ุฅุฒุงูุฉ ุงููุชุบูุฑ ุงูุนุงู ูู cacheUtils ูุงุณุชุฎุฏุงู WeakMap

### ุงููููุงุช ุงููุนุฏูุฉ:
- โ `src/integrations/supabase/client.ts` - ุชูุนูู ุงููุฒุงููุฉ
- โ `src/contexts/AuthContext.tsx` - Storage listener + Lock + Tab ID
- โ `src/App.tsx` - React Query settings + Tab ID + BroadcastChannel
- โ `src/utils/cacheUtils.ts` - WeakMap + BroadcastChannel integration
- โ `src/utils/tabSyncManager.ts` - **ููู ุฌุฏูุฏ** - BroadcastChannel manager

### ุงููููุงุช ุงูููุฎุตุฉ:
- ๐ `tasks/multi-tab-navigation-implementation-summary.md` - ููุฎุต ุงูุญููู ุงูุฃุณุงุณูุฉ
- ๐ `tasks/multi-tab-complete-solution-summary.md` - ููุฎุต ุดุงูู ูุฌููุน ุงูุญููู
- ๐ `tasks/multi-tab-testing-guide.md` - ุฏููู ุงุฎุชุจุงุฑ ุดุงูู

### ุงููุชูุฌุฉ:
**ุงูุชุทุจูู ุงูุขู ูุฏุนู ุงูุชุจููุจุงุช ุงููุชุนุฏุฏุฉ ุจุดูู ูุงูู ูุน ูุฒุงููุฉ ุชููุงุฆูุฉ ูุฃุฏุงุก ููุชุงุฒ!** ๐

---

## ุงููุฑุงุฌุน ุงูุชูููุฉ

- [React Query - Window Focus Refetching](https://tanstack.com/query/latest/docs/react/guides/window-focus-refetching)
- [BroadcastChannel API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/BroadcastChannel)
- [Managing State Across Browser Tabs](https://web.dev/broadcast-channel/)
- [React Query Best Practices](https://tkdodo.eu/blog/practical-react-query)
